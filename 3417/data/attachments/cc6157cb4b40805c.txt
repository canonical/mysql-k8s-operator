[32mINFO    [0m pytest_operator.plugin:plugin.py:790 Model status:

Model    Controller          Cloud/Region        Version  SLA          Timestamp
testing  concierge-microk8s  microk8s/localhost  3.6.11   unsupported  02:11:59Z

App      Version                  Status  Scale  Charm             Channel      Rev  Address         Exposed  Message
app0     0.0.2                    active      1  mysql-test-app    latest/edge   85  10.152.183.123  no       Last written value=403
app1     0.0.2                    active      1  mysql-test-app    latest/edge   85  10.152.183.150  no       Last written value=468
app2     0.0.2                    active      1  mysql-test-app    latest/edge   85  10.152.183.147  no       Last written value=446
app3     0.0.2                    active      1  mysql-test-app    latest/edge   85  10.152.183.215  no       Last written value=378
app4     0.0.2                    active      1  mysql-test-app    latest/edge   85  10.152.183.231  no       Last written value=379
app5     0.0.2                    active      1  mysql-test-app    latest/edge   85  10.152.183.134  no       Last written value=339
app6     0.0.2                    active      1  mysql-test-app    latest/edge   85  10.152.183.193  no       Last written value=413
mysql    8.0.42-0ubuntu0.22.04.2  active      1  mysql-k8s                        0  10.152.183.161  no       
router0  8.0.42                   active      1  mysql-router-k8s  8.0/edge     851  10.152.183.149  no       
router1  8.0.42                   active      1  mysql-router-k8s  8.0/edge     851  10.152.183.145  no       
router2  8.0.42                   active      1  mysql-router-k8s  8.0/edge     851  10.152.183.133  no       
router3  8.0.42                   active      1  mysql-router-k8s  8.0/edge     851  10.152.183.194  no       
router4  8.0.42                   active      1  mysql-router-k8s  8.0/edge     851  10.152.183.44   no       
router5  8.0.42                   active      1  mysql-router-k8s  8.0/edge     851  10.152.183.198  no       
router6  8.0.42                   active      1  mysql-router-k8s  8.0/edge     851  10.152.183.99   no       

Unit        Workload  Agent  Address       Ports  Message
app0/0*     active    idle   10.1.108.138         Last written value=403
app1/0*     active    idle   10.1.108.139         Last written value=468
app2/0*     active    idle   10.1.108.143         Last written value=446
app3/0*     active    idle   10.1.108.142         Last written value=378
app4/0*     active    idle   10.1.108.144         Last written value=379
app5/0*     active    idle   10.1.108.146         Last written value=339
app6/0*     active    idle   10.1.108.151         Last written value=413
mysql/0*    active    idle   10.1.108.137         Primary
router0/0*  active    idle   10.1.108.140         
router1/0*  active    idle   10.1.108.141         
router2/0*  active    idle   10.1.108.150         
router3/0*  active    idle   10.1.108.149         
router4/0*  active    idle   10.1.108.148         
router5/0*  active    idle   10.1.108.145         
router6/0*  active    idle   10.1.108.147         

[32mINFO    [0m pytest_operator.plugin:plugin.py:796 Juju error logs:

unit-router0-1: 01:58:43 ERROR unit.router0/1.juju-log backend-database:38: common.mysql_shell:Failed to run MySQL Shell script:
import json
import mysqlsh
import traceback

try:
    # Disable wizards in this script, since it will be invoked without --no-wizard
    shell.options.set('useWizards', False)
    import json

    cluster_set = dba.get_cluster_set()
    routers = cluster_set.list_routers()
    # mysqlsh objects are weirdâ€”they quack (i.e. duck typing) like standard Python objects (e.g. list,
    # dict), but do not serialize to JSON correctly.
    # Cast to str & load from JSON str before serializing
    routers = json.loads(str(routers))
    with open("/tmp/mysqlsh_output.json", "w") as file:
        json.dump(routers, file)
except mysqlsh.DBError as exception:
    error = {
        "message": str(exception),
        "code": exception.code,
        "traceback_message": "".join(traceback.format_exception(exception)),
    }
else:
    error = None
with open("/tmp/mysqlsh_error.json", "w") as file:
    json.dump(error, file)

stderr:
Cannot set LC_ALL to locale en_US.UTF-8: No such file or directory
MySQL Error 1040 (HY000): Too many connections

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router0-1/charm/src/rock.py", line 254, in _run_command
    output, _ = process.wait_output()
  File "/var/lib/juju/agents/unit-router0-1/charm/venv/lib/python3.10/site-packages/ops/pebble.py", line 1441, in wait_output
    raise ExecError[AnyStr](self._command, exit_code, out_value, err_value)
ops.pebble.ExecError: non-zero exit code 1 executing ['mysqlsh', '--passwords-from-stdin', '--uri', 'relation-38_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306', '--python', '--file', '/tmp/mysqlsh_script.py'], stdout="\x1b[1mPlease provide the password for 'relation-38_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306': \x1b[0m", stderr='Cannot set LC_ALL to locale en_US.UTF-8: No such file or directory\nMySQL Error 1040 (HY000): Too many connections\n'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router0-1/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 74, in _run_code
    self._container.run_mysql_shell(
  File "/var/lib/juju/agents/unit-router0-1/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router0-1/charm/venv/lib/python3.10/site-packages/common/container.py", line 236, in run_mysql_shell
    return self._run_command(args, timeout=timeout, input=input)
  File "/var/lib/juju/agents/unit-router0-1/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router0-1/charm/src/rock.py", line 256, in _run_command
    raise common.container.CalledProcessError(
common.container.CalledProcessError: Command '['mysqlsh', '--passwords-from-stdin', '--uri', 'relation-38_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306', '--python', '--file', '/tmp/mysqlsh_script.py']' returned non-zero exit status 1.
unit-router0-1: 01:58:43 ERROR unit.router0/1.juju-log backend-database:38: root:Uncaught exception while in charm code:
Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router0-1/charm/src/rock.py", line 254, in _run_command
    output, _ = process.wait_output()
  File "/var/lib/juju/agents/unit-router0-1/charm/venv/lib/python3.10/site-packages/ops/pebble.py", line 1441, in wait_output
    raise ExecError[AnyStr](self._command, exit_code, out_value, err_value)
ops.pebble.ExecError: non-zero exit code 1 executing ['mysqlsh', '--passwords-from-stdin', '--uri', 'relation-38_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306', '--python', '--file', '/tmp/mysqlsh_script.py'], stdout="\x1b[1mPlease provide the password for 'relation-38_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306': \x1b[0m", stderr='Cannot set LC_ALL to locale en_US.UTF-8: No such file or directory\nMySQL Error 1040 (HY000): Too many connections\n'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router0-1/charm/src/charm.py", line 470, in <module>
    ops.main.main(KubernetesRouterCharm)
  File "/var/lib/juju/agents/unit-router0-1/charm/venv/lib/python3.10/site-packages/ops/main.py", line 436, in main
    _emit_charm_event(charm, dispatcher.event_name)
  File "/var/lib/juju/agents/unit-router0-1/charm/venv/lib/python3.10/site-packages/ops/main.py", line 144, in _emit_charm_event
    event_to_emit.emit(*args, **kwargs)
  File "/var/lib/juju/agents/unit-router0-1/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 351, in emit
    framework._emit(event)
  File "/var/lib/juju/agents/unit-router0-1/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 853, in _emit
    self._reemit(event_path)
  File "/var/lib/juju/agents/unit-router0-1/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 942, in _reemit
    custom_handler(event)
  File "/var/lib/juju/agents/unit-router0-1/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router0-1/charm/venv/lib/python3.10/site-packages/common/abstract_charm.py", line 359, in reconcile
    logger.debug(f"{workload_.status=}")
  File "/var/lib/juju/agents/unit-router0-1/charm/venv/lib/python3.10/site-packages/common/workload.py", line 439, in status
    if not self.shell.is_router_in_cluster_set(self._router_id):
  File "/var/lib/juju/agents/unit-router0-1/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 288, in is_router_in_cluster_set
    self._run_code(
  File "/var/lib/juju/agents/unit-router0-1/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 74, in _run_code
    self._container.run_mysql_shell(
  File "/var/lib/juju/agents/unit-router0-1/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router0-1/charm/venv/lib/python3.10/site-packages/common/container.py", line 236, in run_mysql_shell
    return self._run_command(args, timeout=timeout, input=input)
  File "/var/lib/juju/agents/unit-router0-1/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router0-1/charm/src/rock.py", line 256, in _run_command
    raise common.container.CalledProcessError(
common.container.CalledProcessError: Command '['mysqlsh', '--passwords-from-stdin', '--uri', 'relation-38_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306', '--python', '--file', '/tmp/mysqlsh_script.py']' returned non-zero exit status 1.
unit-router6-1: 01:58:43 ERROR unit.router6/1.juju-log backend-database:50: common.workload:Failed to bootstrap router
logged_command=['--bootstrap', 'relation-50_bb5f9e0470b84e:***@mysql-primary.testing.svc.cluster.local.:3306', '--strict', '--force', '--conf-set-option', 'http_server.bind_address=127.0.0.1', '--conf-set-option', 'http_auth_backend:default_auth_backend.backend=file', '--conf-set-option', 'http_auth_backend:default_auth_backend.filename=/etc/mysqlrouter/rest_api_credentials', '--conf-use-gr-notifications', '--conf-set-option', 'metadata_cache:bootstrap.ttl=5', '--conf-set-option', 'destination_status.error_quarantine_threshold=3', '--conf-set-option', 'destination_status.error_quarantine_interval=5']
stderr:
FATAL ERROR ENCOUNTERED, attempting to undo new accounts that were created
- New accounts cleaned up successfully
Error: Account verification failed with error:
  Error connecting to MySQL server at mysql-primary.testing.svc.cluster.local.:3306: Too many connections (1040)

This means that we were unable to log in using the accounts that were created
and run SQL queries that Router needs to run during its operation.
It means this Router instance may be inoperable and user intervention is
required to correct the issue and/or bootstrap again.

See https://dev.mysql.com/doc/mysql-router/8.0/en/ for more information.


unit-router2-0: 01:58:43 ERROR unit.router2/0.juju-log backend-database:42: common.mysql_shell:Failed to run MySQL Shell script:
import json
import mysqlsh
import traceback

try:
    # Disable wizards in this script, since it will be invoked without --no-wizard
    shell.options.set('useWizards', False)
    import json

    cluster_set = dba.get_cluster_set()
    routers = cluster_set.list_routers()
    # mysqlsh objects are weirdâ€”they quack (i.e. duck typing) like standard Python objects (e.g. list,
    # dict), but do not serialize to JSON correctly.
    # Cast to str & load from JSON str before serializing
    routers = json.loads(str(routers))
    with open("/tmp/mysqlsh_output.json", "w") as file:
        json.dump(routers, file)
except mysqlsh.DBError as exception:
    error = {
        "message": str(exception),
        "code": exception.code,
        "traceback_message": "".join(traceback.format_exception(exception)),
    }
else:
    error = None
with open("/tmp/mysqlsh_error.json", "w") as file:
    json.dump(error, file)

stderr:
Cannot set LC_ALL to locale en_US.UTF-8: No such file or directory
MySQL Error 1040 (HY000): Too many connections

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router2-0/charm/src/rock.py", line 254, in _run_command
    output, _ = process.wait_output()
  File "/var/lib/juju/agents/unit-router2-0/charm/venv/lib/python3.10/site-packages/ops/pebble.py", line 1441, in wait_output
    raise ExecError[AnyStr](self._command, exit_code, out_value, err_value)
ops.pebble.ExecError: non-zero exit code 1 executing ['mysqlsh', '--passwords-from-stdin', '--uri', 'relation-42_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306', '--python', '--file', '/tmp/mysqlsh_script.py'], stdout="\x1b[1mPlease provide the password for 'relation-42_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306': \x1b[0m", stderr='Cannot set LC_ALL to locale en_US.UTF-8: No such file or directory\nMySQL Error 1040 (HY000): Too many connections\n'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router2-0/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 74, in _run_code
    self._container.run_mysql_shell(
  File "/var/lib/juju/agents/unit-router2-0/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router2-0/charm/venv/lib/python3.10/site-packages/common/container.py", line 236, in run_mysql_shell
    return self._run_command(args, timeout=timeout, input=input)
  File "/var/lib/juju/agents/unit-router2-0/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router2-0/charm/src/rock.py", line 256, in _run_command
    raise common.container.CalledProcessError(
common.container.CalledProcessError: Command '['mysqlsh', '--passwords-from-stdin', '--uri', 'relation-42_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306', '--python', '--file', '/tmp/mysqlsh_script.py']' returned non-zero exit status 1.
unit-router2-0: 01:58:43 ERROR unit.router2/0.juju-log backend-database:42: root:Uncaught exception while in charm code:
Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router2-0/charm/src/rock.py", line 254, in _run_command
    output, _ = process.wait_output()
  File "/var/lib/juju/agents/unit-router2-0/charm/venv/lib/python3.10/site-packages/ops/pebble.py", line 1441, in wait_output
    raise ExecError[AnyStr](self._command, exit_code, out_value, err_value)
ops.pebble.ExecError: non-zero exit code 1 executing ['mysqlsh', '--passwords-from-stdin', '--uri', 'relation-42_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306', '--python', '--file', '/tmp/mysqlsh_script.py'], stdout="\x1b[1mPlease provide the password for 'relation-42_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306': \x1b[0m", stderr='Cannot set LC_ALL to locale en_US.UTF-8: No such file or directory\nMySQL Error 1040 (HY000): Too many connections\n'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router2-0/charm/src/charm.py", line 470, in <module>
    ops.main.main(KubernetesRouterCharm)
  File "/var/lib/juju/agents/unit-router2-0/charm/venv/lib/python3.10/site-packages/ops/main.py", line 436, in main
    _emit_charm_event(charm, dispatcher.event_name)
  File "/var/lib/juju/agents/unit-router2-0/charm/venv/lib/python3.10/site-packages/ops/main.py", line 144, in _emit_charm_event
    event_to_emit.emit(*args, **kwargs)
  File "/var/lib/juju/agents/unit-router2-0/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 351, in emit
    framework._emit(event)
  File "/var/lib/juju/agents/unit-router2-0/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 853, in _emit
    self._reemit(event_path)
  File "/var/lib/juju/agents/unit-router2-0/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 942, in _reemit
    custom_handler(event)
  File "/var/lib/juju/agents/unit-router2-0/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router2-0/charm/venv/lib/python3.10/site-packages/common/abstract_charm.py", line 360, in reconcile
    if not workload_.status:
  File "/var/lib/juju/agents/unit-router2-0/charm/venv/lib/python3.10/site-packages/common/workload.py", line 439, in status
    if not self.shell.is_router_in_cluster_set(self._router_id):
  File "/var/lib/juju/agents/unit-router2-0/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 288, in is_router_in_cluster_set
    self._run_code(
  File "/var/lib/juju/agents/unit-router2-0/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 74, in _run_code
    self._container.run_mysql_shell(
  File "/var/lib/juju/agents/unit-router2-0/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router2-0/charm/venv/lib/python3.10/site-packages/common/container.py", line 236, in run_mysql_shell
    return self._run_command(args, timeout=timeout, input=input)
  File "/var/lib/juju/agents/unit-router2-0/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router2-0/charm/src/rock.py", line 256, in _run_command
    raise common.container.CalledProcessError(
common.container.CalledProcessError: Command '['mysqlsh', '--passwords-from-stdin', '--uri', 'relation-42_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306', '--python', '--file', '/tmp/mysqlsh_script.py']' returned non-zero exit status 1.
unit-router6-1: 01:58:43 ERROR unit.router6/1.juju-log backend-database:50: root:Uncaught exception while in charm code:
Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router6-1/charm/src/charm.py", line 470, in <module>
    ops.main.main(KubernetesRouterCharm)
  File "/var/lib/juju/agents/unit-router6-1/charm/venv/lib/python3.10/site-packages/ops/main.py", line 436, in main
    _emit_charm_event(charm, dispatcher.event_name)
  File "/var/lib/juju/agents/unit-router6-1/charm/venv/lib/python3.10/site-packages/ops/main.py", line 144, in _emit_charm_event
    event_to_emit.emit(*args, **kwargs)
  File "/var/lib/juju/agents/unit-router6-1/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 351, in emit
    framework._emit(event)
  File "/var/lib/juju/agents/unit-router6-1/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 853, in _emit
    self._reemit(event_path)
  File "/var/lib/juju/agents/unit-router6-1/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 942, in _reemit
    custom_handler(event)
  File "/var/lib/juju/agents/unit-router6-1/charm/venv/lib/python3.10/site-packages/common/_charm_libs/charms/data_platform_libs/v0/data_interfaces.py", line 3141, in _on_relation_changed_event
    getattr(self.on, "database_created").emit(
  File "/var/lib/juju/agents/unit-router6-1/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 351, in emit
    framework._emit(event)
  File "/var/lib/juju/agents/unit-router6-1/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 853, in _emit
    self._reemit(event_path)
  File "/var/lib/juju/agents/unit-router6-1/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 942, in _reemit
    custom_handler(event)
  File "/var/lib/juju/agents/unit-router6-1/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router6-1/charm/venv/lib/python3.10/site-packages/common/abstract_charm.py", line 345, in reconcile
    workload_.reconcile(
  File "/var/lib/juju/agents/unit-router6-1/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router6-1/charm/venv/lib/python3.10/site-packages/common/workload.py", line 424, in reconcile
    self._enable_router(event=event, tls=tls, unit_name=unit_name)
  File "/var/lib/juju/agents/unit-router6-1/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router6-1/charm/venv/lib/python3.10/site-packages/common/workload.py", line 361, in _enable_router
    self._bootstrap_router(event=event, tls=tls)
  File "/var/lib/juju/agents/unit-router6-1/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router6-1/charm/venv/lib/python3.10/site-packages/common/workload.py", line 325, in _bootstrap_router
    raise Exception("Failed to bootstrap router") from None
Exception: Failed to bootstrap router
unit-router3-2: 01:58:43 ERROR unit.router3/2.juju-log backend-database:44: common.mysql_shell:Failed to run MySQL Shell script:
import json
import mysqlsh
import traceback

try:
    # Disable wizards in this script, since it will be invoked without --no-wizard
    shell.options.set('useWizards', False)
    import json

    cluster_set = dba.get_cluster_set()
    routers = cluster_set.list_routers()
    # mysqlsh objects are weirdâ€”they quack (i.e. duck typing) like standard Python objects (e.g. list,
    # dict), but do not serialize to JSON correctly.
    # Cast to str & load from JSON str before serializing
    routers = json.loads(str(routers))
    with open("/tmp/mysqlsh_output.json", "w") as file:
        json.dump(routers, file)
except mysqlsh.DBError as exception:
    error = {
        "message": str(exception),
        "code": exception.code,
        "traceback_message": "".join(traceback.format_exception(exception)),
    }
else:
    error = None
with open("/tmp/mysqlsh_error.json", "w") as file:
    json.dump(error, file)

MySQL client error 1040
MySQL Shell traceback:
Traceback (most recent call last):
  File "<string>", line 10, in <module>
mysqlsh.DBError: MySQL Error (1040): Dba.get_cluster_set: Too many connections

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router3-2/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 99, in _run_code
    raise ShellDBError(**exception)
common.mysql_shell.ShellDBError: MySQL Error (1040): Dba.get_cluster_set: Too many connections
unit-router3-2: 01:58:43 ERROR unit.router3/2.juju-log backend-database:44: root:Uncaught exception while in charm code:
Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router3-2/charm/src/charm.py", line 470, in <module>
    ops.main.main(KubernetesRouterCharm)
  File "/var/lib/juju/agents/unit-router3-2/charm/venv/lib/python3.10/site-packages/ops/main.py", line 436, in main
    _emit_charm_event(charm, dispatcher.event_name)
  File "/var/lib/juju/agents/unit-router3-2/charm/venv/lib/python3.10/site-packages/ops/main.py", line 144, in _emit_charm_event
    event_to_emit.emit(*args, **kwargs)
  File "/var/lib/juju/agents/unit-router3-2/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 351, in emit
    framework._emit(event)
  File "/var/lib/juju/agents/unit-router3-2/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 853, in _emit
    self._reemit(event_path)
  File "/var/lib/juju/agents/unit-router3-2/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 942, in _reemit
    custom_handler(event)
  File "/var/lib/juju/agents/unit-router3-2/charm/venv/lib/python3.10/site-packages/common/_charm_libs/charms/data_platform_libs/v0/data_interfaces.py", line 3141, in _on_relation_changed_event
    getattr(self.on, "database_created").emit(
  File "/var/lib/juju/agents/unit-router3-2/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 351, in emit
    framework._emit(event)
  File "/var/lib/juju/agents/unit-router3-2/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 853, in _emit
    self._reemit(event_path)
  File "/var/lib/juju/agents/unit-router3-2/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 942, in _reemit
    custom_handler(event)
  File "/var/lib/juju/agents/unit-router3-2/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router3-2/charm/venv/lib/python3.10/site-packages/common/abstract_charm.py", line 374, in reconcile
    self.set_status(event=event)
  File "/var/lib/juju/agents/unit-router3-2/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router3-2/charm/venv/lib/python3.10/site-packages/common/abstract_charm.py", line 261, in set_status
    self.unit.status = self._determine_unit_status(event=event)
  File "/var/lib/juju/agents/unit-router3-2/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router3-2/charm/venv/lib/python3.10/site-packages/common/abstract_charm.py", line 242, in _determine_unit_status
    if status := workload_.status:
  File "/var/lib/juju/agents/unit-router3-2/charm/venv/lib/python3.10/site-packages/common/workload.py", line 439, in status
    if not self.shell.is_router_in_cluster_set(self._router_id):
  File "/var/lib/juju/agents/unit-router3-2/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 288, in is_router_in_cluster_set
    self._run_code(
  File "/var/lib/juju/agents/unit-router3-2/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 99, in _run_code
    raise ShellDBError(**exception)
common.mysql_shell.ShellDBError: MySQL Error (1040): Dba.get_cluster_set: Too many connections
unit-router2-0: 01:58:43 ERROR juju.worker.uniter.operation hook "backend-database-relation-changed" (via hook dispatching script: dispatch) failed: exit status 1
unit-router0-1: 01:58:43 ERROR juju.worker.uniter.operation hook "backend-database-relation-changed" (via hook dispatching script: dispatch) failed: exit status 1
unit-router6-1: 01:58:44 ERROR juju.worker.uniter.operation hook "backend-database-relation-changed" (via hook dispatching script: dispatch) failed: exit status 1
unit-router3-2: 01:58:44 ERROR juju.worker.uniter.operation hook "backend-database-relation-changed" (via hook dispatching script: dispatch) failed: exit status 1
unit-router3-0: 01:59:08 ERROR unit.router3/0.juju-log cos:21: common.mysql_shell:Failed to run MySQL Shell script:
import json
import mysqlsh
import traceback

try:
    # Disable wizards in this script, since it will be invoked without --no-wizard
    shell.options.set('useWizards', False)
    import json

    cluster_set = dba.get_cluster_set()
    routers = cluster_set.list_routers()
    # mysqlsh objects are weirdâ€”they quack (i.e. duck typing) like standard Python objects (e.g. list,
    # dict), but do not serialize to JSON correctly.
    # Cast to str & load from JSON str before serializing
    routers = json.loads(str(routers))
    with open("/tmp/mysqlsh_output.json", "w") as file:
        json.dump(routers, file)
except mysqlsh.DBError as exception:
    error = {
        "message": str(exception),
        "code": exception.code,
        "traceback_message": "".join(traceback.format_exception(exception)),
    }
else:
    error = None
with open("/tmp/mysqlsh_error.json", "w") as file:
    json.dump(error, file)

stderr:
Cannot set LC_ALL to locale en_US.UTF-8: No such file or directory
MySQL Error 1040 (HY000): Too many connections

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router3-0/charm/src/rock.py", line 254, in _run_command
    output, _ = process.wait_output()
  File "/var/lib/juju/agents/unit-router3-0/charm/venv/lib/python3.10/site-packages/ops/pebble.py", line 1441, in wait_output
    raise ExecError[AnyStr](self._command, exit_code, out_value, err_value)
ops.pebble.ExecError: non-zero exit code 1 executing ['mysqlsh', '--passwords-from-stdin', '--uri', 'relation-44_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306', '--python', '--file', '/tmp/mysqlsh_script.py'], stdout="\x1b[1mPlease provide the password for 'relation-44_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306': \x1b[0m", stderr='Cannot set LC_ALL to locale en_US.UTF-8: No such file or directory\nMySQL Error 1040 (HY000): Too many connections\n'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router3-0/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 74, in _run_code
    self._container.run_mysql_shell(
  File "/var/lib/juju/agents/unit-router3-0/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router3-0/charm/venv/lib/python3.10/site-packages/common/container.py", line 236, in run_mysql_shell
    return self._run_command(args, timeout=timeout, input=input)
  File "/var/lib/juju/agents/unit-router3-0/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router3-0/charm/src/rock.py", line 256, in _run_command
    raise common.container.CalledProcessError(
common.container.CalledProcessError: Command '['mysqlsh', '--passwords-from-stdin', '--uri', 'relation-44_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306', '--python', '--file', '/tmp/mysqlsh_script.py']' returned non-zero exit status 1.
unit-router3-0: 01:59:08 ERROR unit.router3/0.juju-log cos:21: root:Uncaught exception while in charm code:
Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router3-0/charm/src/rock.py", line 254, in _run_command
    output, _ = process.wait_output()
  File "/var/lib/juju/agents/unit-router3-0/charm/venv/lib/python3.10/site-packages/ops/pebble.py", line 1441, in wait_output
    raise ExecError[AnyStr](self._command, exit_code, out_value, err_value)
ops.pebble.ExecError: non-zero exit code 1 executing ['mysqlsh', '--passwords-from-stdin', '--uri', 'relation-44_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306', '--python', '--file', '/tmp/mysqlsh_script.py'], stdout="\x1b[1mPlease provide the password for 'relation-44_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306': \x1b[0m", stderr='Cannot set LC_ALL to locale en_US.UTF-8: No such file or directory\nMySQL Error 1040 (HY000): Too many connections\n'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router3-0/charm/src/charm.py", line 470, in <module>
    ops.main.main(KubernetesRouterCharm)
  File "/var/lib/juju/agents/unit-router3-0/charm/venv/lib/python3.10/site-packages/ops/main.py", line 436, in main
    _emit_charm_event(charm, dispatcher.event_name)
  File "/var/lib/juju/agents/unit-router3-0/charm/venv/lib/python3.10/site-packages/ops/main.py", line 144, in _emit_charm_event
    event_to_emit.emit(*args, **kwargs)
  File "/var/lib/juju/agents/unit-router3-0/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 351, in emit
    framework._emit(event)
  File "/var/lib/juju/agents/unit-router3-0/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 853, in _emit
    self._reemit(event_path)
  File "/var/lib/juju/agents/unit-router3-0/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 942, in _reemit
    custom_handler(event)
  File "/var/lib/juju/agents/unit-router3-0/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router3-0/charm/venv/lib/python3.10/site-packages/common/abstract_charm.py", line 360, in reconcile
    if not workload_.status:
  File "/var/lib/juju/agents/unit-router3-0/charm/venv/lib/python3.10/site-packages/common/workload.py", line 439, in status
    if not self.shell.is_router_in_cluster_set(self._router_id):
  File "/var/lib/juju/agents/unit-router3-0/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 288, in is_router_in_cluster_set
    self._run_code(
  File "/var/lib/juju/agents/unit-router3-0/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 74, in _run_code
    self._container.run_mysql_shell(
  File "/var/lib/juju/agents/unit-router3-0/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router3-0/charm/venv/lib/python3.10/site-packages/common/container.py", line 236, in run_mysql_shell
    return self._run_command(args, timeout=timeout, input=input)
  File "/var/lib/juju/agents/unit-router3-0/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router3-0/charm/src/rock.py", line 256, in _run_command
    raise common.container.CalledProcessError(
common.container.CalledProcessError: Command '['mysqlsh', '--passwords-from-stdin', '--uri', 'relation-44_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306', '--python', '--file', '/tmp/mysqlsh_script.py']' returned non-zero exit status 1.
unit-router3-0: 01:59:09 ERROR juju.worker.uniter.operation hook "cos-relation-changed" (via hook dispatching script: dispatch) failed: exit status 1
unit-router1-0: 01:59:15 ERROR unit.router1/0.juju-log mysql-router-peers:9: common.mysql_shell:Failed to run MySQL Shell script:
import json
import mysqlsh
import traceback

try:
    # Disable wizards in this script, since it will be invoked without --no-wizard
    shell.options.set('useWizards', False)
    import json

    cluster_set = dba.get_cluster_set()
    routers = cluster_set.list_routers()
    # mysqlsh objects are weirdâ€”they quack (i.e. duck typing) like standard Python objects (e.g. list,
    # dict), but do not serialize to JSON correctly.
    # Cast to str & load from JSON str before serializing
    routers = json.loads(str(routers))
    with open("/tmp/mysqlsh_output.json", "w") as file:
        json.dump(routers, file)
except mysqlsh.DBError as exception:
    error = {
        "message": str(exception),
        "code": exception.code,
        "traceback_message": "".join(traceback.format_exception(exception)),
    }
else:
    error = None
with open("/tmp/mysqlsh_error.json", "w") as file:
    json.dump(error, file)

MySQL client error 1040
MySQL Shell traceback:
Traceback (most recent call last):
  File "<string>", line 10, in <module>
mysqlsh.DBError: MySQL Error (1040): Dba.get_cluster_set: Too many connections

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router1-0/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 99, in _run_code
    raise ShellDBError(**exception)
common.mysql_shell.ShellDBError: MySQL Error (1040): Dba.get_cluster_set: Too many connections
unit-router1-0: 01:59:15 ERROR unit.router1/0.juju-log mysql-router-peers:9: root:Uncaught exception while in charm code:
Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router1-0/charm/src/charm.py", line 470, in <module>
    ops.main.main(KubernetesRouterCharm)
  File "/var/lib/juju/agents/unit-router1-0/charm/venv/lib/python3.10/site-packages/ops/main.py", line 436, in main
    _emit_charm_event(charm, dispatcher.event_name)
  File "/var/lib/juju/agents/unit-router1-0/charm/venv/lib/python3.10/site-packages/ops/main.py", line 144, in _emit_charm_event
    event_to_emit.emit(*args, **kwargs)
  File "/var/lib/juju/agents/unit-router1-0/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 351, in emit
    framework._emit(event)
  File "/var/lib/juju/agents/unit-router1-0/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 853, in _emit
    self._reemit(event_path)
  File "/var/lib/juju/agents/unit-router1-0/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 942, in _reemit
    custom_handler(event)
  File "/var/lib/juju/agents/unit-router1-0/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router1-0/charm/venv/lib/python3.10/site-packages/common/abstract_charm.py", line 360, in reconcile
    if not workload_.status:
  File "/var/lib/juju/agents/unit-router1-0/charm/venv/lib/python3.10/site-packages/common/workload.py", line 439, in status
    if not self.shell.is_router_in_cluster_set(self._router_id):
  File "/var/lib/juju/agents/unit-router1-0/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 288, in is_router_in_cluster_set
    self._run_code(
  File "/var/lib/juju/agents/unit-router1-0/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 99, in _run_code
    raise ShellDBError(**exception)
common.mysql_shell.ShellDBError: MySQL Error (1040): Dba.get_cluster_set: Too many connections
unit-router1-0: 01:59:16 ERROR juju.worker.uniter.operation hook "mysql-router-peers-relation-joined" (via hook dispatching script: dispatch) failed: exit status 1
unit-router2-0: 01:59:32 ERROR unit.router2/0.juju-log cos:16: common.mysql_shell:Failed to run MySQL Shell script:
import json
import mysqlsh
import traceback

try:
    # Disable wizards in this script, since it will be invoked without --no-wizard
    shell.options.set('useWizards', False)
    import json

    cluster_set = dba.get_cluster_set()
    routers = cluster_set.list_routers()
    # mysqlsh objects are weirdâ€”they quack (i.e. duck typing) like standard Python objects (e.g. list,
    # dict), but do not serialize to JSON correctly.
    # Cast to str & load from JSON str before serializing
    routers = json.loads(str(routers))
    with open("/tmp/mysqlsh_output.json", "w") as file:
        json.dump(routers, file)
except mysqlsh.DBError as exception:
    error = {
        "message": str(exception),
        "code": exception.code,
        "traceback_message": "".join(traceback.format_exception(exception)),
    }
else:
    error = None
with open("/tmp/mysqlsh_error.json", "w") as file:
    json.dump(error, file)

MySQL client error 1040
MySQL Shell traceback:
Traceback (most recent call last):
  File "<string>", line 10, in <module>
mysqlsh.DBError: MySQL Error (1040): Dba.get_cluster_set: Too many connections

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router2-0/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 99, in _run_code
    raise ShellDBError(**exception)
common.mysql_shell.ShellDBError: MySQL Error (1040): Dba.get_cluster_set: Too many connections
unit-router2-0: 01:59:32 ERROR unit.router2/0.juju-log cos:16: root:Uncaught exception while in charm code:
Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router2-0/charm/src/charm.py", line 470, in <module>
    ops.main.main(KubernetesRouterCharm)
  File "/var/lib/juju/agents/unit-router2-0/charm/venv/lib/python3.10/site-packages/ops/main.py", line 436, in main
    _emit_charm_event(charm, dispatcher.event_name)
  File "/var/lib/juju/agents/unit-router2-0/charm/venv/lib/python3.10/site-packages/ops/main.py", line 144, in _emit_charm_event
    event_to_emit.emit(*args, **kwargs)
  File "/var/lib/juju/agents/unit-router2-0/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 351, in emit
    framework._emit(event)
  File "/var/lib/juju/agents/unit-router2-0/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 853, in _emit
    self._reemit(event_path)
  File "/var/lib/juju/agents/unit-router2-0/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 942, in _reemit
    custom_handler(event)
  File "/var/lib/juju/agents/unit-router2-0/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router2-0/charm/venv/lib/python3.10/site-packages/common/abstract_charm.py", line 359, in reconcile
    logger.debug(f"{workload_.status=}")
  File "/var/lib/juju/agents/unit-router2-0/charm/venv/lib/python3.10/site-packages/common/workload.py", line 439, in status
    if not self.shell.is_router_in_cluster_set(self._router_id):
  File "/var/lib/juju/agents/unit-router2-0/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 288, in is_router_in_cluster_set
    self._run_code(
  File "/var/lib/juju/agents/unit-router2-0/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 99, in _run_code
    raise ShellDBError(**exception)
common.mysql_shell.ShellDBError: MySQL Error (1040): Dba.get_cluster_set: Too many connections
unit-router2-0: 01:59:32 ERROR juju.worker.uniter.operation hook "cos-relation-joined" (via hook dispatching script: dispatch) failed: exit status 1
unit-router6-1: 01:59:57 ERROR unit.router6/1.juju-log backend-database:50: common.mysql_shell:Failed to run MySQL Shell script:
import json
import mysqlsh
import traceback

try:
    # Disable wizards in this script, since it will be invoked without --no-wizard
    shell.options.set('useWizards', False)
    import json

    cluster_set = dba.get_cluster_set()
    routers = cluster_set.list_routers()
    # mysqlsh objects are weirdâ€”they quack (i.e. duck typing) like standard Python objects (e.g. list,
    # dict), but do not serialize to JSON correctly.
    # Cast to str & load from JSON str before serializing
    routers = json.loads(str(routers))
    with open("/tmp/mysqlsh_output.json", "w") as file:
        json.dump(routers, file)
except mysqlsh.DBError as exception:
    error = {
        "message": str(exception),
        "code": exception.code,
        "traceback_message": "".join(traceback.format_exception(exception)),
    }
else:
    error = None
with open("/tmp/mysqlsh_error.json", "w") as file:
    json.dump(error, file)

MySQL client error 1040
MySQL Shell traceback:
Traceback (most recent call last):
  File "<string>", line 10, in <module>
mysqlsh.DBError: MySQL Error (1040): Dba.get_cluster_set: Too many connections

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router6-1/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 99, in _run_code
    raise ShellDBError(**exception)
common.mysql_shell.ShellDBError: MySQL Error (1040): Dba.get_cluster_set: Too many connections
unit-router3-0: 01:59:58 ERROR unit.router3/0.juju-log cos:21: common.mysql_shell:Failed to run MySQL Shell script:
import json
import mysqlsh
import traceback

try:
    # Disable wizards in this script, since it will be invoked without --no-wizard
    shell.options.set('useWizards', False)
    import json

    cluster_set = dba.get_cluster_set()
    routers = cluster_set.list_routers()
    # mysqlsh objects are weirdâ€”they quack (i.e. duck typing) like standard Python objects (e.g. list,
    # dict), but do not serialize to JSON correctly.
    # Cast to str & load from JSON str before serializing
    routers = json.loads(str(routers))
    with open("/tmp/mysqlsh_output.json", "w") as file:
        json.dump(routers, file)
except mysqlsh.DBError as exception:
    error = {
        "message": str(exception),
        "code": exception.code,
        "traceback_message": "".join(traceback.format_exception(exception)),
    }
else:
    error = None
with open("/tmp/mysqlsh_error.json", "w") as file:
    json.dump(error, file)

MySQL client error 1040
MySQL Shell traceback:
Traceback (most recent call last):
  File "<string>", line 10, in <module>
mysqlsh.DBError: MySQL Error (1040): Dba.get_cluster_set: Too many connections

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router3-0/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 99, in _run_code
    raise ShellDBError(**exception)
common.mysql_shell.ShellDBError: MySQL Error (1040): Dba.get_cluster_set: Too many connections
unit-router6-1: 01:59:58 ERROR unit.router6/1.juju-log backend-database:50: root:Uncaught exception while in charm code:
Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router6-1/charm/src/charm.py", line 470, in <module>
    ops.main.main(KubernetesRouterCharm)
  File "/var/lib/juju/agents/unit-router6-1/charm/venv/lib/python3.10/site-packages/ops/main.py", line 436, in main
    _emit_charm_event(charm, dispatcher.event_name)
  File "/var/lib/juju/agents/unit-router6-1/charm/venv/lib/python3.10/site-packages/ops/main.py", line 144, in _emit_charm_event
    event_to_emit.emit(*args, **kwargs)
  File "/var/lib/juju/agents/unit-router6-1/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 351, in emit
    framework._emit(event)
  File "/var/lib/juju/agents/unit-router6-1/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 853, in _emit
    self._reemit(event_path)
  File "/var/lib/juju/agents/unit-router6-1/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 942, in _reemit
    custom_handler(event)
  File "/var/lib/juju/agents/unit-router6-1/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router6-1/charm/venv/lib/python3.10/site-packages/common/abstract_charm.py", line 359, in reconcile
    logger.debug(f"{workload_.status=}")
  File "/var/lib/juju/agents/unit-router6-1/charm/venv/lib/python3.10/site-packages/common/workload.py", line 439, in status
    if not self.shell.is_router_in_cluster_set(self._router_id):
  File "/var/lib/juju/agents/unit-router6-1/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 288, in is_router_in_cluster_set
    self._run_code(
  File "/var/lib/juju/agents/unit-router6-1/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 99, in _run_code
    raise ShellDBError(**exception)
common.mysql_shell.ShellDBError: MySQL Error (1040): Dba.get_cluster_set: Too many connections
unit-router3-0: 01:59:58 ERROR unit.router3/0.juju-log cos:21: root:Uncaught exception while in charm code:
Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router3-0/charm/src/charm.py", line 470, in <module>
    ops.main.main(KubernetesRouterCharm)
  File "/var/lib/juju/agents/unit-router3-0/charm/venv/lib/python3.10/site-packages/ops/main.py", line 436, in main
    _emit_charm_event(charm, dispatcher.event_name)
  File "/var/lib/juju/agents/unit-router3-0/charm/venv/lib/python3.10/site-packages/ops/main.py", line 144, in _emit_charm_event
    event_to_emit.emit(*args, **kwargs)
  File "/var/lib/juju/agents/unit-router3-0/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 351, in emit
    framework._emit(event)
  File "/var/lib/juju/agents/unit-router3-0/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 853, in _emit
    self._reemit(event_path)
  File "/var/lib/juju/agents/unit-router3-0/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 942, in _reemit
    custom_handler(event)
  File "/var/lib/juju/agents/unit-router3-0/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router3-0/charm/venv/lib/python3.10/site-packages/common/abstract_charm.py", line 359, in reconcile
    logger.debug(f"{workload_.status=}")
  File "/var/lib/juju/agents/unit-router3-0/charm/venv/lib/python3.10/site-packages/common/workload.py", line 439, in status
    if not self.shell.is_router_in_cluster_set(self._router_id):
  File "/var/lib/juju/agents/unit-router3-0/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 288, in is_router_in_cluster_set
    self._run_code(
  File "/var/lib/juju/agents/unit-router3-0/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 99, in _run_code
    raise ShellDBError(**exception)
common.mysql_shell.ShellDBError: MySQL Error (1040): Dba.get_cluster_set: Too many connections
unit-router6-1: 01:59:58 ERROR juju.worker.uniter.operation hook "backend-database-relation-joined" (via hook dispatching script: dispatch) failed: exit status 1
unit-router3-0: 01:59:58 ERROR juju.worker.uniter.operation hook "cos-relation-joined" (via hook dispatching script: dispatch) failed: exit status 1
unit-router1-2: 02:00:34 ERROR unit.router1/2.juju-log database:41: common.mysql_shell:Failed to run MySQL Shell script:
import json
import mysqlsh
import traceback

try:
    # Disable wizards in this script, since it will be invoked without --no-wizard
    shell.options.set('useWizards', False)
    import json

    cluster_set = dba.get_cluster_set()
    routers = cluster_set.list_routers()
    # mysqlsh objects are weirdâ€”they quack (i.e. duck typing) like standard Python objects (e.g. list,
    # dict), but do not serialize to JSON correctly.
    # Cast to str & load from JSON str before serializing
    routers = json.loads(str(routers))
    with open("/tmp/mysqlsh_output.json", "w") as file:
        json.dump(routers, file)
except mysqlsh.DBError as exception:
    error = {
        "message": str(exception),
        "code": exception.code,
        "traceback_message": "".join(traceback.format_exception(exception)),
    }
else:
    error = None
with open("/tmp/mysqlsh_error.json", "w") as file:
    json.dump(error, file)

stderr:
Cannot set LC_ALL to locale en_US.UTF-8: No such file or directory
MySQL Error 1040 (HY000): Too many connections

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router1-2/charm/src/rock.py", line 254, in _run_command
    output, _ = process.wait_output()
  File "/var/lib/juju/agents/unit-router1-2/charm/venv/lib/python3.10/site-packages/ops/pebble.py", line 1441, in wait_output
    raise ExecError[AnyStr](self._command, exit_code, out_value, err_value)
ops.pebble.ExecError: non-zero exit code 1 executing ['mysqlsh', '--passwords-from-stdin', '--uri', 'relation-40_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306', '--python', '--file', '/tmp/mysqlsh_script.py'], stdout="\x1b[1mPlease provide the password for 'relation-40_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306': \x1b[0m", stderr='Cannot set LC_ALL to locale en_US.UTF-8: No such file or directory\nMySQL Error 1040 (HY000): Too many connections\n'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router1-2/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 74, in _run_code
    self._container.run_mysql_shell(
  File "/var/lib/juju/agents/unit-router1-2/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router1-2/charm/venv/lib/python3.10/site-packages/common/container.py", line 236, in run_mysql_shell
    return self._run_command(args, timeout=timeout, input=input)
  File "/var/lib/juju/agents/unit-router1-2/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router1-2/charm/src/rock.py", line 256, in _run_command
    raise common.container.CalledProcessError(
common.container.CalledProcessError: Command '['mysqlsh', '--passwords-from-stdin', '--uri', 'relation-40_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306', '--python', '--file', '/tmp/mysqlsh_script.py']' returned non-zero exit status 1.
unit-router1-2: 02:00:34 ERROR unit.router1/2.juju-log database:41: root:Uncaught exception while in charm code:
Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router1-2/charm/src/rock.py", line 254, in _run_command
    output, _ = process.wait_output()
  File "/var/lib/juju/agents/unit-router1-2/charm/venv/lib/python3.10/site-packages/ops/pebble.py", line 1441, in wait_output
    raise ExecError[AnyStr](self._command, exit_code, out_value, err_value)
ops.pebble.ExecError: non-zero exit code 1 executing ['mysqlsh', '--passwords-from-stdin', '--uri', 'relation-40_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306', '--python', '--file', '/tmp/mysqlsh_script.py'], stdout="\x1b[1mPlease provide the password for 'relation-40_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306': \x1b[0m", stderr='Cannot set LC_ALL to locale en_US.UTF-8: No such file or directory\nMySQL Error 1040 (HY000): Too many connections\n'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router1-2/charm/src/charm.py", line 470, in <module>
    ops.main.main(KubernetesRouterCharm)
  File "/var/lib/juju/agents/unit-router1-2/charm/venv/lib/python3.10/site-packages/ops/main.py", line 436, in main
    _emit_charm_event(charm, dispatcher.event_name)
  File "/var/lib/juju/agents/unit-router1-2/charm/venv/lib/python3.10/site-packages/ops/main.py", line 144, in _emit_charm_event
    event_to_emit.emit(*args, **kwargs)
  File "/var/lib/juju/agents/unit-router1-2/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 351, in emit
    framework._emit(event)
  File "/var/lib/juju/agents/unit-router1-2/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 853, in _emit
    self._reemit(event_path)
  File "/var/lib/juju/agents/unit-router1-2/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 942, in _reemit
    custom_handler(event)
  File "/var/lib/juju/agents/unit-router1-2/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router1-2/charm/venv/lib/python3.10/site-packages/common/abstract_charm.py", line 359, in reconcile
    logger.debug(f"{workload_.status=}")
  File "/var/lib/juju/agents/unit-router1-2/charm/venv/lib/python3.10/site-packages/common/workload.py", line 439, in status
    if not self.shell.is_router_in_cluster_set(self._router_id):
  File "/var/lib/juju/agents/unit-router1-2/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 288, in is_router_in_cluster_set
    self._run_code(
  File "/var/lib/juju/agents/unit-router1-2/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 74, in _run_code
    self._container.run_mysql_shell(
  File "/var/lib/juju/agents/unit-router1-2/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router1-2/charm/venv/lib/python3.10/site-packages/common/container.py", line 236, in run_mysql_shell
    return self._run_command(args, timeout=timeout, input=input)
  File "/var/lib/juju/agents/unit-router1-2/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router1-2/charm/src/rock.py", line 256, in _run_command
    raise common.container.CalledProcessError(
common.container.CalledProcessError: Command '['mysqlsh', '--passwords-from-stdin', '--uri', 'relation-40_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306', '--python', '--file', '/tmp/mysqlsh_script.py']' returned non-zero exit status 1.
unit-router1-2: 02:00:35 ERROR juju.worker.uniter.operation hook "database-relation-joined" (via hook dispatching script: dispatch) failed: exit status 1
unit-router2-1: 02:00:52 ERROR unit.router2/1.juju-log database:43: common.mysql_shell:Failed to run MySQL Shell script:
import json
import mysqlsh
import traceback

try:
    # Disable wizards in this script, since it will be invoked without --no-wizard
    shell.options.set('useWizards', False)
    import json

    cluster_set = dba.get_cluster_set()
    routers = cluster_set.list_routers()
    # mysqlsh objects are weirdâ€”they quack (i.e. duck typing) like standard Python objects (e.g. list,
    # dict), but do not serialize to JSON correctly.
    # Cast to str & load from JSON str before serializing
    routers = json.loads(str(routers))
    with open("/tmp/mysqlsh_output.json", "w") as file:
        json.dump(routers, file)
except mysqlsh.DBError as exception:
    error = {
        "message": str(exception),
        "code": exception.code,
        "traceback_message": "".join(traceback.format_exception(exception)),
    }
else:
    error = None
with open("/tmp/mysqlsh_error.json", "w") as file:
    json.dump(error, file)

MySQL client error 1040
MySQL Shell traceback:
Traceback (most recent call last):
  File "<string>", line 10, in <module>
mysqlsh.DBError: MySQL Error (1040): Dba.get_cluster_set: Too many connections

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router2-1/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 99, in _run_code
    raise ShellDBError(**exception)
common.mysql_shell.ShellDBError: MySQL Error (1040): Dba.get_cluster_set: Too many connections
unit-router2-1: 02:00:52 ERROR unit.router2/1.juju-log database:43: root:Uncaught exception while in charm code:
Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router2-1/charm/src/charm.py", line 470, in <module>
    ops.main.main(KubernetesRouterCharm)
  File "/var/lib/juju/agents/unit-router2-1/charm/venv/lib/python3.10/site-packages/ops/main.py", line 436, in main
    _emit_charm_event(charm, dispatcher.event_name)
  File "/var/lib/juju/agents/unit-router2-1/charm/venv/lib/python3.10/site-packages/ops/main.py", line 144, in _emit_charm_event
    event_to_emit.emit(*args, **kwargs)
  File "/var/lib/juju/agents/unit-router2-1/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 351, in emit
    framework._emit(event)
  File "/var/lib/juju/agents/unit-router2-1/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 853, in _emit
    self._reemit(event_path)
  File "/var/lib/juju/agents/unit-router2-1/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 942, in _reemit
    custom_handler(event)
  File "/var/lib/juju/agents/unit-router2-1/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router2-1/charm/venv/lib/python3.10/site-packages/common/abstract_charm.py", line 359, in reconcile
    logger.debug(f"{workload_.status=}")
  File "/var/lib/juju/agents/unit-router2-1/charm/venv/lib/python3.10/site-packages/common/workload.py", line 439, in status
    if not self.shell.is_router_in_cluster_set(self._router_id):
  File "/var/lib/juju/agents/unit-router2-1/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 288, in is_router_in_cluster_set
    self._run_code(
  File "/var/lib/juju/agents/unit-router2-1/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 99, in _run_code
    raise ShellDBError(**exception)
common.mysql_shell.ShellDBError: MySQL Error (1040): Dba.get_cluster_set: Too many connections
unit-router2-1: 02:00:53 ERROR juju.worker.uniter.operation hook "database-relation-joined" (via hook dispatching script: dispatch) failed: exit status 1
unit-router2-2: 02:00:57 ERROR unit.router2/2.juju-log backend-database:42: common.mysql_shell:Failed to run MySQL Shell script:
import json
import mysqlsh
import traceback

try:
    # Disable wizards in this script, since it will be invoked without --no-wizard
    shell.options.set('useWizards', False)
    import json

    cluster_set = dba.get_cluster_set()
    routers = cluster_set.list_routers()
    # mysqlsh objects are weirdâ€”they quack (i.e. duck typing) like standard Python objects (e.g. list,
    # dict), but do not serialize to JSON correctly.
    # Cast to str & load from JSON str before serializing
    routers = json.loads(str(routers))
    with open("/tmp/mysqlsh_output.json", "w") as file:
        json.dump(routers, file)
except mysqlsh.DBError as exception:
    error = {
        "message": str(exception),
        "code": exception.code,
        "traceback_message": "".join(traceback.format_exception(exception)),
    }
else:
    error = None
with open("/tmp/mysqlsh_error.json", "w") as file:
    json.dump(error, file)

MySQL client error 1040
MySQL Shell traceback:
Traceback (most recent call last):
  File "<string>", line 10, in <module>
mysqlsh.DBError: MySQL Error (1040): Dba.get_cluster_set: Too many connections

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router2-2/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 99, in _run_code
    raise ShellDBError(**exception)
common.mysql_shell.ShellDBError: MySQL Error (1040): Dba.get_cluster_set: Too many connections
unit-router2-2: 02:00:57 ERROR unit.router2/2.juju-log backend-database:42: root:Uncaught exception while in charm code:
Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router2-2/charm/src/charm.py", line 470, in <module>
    ops.main.main(KubernetesRouterCharm)
  File "/var/lib/juju/agents/unit-router2-2/charm/venv/lib/python3.10/site-packages/ops/main.py", line 436, in main
    _emit_charm_event(charm, dispatcher.event_name)
  File "/var/lib/juju/agents/unit-router2-2/charm/venv/lib/python3.10/site-packages/ops/main.py", line 144, in _emit_charm_event
    event_to_emit.emit(*args, **kwargs)
  File "/var/lib/juju/agents/unit-router2-2/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 351, in emit
    framework._emit(event)
  File "/var/lib/juju/agents/unit-router2-2/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 853, in _emit
    self._reemit(event_path)
  File "/var/lib/juju/agents/unit-router2-2/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 942, in _reemit
    custom_handler(event)
  File "/var/lib/juju/agents/unit-router2-2/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router2-2/charm/venv/lib/python3.10/site-packages/common/abstract_charm.py", line 360, in reconcile
    if not workload_.status:
  File "/var/lib/juju/agents/unit-router2-2/charm/venv/lib/python3.10/site-packages/common/workload.py", line 439, in status
    if not self.shell.is_router_in_cluster_set(self._router_id):
  File "/var/lib/juju/agents/unit-router2-2/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 288, in is_router_in_cluster_set
    self._run_code(
  File "/var/lib/juju/agents/unit-router2-2/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 99, in _run_code
    raise ShellDBError(**exception)
common.mysql_shell.ShellDBError: MySQL Error (1040): Dba.get_cluster_set: Too many connections
unit-router1-2: 02:00:57 ERROR unit.router1/2.juju-log database:41: common.mysql_shell:Failed to run MySQL Shell script:
import json
import mysqlsh
import traceback

try:
    # Disable wizards in this script, since it will be invoked without --no-wizard
    shell.options.set('useWizards', False)
    import json

    cluster_set = dba.get_cluster_set()
    routers = cluster_set.list_routers()
    # mysqlsh objects are weirdâ€”they quack (i.e. duck typing) like standard Python objects (e.g. list,
    # dict), but do not serialize to JSON correctly.
    # Cast to str & load from JSON str before serializing
    routers = json.loads(str(routers))
    with open("/tmp/mysqlsh_output.json", "w") as file:
        json.dump(routers, file)
except mysqlsh.DBError as exception:
    error = {
        "message": str(exception),
        "code": exception.code,
        "traceback_message": "".join(traceback.format_exception(exception)),
    }
else:
    error = None
with open("/tmp/mysqlsh_error.json", "w") as file:
    json.dump(error, file)

stderr:
Cannot set LC_ALL to locale en_US.UTF-8: No such file or directory
MySQL Error 1040 (HY000): Too many connections

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router1-2/charm/src/rock.py", line 254, in _run_command
    output, _ = process.wait_output()
  File "/var/lib/juju/agents/unit-router1-2/charm/venv/lib/python3.10/site-packages/ops/pebble.py", line 1441, in wait_output
    raise ExecError[AnyStr](self._command, exit_code, out_value, err_value)
ops.pebble.ExecError: non-zero exit code 1 executing ['mysqlsh', '--passwords-from-stdin', '--uri', 'relation-40_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306', '--python', '--file', '/tmp/mysqlsh_script.py'], stdout="\x1b[1mPlease provide the password for 'relation-40_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306': \x1b[0m", stderr='Cannot set LC_ALL to locale en_US.UTF-8: No such file or directory\nMySQL Error 1040 (HY000): Too many connections\n'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router1-2/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 74, in _run_code
    self._container.run_mysql_shell(
  File "/var/lib/juju/agents/unit-router1-2/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router1-2/charm/venv/lib/python3.10/site-packages/common/container.py", line 236, in run_mysql_shell
    return self._run_command(args, timeout=timeout, input=input)
  File "/var/lib/juju/agents/unit-router1-2/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router1-2/charm/src/rock.py", line 256, in _run_command
    raise common.container.CalledProcessError(
common.container.CalledProcessError: Command '['mysqlsh', '--passwords-from-stdin', '--uri', 'relation-40_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306', '--python', '--file', '/tmp/mysqlsh_script.py']' returned non-zero exit status 1.
unit-router1-2: 02:00:57 ERROR unit.router1/2.juju-log database:41: root:Uncaught exception while in charm code:
Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router1-2/charm/src/rock.py", line 254, in _run_command
    output, _ = process.wait_output()
  File "/var/lib/juju/agents/unit-router1-2/charm/venv/lib/python3.10/site-packages/ops/pebble.py", line 1441, in wait_output
    raise ExecError[AnyStr](self._command, exit_code, out_value, err_value)
ops.pebble.ExecError: non-zero exit code 1 executing ['mysqlsh', '--passwords-from-stdin', '--uri', 'relation-40_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306', '--python', '--file', '/tmp/mysqlsh_script.py'], stdout="\x1b[1mPlease provide the password for 'relation-40_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306': \x1b[0m", stderr='Cannot set LC_ALL to locale en_US.UTF-8: No such file or directory\nMySQL Error 1040 (HY000): Too many connections\n'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router1-2/charm/src/charm.py", line 470, in <module>
    ops.main.main(KubernetesRouterCharm)
  File "/var/lib/juju/agents/unit-router1-2/charm/venv/lib/python3.10/site-packages/ops/main.py", line 436, in main
    _emit_charm_event(charm, dispatcher.event_name)
  File "/var/lib/juju/agents/unit-router1-2/charm/venv/lib/python3.10/site-packages/ops/main.py", line 144, in _emit_charm_event
    event_to_emit.emit(*args, **kwargs)
  File "/var/lib/juju/agents/unit-router1-2/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 351, in emit
    framework._emit(event)
  File "/var/lib/juju/agents/unit-router1-2/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 853, in _emit
    self._reemit(event_path)
  File "/var/lib/juju/agents/unit-router1-2/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 942, in _reemit
    custom_handler(event)
  File "/var/lib/juju/agents/unit-router1-2/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router1-2/charm/venv/lib/python3.10/site-packages/common/abstract_charm.py", line 360, in reconcile
    if not workload_.status:
  File "/var/lib/juju/agents/unit-router1-2/charm/venv/lib/python3.10/site-packages/common/workload.py", line 439, in status
    if not self.shell.is_router_in_cluster_set(self._router_id):
  File "/var/lib/juju/agents/unit-router1-2/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 288, in is_router_in_cluster_set
    self._run_code(
  File "/var/lib/juju/agents/unit-router1-2/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 74, in _run_code
    self._container.run_mysql_shell(
  File "/var/lib/juju/agents/unit-router1-2/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router1-2/charm/venv/lib/python3.10/site-packages/common/container.py", line 236, in run_mysql_shell
    return self._run_command(args, timeout=timeout, input=input)
  File "/var/lib/juju/agents/unit-router1-2/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router1-2/charm/src/rock.py", line 256, in _run_command
    raise common.container.CalledProcessError(
common.container.CalledProcessError: Command '['mysqlsh', '--passwords-from-stdin', '--uri', 'relation-40_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306', '--python', '--file', '/tmp/mysqlsh_script.py']' returned non-zero exit status 1.
unit-router2-2: 02:00:57 ERROR juju.worker.uniter.operation hook "backend-database-relation-joined" (via hook dispatching script: dispatch) failed: exit status 1
unit-router1-2: 02:00:58 ERROR juju.worker.uniter.operation hook "database-relation-joined" (via hook dispatching script: dispatch) failed: exit status 1
unit-router0-0: 02:01:20 ERROR unit.router0/0.juju-log tls:6: common.mysql_shell:Failed to run MySQL Shell script:
import json
import mysqlsh
import traceback

try:
    # Disable wizards in this script, since it will be invoked without --no-wizard
    shell.options.set('useWizards', False)
    import json

    cluster_set = dba.get_cluster_set()
    routers = cluster_set.list_routers()
    # mysqlsh objects are weirdâ€”they quack (i.e. duck typing) like standard Python objects (e.g. list,
    # dict), but do not serialize to JSON correctly.
    # Cast to str & load from JSON str before serializing
    routers = json.loads(str(routers))
    with open("/tmp/mysqlsh_output.json", "w") as file:
        json.dump(routers, file)
except mysqlsh.DBError as exception:
    error = {
        "message": str(exception),
        "code": exception.code,
        "traceback_message": "".join(traceback.format_exception(exception)),
    }
else:
    error = None
with open("/tmp/mysqlsh_error.json", "w") as file:
    json.dump(error, file)

MySQL client error 1040
MySQL Shell traceback:
Traceback (most recent call last):
  File "<string>", line 10, in <module>
mysqlsh.DBError: MySQL Error (1040): Dba.get_cluster_set: Too many connections

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router0-0/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 99, in _run_code
    raise ShellDBError(**exception)
common.mysql_shell.ShellDBError: MySQL Error (1040): Dba.get_cluster_set: Too many connections
unit-router0-0: 02:01:21 ERROR unit.router0/0.juju-log tls:6: root:Uncaught exception while in charm code:
Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router0-0/charm/src/charm.py", line 470, in <module>
    ops.main.main(KubernetesRouterCharm)
  File "/var/lib/juju/agents/unit-router0-0/charm/venv/lib/python3.10/site-packages/ops/main.py", line 436, in main
    _emit_charm_event(charm, dispatcher.event_name)
  File "/var/lib/juju/agents/unit-router0-0/charm/venv/lib/python3.10/site-packages/ops/main.py", line 144, in _emit_charm_event
    event_to_emit.emit(*args, **kwargs)
  File "/var/lib/juju/agents/unit-router0-0/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 351, in emit
    framework._emit(event)
  File "/var/lib/juju/agents/unit-router0-0/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 853, in _emit
    self._reemit(event_path)
  File "/var/lib/juju/agents/unit-router0-0/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 942, in _reemit
    custom_handler(event)
  File "/var/lib/juju/agents/unit-router0-0/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router0-0/charm/venv/lib/python3.10/site-packages/common/abstract_charm.py", line 359, in reconcile
    logger.debug(f"{workload_.status=}")
  File "/var/lib/juju/agents/unit-router0-0/charm/venv/lib/python3.10/site-packages/common/workload.py", line 439, in status
    if not self.shell.is_router_in_cluster_set(self._router_id):
  File "/var/lib/juju/agents/unit-router0-0/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 288, in is_router_in_cluster_set
    self._run_code(
  File "/var/lib/juju/agents/unit-router0-0/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 99, in _run_code
    raise ShellDBError(**exception)
common.mysql_shell.ShellDBError: MySQL Error (1040): Dba.get_cluster_set: Too many connections
unit-router0-0: 02:01:21 ERROR juju.worker.uniter.operation hook "tls-relation-changed" (via hook dispatching script: dispatch) failed: exit status 1
unit-router5-2: 02:01:46 ERROR unit.router5/2.juju-log backend-database:48: common.mysql_shell:Failed to run MySQL Shell script:
import json
import mysqlsh
import traceback

try:
    # Disable wizards in this script, since it will be invoked without --no-wizard
    shell.options.set('useWizards', False)
    import json

    cluster_set = dba.get_cluster_set()
    routers = cluster_set.list_routers()
    # mysqlsh objects are weirdâ€”they quack (i.e. duck typing) like standard Python objects (e.g. list,
    # dict), but do not serialize to JSON correctly.
    # Cast to str & load from JSON str before serializing
    routers = json.loads(str(routers))
    with open("/tmp/mysqlsh_output.json", "w") as file:
        json.dump(routers, file)
except mysqlsh.DBError as exception:
    error = {
        "message": str(exception),
        "code": exception.code,
        "traceback_message": "".join(traceback.format_exception(exception)),
    }
else:
    error = None
with open("/tmp/mysqlsh_error.json", "w") as file:
    json.dump(error, file)

MySQL client error 1040
MySQL Shell traceback:
Traceback (most recent call last):
  File "<string>", line 10, in <module>
mysqlsh.DBError: MySQL Error (1040): Dba.get_cluster_set: Too many connections

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router5-2/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 99, in _run_code
    raise ShellDBError(**exception)
common.mysql_shell.ShellDBError: MySQL Error (1040): Dba.get_cluster_set: Too many connections
unit-router5-2: 02:01:46 ERROR unit.router5/2.juju-log backend-database:48: root:Uncaught exception while in charm code:
Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router5-2/charm/src/charm.py", line 470, in <module>
    ops.main.main(KubernetesRouterCharm)
  File "/var/lib/juju/agents/unit-router5-2/charm/venv/lib/python3.10/site-packages/ops/main.py", line 436, in main
    _emit_charm_event(charm, dispatcher.event_name)
  File "/var/lib/juju/agents/unit-router5-2/charm/venv/lib/python3.10/site-packages/ops/main.py", line 144, in _emit_charm_event
    event_to_emit.emit(*args, **kwargs)
  File "/var/lib/juju/agents/unit-router5-2/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 351, in emit
    framework._emit(event)
  File "/var/lib/juju/agents/unit-router5-2/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 853, in _emit
    self._reemit(event_path)
  File "/var/lib/juju/agents/unit-router5-2/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 942, in _reemit
    custom_handler(event)
  File "/var/lib/juju/agents/unit-router5-2/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router5-2/charm/venv/lib/python3.10/site-packages/common/abstract_charm.py", line 360, in reconcile
    if not workload_.status:
  File "/var/lib/juju/agents/unit-router5-2/charm/venv/lib/python3.10/site-packages/common/workload.py", line 439, in status
    if not self.shell.is_router_in_cluster_set(self._router_id):
  File "/var/lib/juju/agents/unit-router5-2/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 288, in is_router_in_cluster_set
    self._run_code(
  File "/var/lib/juju/agents/unit-router5-2/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 99, in _run_code
    raise ShellDBError(**exception)
common.mysql_shell.ShellDBError: MySQL Error (1040): Dba.get_cluster_set: Too many connections
unit-router5-0: 02:01:46 ERROR unit.router5/0.juju-log cos:31: common.mysql_shell:Failed to run MySQL Shell script:
import json
import mysqlsh
import traceback

try:
    # Disable wizards in this script, since it will be invoked without --no-wizard
    shell.options.set('useWizards', False)
    import json

    cluster_set = dba.get_cluster_set()
    routers = cluster_set.list_routers()
    # mysqlsh objects are weirdâ€”they quack (i.e. duck typing) like standard Python objects (e.g. list,
    # dict), but do not serialize to JSON correctly.
    # Cast to str & load from JSON str before serializing
    routers = json.loads(str(routers))
    with open("/tmp/mysqlsh_output.json", "w") as file:
        json.dump(routers, file)
except mysqlsh.DBError as exception:
    error = {
        "message": str(exception),
        "code": exception.code,
        "traceback_message": "".join(traceback.format_exception(exception)),
    }
else:
    error = None
with open("/tmp/mysqlsh_error.json", "w") as file:
    json.dump(error, file)

MySQL client error 1040
MySQL Shell traceback:
Traceback (most recent call last):
  File "<string>", line 10, in <module>
mysqlsh.DBError: MySQL Error (1040): Dba.get_cluster_set: Too many connections

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router5-0/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 99, in _run_code
    raise ShellDBError(**exception)
common.mysql_shell.ShellDBError: MySQL Error (1040): Dba.get_cluster_set: Too many connections
unit-router5-0: 02:01:46 ERROR unit.router5/0.juju-log cos:31: root:Uncaught exception while in charm code:
Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router5-0/charm/src/charm.py", line 470, in <module>
    ops.main.main(KubernetesRouterCharm)
  File "/var/lib/juju/agents/unit-router5-0/charm/venv/lib/python3.10/site-packages/ops/main.py", line 436, in main
    _emit_charm_event(charm, dispatcher.event_name)
  File "/var/lib/juju/agents/unit-router5-0/charm/venv/lib/python3.10/site-packages/ops/main.py", line 144, in _emit_charm_event
    event_to_emit.emit(*args, **kwargs)
  File "/var/lib/juju/agents/unit-router5-0/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 351, in emit
    framework._emit(event)
  File "/var/lib/juju/agents/unit-router5-0/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 853, in _emit
    self._reemit(event_path)
  File "/var/lib/juju/agents/unit-router5-0/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 942, in _reemit
    custom_handler(event)
  File "/var/lib/juju/agents/unit-router5-0/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router5-0/charm/venv/lib/python3.10/site-packages/common/abstract_charm.py", line 359, in reconcile
    logger.debug(f"{workload_.status=}")
  File "/var/lib/juju/agents/unit-router5-0/charm/venv/lib/python3.10/site-packages/common/workload.py", line 439, in status
    if not self.shell.is_router_in_cluster_set(self._router_id):
  File "/var/lib/juju/agents/unit-router5-0/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 288, in is_router_in_cluster_set
    self._run_code(
  File "/var/lib/juju/agents/unit-router5-0/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 99, in _run_code
    raise ShellDBError(**exception)
common.mysql_shell.ShellDBError: MySQL Error (1040): Dba.get_cluster_set: Too many connections
unit-router5-2: 02:01:47 ERROR juju.worker.uniter.operation hook "backend-database-relation-changed" (via hook dispatching script: dispatch) failed: exit status 1
unit-router5-0: 02:01:47 ERROR juju.worker.uniter.operation hook "cos-relation-changed" (via hook dispatching script: dispatch) failed: exit status 1
unit-router2-0: 02:01:49 ERROR unit.router2/0.juju-log cos:16: common.mysql_shell:Failed to run MySQL Shell script:
import json
import mysqlsh
import traceback

try:
    # Disable wizards in this script, since it will be invoked without --no-wizard
    shell.options.set('useWizards', False)
    import json

    cluster_set = dba.get_cluster_set()
    routers = cluster_set.list_routers()
    # mysqlsh objects are weirdâ€”they quack (i.e. duck typing) like standard Python objects (e.g. list,
    # dict), but do not serialize to JSON correctly.
    # Cast to str & load from JSON str before serializing
    routers = json.loads(str(routers))
    with open("/tmp/mysqlsh_output.json", "w") as file:
        json.dump(routers, file)
except mysqlsh.DBError as exception:
    error = {
        "message": str(exception),
        "code": exception.code,
        "traceback_message": "".join(traceback.format_exception(exception)),
    }
else:
    error = None
with open("/tmp/mysqlsh_error.json", "w") as file:
    json.dump(error, file)

stderr:
Cannot set LC_ALL to locale en_US.UTF-8: No such file or directory
MySQL Error 1040 (HY000): Too many connections

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router2-0/charm/src/rock.py", line 254, in _run_command
    output, _ = process.wait_output()
  File "/var/lib/juju/agents/unit-router2-0/charm/venv/lib/python3.10/site-packages/ops/pebble.py", line 1441, in wait_output
    raise ExecError[AnyStr](self._command, exit_code, out_value, err_value)
ops.pebble.ExecError: non-zero exit code 1 executing ['mysqlsh', '--passwords-from-stdin', '--uri', 'relation-42_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306', '--python', '--file', '/tmp/mysqlsh_script.py'], stdout="\x1b[1mPlease provide the password for 'relation-42_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306': \x1b[0m", stderr='Cannot set LC_ALL to locale en_US.UTF-8: No such file or directory\nMySQL Error 1040 (HY000): Too many connections\n'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router2-0/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 74, in _run_code
    self._container.run_mysql_shell(
  File "/var/lib/juju/agents/unit-router2-0/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router2-0/charm/venv/lib/python3.10/site-packages/common/container.py", line 236, in run_mysql_shell
    return self._run_command(args, timeout=timeout, input=input)
  File "/var/lib/juju/agents/unit-router2-0/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router2-0/charm/src/rock.py", line 256, in _run_command
    raise common.container.CalledProcessError(
common.container.CalledProcessError: Command '['mysqlsh', '--passwords-from-stdin', '--uri', 'relation-42_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306', '--python', '--file', '/tmp/mysqlsh_script.py']' returned non-zero exit status 1.
unit-router2-0: 02:01:49 ERROR unit.router2/0.juju-log cos:16: root:Uncaught exception while in charm code:
Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router2-0/charm/src/rock.py", line 254, in _run_command
    output, _ = process.wait_output()
  File "/var/lib/juju/agents/unit-router2-0/charm/venv/lib/python3.10/site-packages/ops/pebble.py", line 1441, in wait_output
    raise ExecError[AnyStr](self._command, exit_code, out_value, err_value)
ops.pebble.ExecError: non-zero exit code 1 executing ['mysqlsh', '--passwords-from-stdin', '--uri', 'relation-42_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306', '--python', '--file', '/tmp/mysqlsh_script.py'], stdout="\x1b[1mPlease provide the password for 'relation-42_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306': \x1b[0m", stderr='Cannot set LC_ALL to locale en_US.UTF-8: No such file or directory\nMySQL Error 1040 (HY000): Too many connections\n'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router2-0/charm/src/charm.py", line 470, in <module>
    ops.main.main(KubernetesRouterCharm)
  File "/var/lib/juju/agents/unit-router2-0/charm/venv/lib/python3.10/site-packages/ops/main.py", line 436, in main
    _emit_charm_event(charm, dispatcher.event_name)
  File "/var/lib/juju/agents/unit-router2-0/charm/venv/lib/python3.10/site-packages/ops/main.py", line 144, in _emit_charm_event
    event_to_emit.emit(*args, **kwargs)
  File "/var/lib/juju/agents/unit-router2-0/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 351, in emit
    framework._emit(event)
  File "/var/lib/juju/agents/unit-router2-0/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 853, in _emit
    self._reemit(event_path)
  File "/var/lib/juju/agents/unit-router2-0/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 942, in _reemit
    custom_handler(event)
  File "/var/lib/juju/agents/unit-router2-0/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router2-0/charm/venv/lib/python3.10/site-packages/common/abstract_charm.py", line 374, in reconcile
    self.set_status(event=event)
  File "/var/lib/juju/agents/unit-router2-0/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router2-0/charm/venv/lib/python3.10/site-packages/common/abstract_charm.py", line 261, in set_status
    self.unit.status = self._determine_unit_status(event=event)
  File "/var/lib/juju/agents/unit-router2-0/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router2-0/charm/venv/lib/python3.10/site-packages/common/abstract_charm.py", line 242, in _determine_unit_status
    if status := workload_.status:
  File "/var/lib/juju/agents/unit-router2-0/charm/venv/lib/python3.10/site-packages/common/workload.py", line 439, in status
    if not self.shell.is_router_in_cluster_set(self._router_id):
  File "/var/lib/juju/agents/unit-router2-0/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 288, in is_router_in_cluster_set
    self._run_code(
  File "/var/lib/juju/agents/unit-router2-0/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 74, in _run_code
    self._container.run_mysql_shell(
  File "/var/lib/juju/agents/unit-router2-0/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router2-0/charm/venv/lib/python3.10/site-packages/common/container.py", line 236, in run_mysql_shell
    return self._run_command(args, timeout=timeout, input=input)
  File "/var/lib/juju/agents/unit-router2-0/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router2-0/charm/src/rock.py", line 256, in _run_command
    raise common.container.CalledProcessError(
common.container.CalledProcessError: Command '['mysqlsh', '--passwords-from-stdin', '--uri', 'relation-42_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306', '--python', '--file', '/tmp/mysqlsh_script.py']' returned non-zero exit status 1.
unit-router4-2: 02:01:49 ERROR unit.router4/2.juju-log database:47: common.mysql_shell:Failed to run MySQL Shell script:
import json
import mysqlsh
import traceback

try:
    # Disable wizards in this script, since it will be invoked without --no-wizard
    shell.options.set('useWizards', False)
    import json

    cluster_set = dba.get_cluster_set()
    routers = cluster_set.list_routers()
    # mysqlsh objects are weirdâ€”they quack (i.e. duck typing) like standard Python objects (e.g. list,
    # dict), but do not serialize to JSON correctly.
    # Cast to str & load from JSON str before serializing
    routers = json.loads(str(routers))
    with open("/tmp/mysqlsh_output.json", "w") as file:
        json.dump(routers, file)
except mysqlsh.DBError as exception:
    error = {
        "message": str(exception),
        "code": exception.code,
        "traceback_message": "".join(traceback.format_exception(exception)),
    }
else:
    error = None
with open("/tmp/mysqlsh_error.json", "w") as file:
    json.dump(error, file)

stderr:
Cannot set LC_ALL to locale en_US.UTF-8: No such file or directory
MySQL Error 1040 (HY000): Too many connections

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router4-2/charm/src/rock.py", line 254, in _run_command
    output, _ = process.wait_output()
  File "/var/lib/juju/agents/unit-router4-2/charm/venv/lib/python3.10/site-packages/ops/pebble.py", line 1441, in wait_output
    raise ExecError[AnyStr](self._command, exit_code, out_value, err_value)
ops.pebble.ExecError: non-zero exit code 1 executing ['mysqlsh', '--passwords-from-stdin', '--uri', 'relation-46_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306', '--python', '--file', '/tmp/mysqlsh_script.py'], stdout="\x1b[1mPlease provide the password for 'relation-46_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306': \x1b[0m", stderr='Cannot set LC_ALL to locale en_US.UTF-8: No such file or directory\nMySQL Error 1040 (HY000): Too many connections\n'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router4-2/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 74, in _run_code
    self._container.run_mysql_shell(
  File "/var/lib/juju/agents/unit-router4-2/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router4-2/charm/venv/lib/python3.10/site-packages/common/container.py", line 236, in run_mysql_shell
    return self._run_command(args, timeout=timeout, input=input)
  File "/var/lib/juju/agents/unit-router4-2/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router4-2/charm/src/rock.py", line 256, in _run_command
    raise common.container.CalledProcessError(
common.container.CalledProcessError: Command '['mysqlsh', '--passwords-from-stdin', '--uri', 'relation-46_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306', '--python', '--file', '/tmp/mysqlsh_script.py']' returned non-zero exit status 1.
unit-router4-2: 02:01:49 ERROR unit.router4/2.juju-log database:47: root:Uncaught exception while in charm code:
Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router4-2/charm/src/rock.py", line 254, in _run_command
    output, _ = process.wait_output()
  File "/var/lib/juju/agents/unit-router4-2/charm/venv/lib/python3.10/site-packages/ops/pebble.py", line 1441, in wait_output
    raise ExecError[AnyStr](self._command, exit_code, out_value, err_value)
ops.pebble.ExecError: non-zero exit code 1 executing ['mysqlsh', '--passwords-from-stdin', '--uri', 'relation-46_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306', '--python', '--file', '/tmp/mysqlsh_script.py'], stdout="\x1b[1mPlease provide the password for 'relation-46_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306': \x1b[0m", stderr='Cannot set LC_ALL to locale en_US.UTF-8: No such file or directory\nMySQL Error 1040 (HY000): Too many connections\n'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router4-2/charm/src/charm.py", line 470, in <module>
    ops.main.main(KubernetesRouterCharm)
  File "/var/lib/juju/agents/unit-router4-2/charm/venv/lib/python3.10/site-packages/ops/main.py", line 436, in main
    _emit_charm_event(charm, dispatcher.event_name)
  File "/var/lib/juju/agents/unit-router4-2/charm/venv/lib/python3.10/site-packages/ops/main.py", line 144, in _emit_charm_event
    event_to_emit.emit(*args, **kwargs)
  File "/var/lib/juju/agents/unit-router4-2/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 351, in emit
    framework._emit(event)
  File "/var/lib/juju/agents/unit-router4-2/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 853, in _emit
    self._reemit(event_path)
  File "/var/lib/juju/agents/unit-router4-2/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 942, in _reemit
    custom_handler(event)
  File "/var/lib/juju/agents/unit-router4-2/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router4-2/charm/venv/lib/python3.10/site-packages/common/abstract_charm.py", line 359, in reconcile
    logger.debug(f"{workload_.status=}")
  File "/var/lib/juju/agents/unit-router4-2/charm/venv/lib/python3.10/site-packages/common/workload.py", line 439, in status
    if not self.shell.is_router_in_cluster_set(self._router_id):
  File "/var/lib/juju/agents/unit-router4-2/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 288, in is_router_in_cluster_set
    self._run_code(
  File "/var/lib/juju/agents/unit-router4-2/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 74, in _run_code
    self._container.run_mysql_shell(
  File "/var/lib/juju/agents/unit-router4-2/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router4-2/charm/venv/lib/python3.10/site-packages/common/container.py", line 236, in run_mysql_shell
    return self._run_command(args, timeout=timeout, input=input)
  File "/var/lib/juju/agents/unit-router4-2/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router4-2/charm/src/rock.py", line 256, in _run_command
    raise common.container.CalledProcessError(
common.container.CalledProcessError: Command '['mysqlsh', '--passwords-from-stdin', '--uri', 'relation-46_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306', '--python', '--file', '/tmp/mysqlsh_script.py']' returned non-zero exit status 1.
unit-router2-0: 02:01:50 ERROR juju.worker.uniter.operation hook "cos-relation-joined" (via hook dispatching script: dispatch) failed: exit status 1
unit-router4-2: 02:01:50 ERROR juju.worker.uniter.operation hook "database-relation-changed" (via hook dispatching script: dispatch) failed: exit status 1
unit-router5-2: 02:02:16 ERROR unit.router5/2.juju-log backend-database:48: common.mysql_shell:Failed to run MySQL Shell script:
import json
import mysqlsh
import traceback

try:
    # Disable wizards in this script, since it will be invoked without --no-wizard
    shell.options.set('useWizards', False)
    import json

    cluster_set = dba.get_cluster_set()
    routers = cluster_set.list_routers()
    # mysqlsh objects are weirdâ€”they quack (i.e. duck typing) like standard Python objects (e.g. list,
    # dict), but do not serialize to JSON correctly.
    # Cast to str & load from JSON str before serializing
    routers = json.loads(str(routers))
    with open("/tmp/mysqlsh_output.json", "w") as file:
        json.dump(routers, file)
except mysqlsh.DBError as exception:
    error = {
        "message": str(exception),
        "code": exception.code,
        "traceback_message": "".join(traceback.format_exception(exception)),
    }
else:
    error = None
with open("/tmp/mysqlsh_error.json", "w") as file:
    json.dump(error, file)

MySQL client error 1040
MySQL Shell traceback:
Traceback (most recent call last):
  File "<string>", line 10, in <module>
mysqlsh.DBError: MySQL Error (1040): Dba.get_cluster_set: Too many connections

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router5-2/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 99, in _run_code
    raise ShellDBError(**exception)
common.mysql_shell.ShellDBError: MySQL Error (1040): Dba.get_cluster_set: Too many connections
unit-router5-2: 02:02:16 ERROR unit.router5/2.juju-log backend-database:48: root:Uncaught exception while in charm code:
Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router5-2/charm/src/charm.py", line 470, in <module>
    ops.main.main(KubernetesRouterCharm)
  File "/var/lib/juju/agents/unit-router5-2/charm/venv/lib/python3.10/site-packages/ops/main.py", line 436, in main
    _emit_charm_event(charm, dispatcher.event_name)
  File "/var/lib/juju/agents/unit-router5-2/charm/venv/lib/python3.10/site-packages/ops/main.py", line 144, in _emit_charm_event
    event_to_emit.emit(*args, **kwargs)
  File "/var/lib/juju/agents/unit-router5-2/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 351, in emit
    framework._emit(event)
  File "/var/lib/juju/agents/unit-router5-2/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 853, in _emit
    self._reemit(event_path)
  File "/var/lib/juju/agents/unit-router5-2/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 942, in _reemit
    custom_handler(event)
  File "/var/lib/juju/agents/unit-router5-2/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router5-2/charm/venv/lib/python3.10/site-packages/common/abstract_charm.py", line 374, in reconcile
    self.set_status(event=event)
  File "/var/lib/juju/agents/unit-router5-2/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router5-2/charm/venv/lib/python3.10/site-packages/common/abstract_charm.py", line 261, in set_status
    self.unit.status = self._determine_unit_status(event=event)
  File "/var/lib/juju/agents/unit-router5-2/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router5-2/charm/venv/lib/python3.10/site-packages/common/abstract_charm.py", line 242, in _determine_unit_status
    if status := workload_.status:
  File "/var/lib/juju/agents/unit-router5-2/charm/venv/lib/python3.10/site-packages/common/workload.py", line 439, in status
    if not self.shell.is_router_in_cluster_set(self._router_id):
  File "/var/lib/juju/agents/unit-router5-2/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 288, in is_router_in_cluster_set
    self._run_code(
  File "/var/lib/juju/agents/unit-router5-2/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 99, in _run_code
    raise ShellDBError(**exception)
common.mysql_shell.ShellDBError: MySQL Error (1040): Dba.get_cluster_set: Too many connections
unit-router5-2: 02:02:16 ERROR juju.worker.uniter.operation hook "backend-database-relation-changed" (via hook dispatching script: dispatch) failed: exit status 1
unit-router6-0: 02:02:22 ERROR unit.router6/0.juju-log cos:34: common.mysql_shell:Failed to run MySQL Shell script:
import json
import mysqlsh
import traceback

try:
    # Disable wizards in this script, since it will be invoked without --no-wizard
    shell.options.set('useWizards', False)
    import json

    cluster_set = dba.get_cluster_set()
    routers = cluster_set.list_routers()
    # mysqlsh objects are weirdâ€”they quack (i.e. duck typing) like standard Python objects (e.g. list,
    # dict), but do not serialize to JSON correctly.
    # Cast to str & load from JSON str before serializing
    routers = json.loads(str(routers))
    with open("/tmp/mysqlsh_output.json", "w") as file:
        json.dump(routers, file)
except mysqlsh.DBError as exception:
    error = {
        "message": str(exception),
        "code": exception.code,
        "traceback_message": "".join(traceback.format_exception(exception)),
    }
else:
    error = None
with open("/tmp/mysqlsh_error.json", "w") as file:
    json.dump(error, file)

MySQL client error 1040
MySQL Shell traceback:
Traceback (most recent call last):
  File "<string>", line 10, in <module>
mysqlsh.DBError: MySQL Error (1040): Dba.get_cluster_set: Too many connections

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router6-0/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 99, in _run_code
    raise ShellDBError(**exception)
common.mysql_shell.ShellDBError: MySQL Error (1040): Dba.get_cluster_set: Too many connections
unit-router6-0: 02:02:22 ERROR unit.router6/0.juju-log cos:34: root:Uncaught exception while in charm code:
Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router6-0/charm/src/charm.py", line 470, in <module>
    ops.main.main(KubernetesRouterCharm)
  File "/var/lib/juju/agents/unit-router6-0/charm/venv/lib/python3.10/site-packages/ops/main.py", line 436, in main
    _emit_charm_event(charm, dispatcher.event_name)
  File "/var/lib/juju/agents/unit-router6-0/charm/venv/lib/python3.10/site-packages/ops/main.py", line 144, in _emit_charm_event
    event_to_emit.emit(*args, **kwargs)
  File "/var/lib/juju/agents/unit-router6-0/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 351, in emit
    framework._emit(event)
  File "/var/lib/juju/agents/unit-router6-0/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 853, in _emit
    self._reemit(event_path)
  File "/var/lib/juju/agents/unit-router6-0/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 942, in _reemit
    custom_handler(event)
  File "/var/lib/juju/agents/unit-router6-0/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router6-0/charm/venv/lib/python3.10/site-packages/common/abstract_charm.py", line 374, in reconcile
    self.set_status(event=event)
  File "/var/lib/juju/agents/unit-router6-0/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router6-0/charm/venv/lib/python3.10/site-packages/common/abstract_charm.py", line 261, in set_status
    self.unit.status = self._determine_unit_status(event=event)
  File "/var/lib/juju/agents/unit-router6-0/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router6-0/charm/venv/lib/python3.10/site-packages/common/abstract_charm.py", line 242, in _determine_unit_status
    if status := workload_.status:
  File "/var/lib/juju/agents/unit-router6-0/charm/venv/lib/python3.10/site-packages/common/workload.py", line 439, in status
    if not self.shell.is_router_in_cluster_set(self._router_id):
  File "/var/lib/juju/agents/unit-router6-0/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 288, in is_router_in_cluster_set
    self._run_code(
  File "/var/lib/juju/agents/unit-router6-0/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 99, in _run_code
    raise ShellDBError(**exception)
common.mysql_shell.ShellDBError: MySQL Error (1040): Dba.get_cluster_set: Too many connections
unit-router6-2: 02:02:22 ERROR unit.router6/2.juju-log backend-database:50: common.mysql_shell:Failed to run MySQL Shell script:
import json
import mysqlsh
import traceback

try:
    # Disable wizards in this script, since it will be invoked without --no-wizard
    shell.options.set('useWizards', False)
    import json

    cluster_set = dba.get_cluster_set()
    routers = cluster_set.list_routers()
    # mysqlsh objects are weirdâ€”they quack (i.e. duck typing) like standard Python objects (e.g. list,
    # dict), but do not serialize to JSON correctly.
    # Cast to str & load from JSON str before serializing
    routers = json.loads(str(routers))
    with open("/tmp/mysqlsh_output.json", "w") as file:
        json.dump(routers, file)
except mysqlsh.DBError as exception:
    error = {
        "message": str(exception),
        "code": exception.code,
        "traceback_message": "".join(traceback.format_exception(exception)),
    }
else:
    error = None
with open("/tmp/mysqlsh_error.json", "w") as file:
    json.dump(error, file)

MySQL client error 1040
MySQL Shell traceback:
Traceback (most recent call last):
  File "<string>", line 10, in <module>
mysqlsh.DBError: MySQL Error (1040): Dba.get_cluster_set: Too many connections

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router6-2/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 99, in _run_code
    raise ShellDBError(**exception)
common.mysql_shell.ShellDBError: MySQL Error (1040): Dba.get_cluster_set: Too many connections
unit-router6-2: 02:02:22 ERROR unit.router6/2.juju-log backend-database:50: root:Uncaught exception while in charm code:
Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router6-2/charm/src/charm.py", line 470, in <module>
    ops.main.main(KubernetesRouterCharm)
  File "/var/lib/juju/agents/unit-router6-2/charm/venv/lib/python3.10/site-packages/ops/main.py", line 436, in main
    _emit_charm_event(charm, dispatcher.event_name)
  File "/var/lib/juju/agents/unit-router6-2/charm/venv/lib/python3.10/site-packages/ops/main.py", line 144, in _emit_charm_event
    event_to_emit.emit(*args, **kwargs)
  File "/var/lib/juju/agents/unit-router6-2/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 351, in emit
    framework._emit(event)
  File "/var/lib/juju/agents/unit-router6-2/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 853, in _emit
    self._reemit(event_path)
  File "/var/lib/juju/agents/unit-router6-2/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 942, in _reemit
    custom_handler(event)
  File "/var/lib/juju/agents/unit-router6-2/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router6-2/charm/venv/lib/python3.10/site-packages/common/abstract_charm.py", line 374, in reconcile
    self.set_status(event=event)
  File "/var/lib/juju/agents/unit-router6-2/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router6-2/charm/venv/lib/python3.10/site-packages/common/abstract_charm.py", line 261, in set_status
    self.unit.status = self._determine_unit_status(event=event)
  File "/var/lib/juju/agents/unit-router6-2/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router6-2/charm/venv/lib/python3.10/site-packages/common/abstract_charm.py", line 242, in _determine_unit_status
    if status := workload_.status:
  File "/var/lib/juju/agents/unit-router6-2/charm/venv/lib/python3.10/site-packages/common/workload.py", line 439, in status
    if not self.shell.is_router_in_cluster_set(self._router_id):
  File "/var/lib/juju/agents/unit-router6-2/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 288, in is_router_in_cluster_set
    self._run_code(
  File "/var/lib/juju/agents/unit-router6-2/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 99, in _run_code
    raise ShellDBError(**exception)
common.mysql_shell.ShellDBError: MySQL Error (1040): Dba.get_cluster_set: Too many connections
unit-router6-1: 02:02:22 ERROR unit.router6/1.juju-log backend-database:50: common.mysql_shell:Failed to run MySQL Shell script:
import json
import mysqlsh
import traceback

try:
    # Disable wizards in this script, since it will be invoked without --no-wizard
    shell.options.set('useWizards', False)
    import json

    cluster_set = dba.get_cluster_set()
    routers = cluster_set.list_routers()
    # mysqlsh objects are weirdâ€”they quack (i.e. duck typing) like standard Python objects (e.g. list,
    # dict), but do not serialize to JSON correctly.
    # Cast to str & load from JSON str before serializing
    routers = json.loads(str(routers))
    with open("/tmp/mysqlsh_output.json", "w") as file:
        json.dump(routers, file)
except mysqlsh.DBError as exception:
    error = {
        "message": str(exception),
        "code": exception.code,
        "traceback_message": "".join(traceback.format_exception(exception)),
    }
else:
    error = None
with open("/tmp/mysqlsh_error.json", "w") as file:
    json.dump(error, file)

MySQL client error 1040
MySQL Shell traceback:
Traceback (most recent call last):
  File "<string>", line 10, in <module>
mysqlsh.DBError: MySQL Error (1040): Dba.get_cluster_set: Too many connections

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router6-1/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 99, in _run_code
    raise ShellDBError(**exception)
common.mysql_shell.ShellDBError: MySQL Error (1040): Dba.get_cluster_set: Too many connections
unit-router6-1: 02:02:22 ERROR unit.router6/1.juju-log backend-database:50: root:Uncaught exception while in charm code:
Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router6-1/charm/src/charm.py", line 470, in <module>
    ops.main.main(KubernetesRouterCharm)
  File "/var/lib/juju/agents/unit-router6-1/charm/venv/lib/python3.10/site-packages/ops/main.py", line 436, in main
    _emit_charm_event(charm, dispatcher.event_name)
  File "/var/lib/juju/agents/unit-router6-1/charm/venv/lib/python3.10/site-packages/ops/main.py", line 144, in _emit_charm_event
    event_to_emit.emit(*args, **kwargs)
  File "/var/lib/juju/agents/unit-router6-1/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 351, in emit
    framework._emit(event)
  File "/var/lib/juju/agents/unit-router6-1/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 853, in _emit
    self._reemit(event_path)
  File "/var/lib/juju/agents/unit-router6-1/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 942, in _reemit
    custom_handler(event)
  File "/var/lib/juju/agents/unit-router6-1/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router6-1/charm/venv/lib/python3.10/site-packages/common/abstract_charm.py", line 374, in reconcile
    self.set_status(event=event)
  File "/var/lib/juju/agents/unit-router6-1/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router6-1/charm/venv/lib/python3.10/site-packages/common/abstract_charm.py", line 261, in set_status
    self.unit.status = self._determine_unit_status(event=event)
  File "/var/lib/juju/agents/unit-router6-1/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router6-1/charm/venv/lib/python3.10/site-packages/common/abstract_charm.py", line 242, in _determine_unit_status
    if status := workload_.status:
  File "/var/lib/juju/agents/unit-router6-1/charm/venv/lib/python3.10/site-packages/common/workload.py", line 439, in status
    if not self.shell.is_router_in_cluster_set(self._router_id):
  File "/var/lib/juju/agents/unit-router6-1/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 288, in is_router_in_cluster_set
    self._run_code(
  File "/var/lib/juju/agents/unit-router6-1/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 99, in _run_code
    raise ShellDBError(**exception)
common.mysql_shell.ShellDBError: MySQL Error (1040): Dba.get_cluster_set: Too many connections
unit-router6-0: 02:02:22 ERROR juju.worker.uniter.operation hook "cos-relation-joined" (via hook dispatching script: dispatch) failed: exit status 1
unit-router6-2: 02:02:22 ERROR juju.worker.uniter.operation hook "backend-database-relation-joined" (via hook dispatching script: dispatch) failed: exit status 1
unit-router6-1: 02:02:23 ERROR juju.worker.uniter.operation hook "backend-database-relation-joined" (via hook dispatching script: dispatch) failed: exit status 1
unit-router2-1: 02:02:41 ERROR unit.router2/1.juju-log backend-database:42: common.mysql_shell:Failed to run MySQL Shell script:
import json
import mysqlsh
import traceback

try:
    # Disable wizards in this script, since it will be invoked without --no-wizard
    shell.options.set('useWizards', False)
    import json

    cluster_set = dba.get_cluster_set()
    routers = cluster_set.list_routers()
    # mysqlsh objects are weirdâ€”they quack (i.e. duck typing) like standard Python objects (e.g. list,
    # dict), but do not serialize to JSON correctly.
    # Cast to str & load from JSON str before serializing
    routers = json.loads(str(routers))
    with open("/tmp/mysqlsh_output.json", "w") as file:
        json.dump(routers, file)
except mysqlsh.DBError as exception:
    error = {
        "message": str(exception),
        "code": exception.code,
        "traceback_message": "".join(traceback.format_exception(exception)),
    }
else:
    error = None
with open("/tmp/mysqlsh_error.json", "w") as file:
    json.dump(error, file)

stderr:
Cannot set LC_ALL to locale en_US.UTF-8: No such file or directory
MySQL Error 1040 (HY000): Too many connections

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router2-1/charm/src/rock.py", line 254, in _run_command
    output, _ = process.wait_output()
  File "/var/lib/juju/agents/unit-router2-1/charm/venv/lib/python3.10/site-packages/ops/pebble.py", line 1441, in wait_output
    raise ExecError[AnyStr](self._command, exit_code, out_value, err_value)
ops.pebble.ExecError: non-zero exit code 1 executing ['mysqlsh', '--passwords-from-stdin', '--uri', 'relation-42_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306', '--python', '--file', '/tmp/mysqlsh_script.py'], stdout="\x1b[1mPlease provide the password for 'relation-42_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306': \x1b[0m", stderr='Cannot set LC_ALL to locale en_US.UTF-8: No such file or directory\nMySQL Error 1040 (HY000): Too many connections\n'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router2-1/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 74, in _run_code
    self._container.run_mysql_shell(
  File "/var/lib/juju/agents/unit-router2-1/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router2-1/charm/venv/lib/python3.10/site-packages/common/container.py", line 236, in run_mysql_shell
    return self._run_command(args, timeout=timeout, input=input)
  File "/var/lib/juju/agents/unit-router2-1/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router2-1/charm/src/rock.py", line 256, in _run_command
    raise common.container.CalledProcessError(
common.container.CalledProcessError: Command '['mysqlsh', '--passwords-from-stdin', '--uri', 'relation-42_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306', '--python', '--file', '/tmp/mysqlsh_script.py']' returned non-zero exit status 1.
unit-router2-1: 02:02:41 ERROR unit.router2/1.juju-log backend-database:42: root:Uncaught exception while in charm code:
Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router2-1/charm/src/rock.py", line 254, in _run_command
    output, _ = process.wait_output()
  File "/var/lib/juju/agents/unit-router2-1/charm/venv/lib/python3.10/site-packages/ops/pebble.py", line 1441, in wait_output
    raise ExecError[AnyStr](self._command, exit_code, out_value, err_value)
ops.pebble.ExecError: non-zero exit code 1 executing ['mysqlsh', '--passwords-from-stdin', '--uri', 'relation-42_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306', '--python', '--file', '/tmp/mysqlsh_script.py'], stdout="\x1b[1mPlease provide the password for 'relation-42_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306': \x1b[0m", stderr='Cannot set LC_ALL to locale en_US.UTF-8: No such file or directory\nMySQL Error 1040 (HY000): Too many connections\n'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router2-1/charm/src/charm.py", line 470, in <module>
    ops.main.main(KubernetesRouterCharm)
  File "/var/lib/juju/agents/unit-router2-1/charm/venv/lib/python3.10/site-packages/ops/main.py", line 436, in main
    _emit_charm_event(charm, dispatcher.event_name)
  File "/var/lib/juju/agents/unit-router2-1/charm/venv/lib/python3.10/site-packages/ops/main.py", line 144, in _emit_charm_event
    event_to_emit.emit(*args, **kwargs)
  File "/var/lib/juju/agents/unit-router2-1/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 351, in emit
    framework._emit(event)
  File "/var/lib/juju/agents/unit-router2-1/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 853, in _emit
    self._reemit(event_path)
  File "/var/lib/juju/agents/unit-router2-1/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 942, in _reemit
    custom_handler(event)
  File "/var/lib/juju/agents/unit-router2-1/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router2-1/charm/venv/lib/python3.10/site-packages/common/abstract_charm.py", line 374, in reconcile
    self.set_status(event=event)
  File "/var/lib/juju/agents/unit-router2-1/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router2-1/charm/venv/lib/python3.10/site-packages/common/abstract_charm.py", line 261, in set_status
    self.unit.status = self._determine_unit_status(event=event)
  File "/var/lib/juju/agents/unit-router2-1/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router2-1/charm/venv/lib/python3.10/site-packages/common/abstract_charm.py", line 242, in _determine_unit_status
    if status := workload_.status:
  File "/var/lib/juju/agents/unit-router2-1/charm/venv/lib/python3.10/site-packages/common/workload.py", line 439, in status
    if not self.shell.is_router_in_cluster_set(self._router_id):
  File "/var/lib/juju/agents/unit-router2-1/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 288, in is_router_in_cluster_set
    self._run_code(
  File "/var/lib/juju/agents/unit-router2-1/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 74, in _run_code
    self._container.run_mysql_shell(
  File "/var/lib/juju/agents/unit-router2-1/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router2-1/charm/venv/lib/python3.10/site-packages/common/container.py", line 236, in run_mysql_shell
    return self._run_command(args, timeout=timeout, input=input)
  File "/var/lib/juju/agents/unit-router2-1/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router2-1/charm/src/rock.py", line 256, in _run_command
    raise common.container.CalledProcessError(
common.container.CalledProcessError: Command '['mysqlsh', '--passwords-from-stdin', '--uri', 'relation-42_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306', '--python', '--file', '/tmp/mysqlsh_script.py']' returned non-zero exit status 1.
unit-router2-1: 02:02:42 ERROR juju.worker.uniter.operation hook "backend-database-relation-changed" (via hook dispatching script: dispatch) failed: exit status 1
unit-router5-0: 02:02:47 ERROR unit.router5/0.juju-log mysql-router-peers:29: common.mysql_shell:Failed to run MySQL Shell script:
import json
import mysqlsh
import traceback

try:
    # Disable wizards in this script, since it will be invoked without --no-wizard
    shell.options.set('useWizards', False)
    import json

    cluster_set = dba.get_cluster_set()
    routers = cluster_set.list_routers()
    # mysqlsh objects are weirdâ€”they quack (i.e. duck typing) like standard Python objects (e.g. list,
    # dict), but do not serialize to JSON correctly.
    # Cast to str & load from JSON str before serializing
    routers = json.loads(str(routers))
    with open("/tmp/mysqlsh_output.json", "w") as file:
        json.dump(routers, file)
except mysqlsh.DBError as exception:
    error = {
        "message": str(exception),
        "code": exception.code,
        "traceback_message": "".join(traceback.format_exception(exception)),
    }
else:
    error = None
with open("/tmp/mysqlsh_error.json", "w") as file:
    json.dump(error, file)

MySQL client error 1040
MySQL Shell traceback:
Traceback (most recent call last):
  File "<string>", line 10, in <module>
mysqlsh.DBError: MySQL Error (1040): Dba.get_cluster_set: Too many connections

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router5-0/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 99, in _run_code
    raise ShellDBError(**exception)
common.mysql_shell.ShellDBError: MySQL Error (1040): Dba.get_cluster_set: Too many connections
unit-router5-0: 02:02:47 ERROR unit.router5/0.juju-log mysql-router-peers:29: root:Uncaught exception while in charm code:
Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router5-0/charm/src/charm.py", line 470, in <module>
    ops.main.main(KubernetesRouterCharm)
  File "/var/lib/juju/agents/unit-router5-0/charm/venv/lib/python3.10/site-packages/ops/main.py", line 436, in main
    _emit_charm_event(charm, dispatcher.event_name)
  File "/var/lib/juju/agents/unit-router5-0/charm/venv/lib/python3.10/site-packages/ops/main.py", line 144, in _emit_charm_event
    event_to_emit.emit(*args, **kwargs)
  File "/var/lib/juju/agents/unit-router5-0/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 351, in emit
    framework._emit(event)
  File "/var/lib/juju/agents/unit-router5-0/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 853, in _emit
    self._reemit(event_path)
  File "/var/lib/juju/agents/unit-router5-0/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 942, in _reemit
    custom_handler(event)
  File "/var/lib/juju/agents/unit-router5-0/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router5-0/charm/venv/lib/python3.10/site-packages/common/abstract_charm.py", line 360, in reconcile
    if not workload_.status:
  File "/var/lib/juju/agents/unit-router5-0/charm/venv/lib/python3.10/site-packages/common/workload.py", line 439, in status
    if not self.shell.is_router_in_cluster_set(self._router_id):
  File "/var/lib/juju/agents/unit-router5-0/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 288, in is_router_in_cluster_set
    self._run_code(
  File "/var/lib/juju/agents/unit-router5-0/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 99, in _run_code
    raise ShellDBError(**exception)
common.mysql_shell.ShellDBError: MySQL Error (1040): Dba.get_cluster_set: Too many connections
unit-router6-2: 02:02:47 ERROR unit.router6/2.juju-log backend-database:50: common.mysql_shell:Failed to run MySQL Shell script:
import json
import mysqlsh
import traceback

try:
    # Disable wizards in this script, since it will be invoked without --no-wizard
    shell.options.set('useWizards', False)
    import json

    cluster_set = dba.get_cluster_set()
    routers = cluster_set.list_routers()
    # mysqlsh objects are weirdâ€”they quack (i.e. duck typing) like standard Python objects (e.g. list,
    # dict), but do not serialize to JSON correctly.
    # Cast to str & load from JSON str before serializing
    routers = json.loads(str(routers))
    with open("/tmp/mysqlsh_output.json", "w") as file:
        json.dump(routers, file)
except mysqlsh.DBError as exception:
    error = {
        "message": str(exception),
        "code": exception.code,
        "traceback_message": "".join(traceback.format_exception(exception)),
    }
else:
    error = None
with open("/tmp/mysqlsh_error.json", "w") as file:
    json.dump(error, file)

MySQL client error 1040
MySQL Shell traceback:
Traceback (most recent call last):
  File "<string>", line 10, in <module>
mysqlsh.DBError: MySQL Error (1040): Dba.get_cluster_set: Too many connections

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router6-2/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 99, in _run_code
    raise ShellDBError(**exception)
common.mysql_shell.ShellDBError: MySQL Error (1040): Dba.get_cluster_set: Too many connections
unit-router6-2: 02:02:47 ERROR unit.router6/2.juju-log backend-database:50: root:Uncaught exception while in charm code:
Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router6-2/charm/src/charm.py", line 470, in <module>
    ops.main.main(KubernetesRouterCharm)
  File "/var/lib/juju/agents/unit-router6-2/charm/venv/lib/python3.10/site-packages/ops/main.py", line 436, in main
    _emit_charm_event(charm, dispatcher.event_name)
  File "/var/lib/juju/agents/unit-router6-2/charm/venv/lib/python3.10/site-packages/ops/main.py", line 144, in _emit_charm_event
    event_to_emit.emit(*args, **kwargs)
  File "/var/lib/juju/agents/unit-router6-2/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 351, in emit
    framework._emit(event)
  File "/var/lib/juju/agents/unit-router6-2/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 853, in _emit
    self._reemit(event_path)
  File "/var/lib/juju/agents/unit-router6-2/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 942, in _reemit
    custom_handler(event)
  File "/var/lib/juju/agents/unit-router6-2/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router6-2/charm/venv/lib/python3.10/site-packages/common/abstract_charm.py", line 360, in reconcile
    if not workload_.status:
  File "/var/lib/juju/agents/unit-router6-2/charm/venv/lib/python3.10/site-packages/common/workload.py", line 439, in status
    if not self.shell.is_router_in_cluster_set(self._router_id):
  File "/var/lib/juju/agents/unit-router6-2/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 288, in is_router_in_cluster_set
    self._run_code(
  File "/var/lib/juju/agents/unit-router6-2/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 99, in _run_code
    raise ShellDBError(**exception)
common.mysql_shell.ShellDBError: MySQL Error (1040): Dba.get_cluster_set: Too many connections
unit-router5-0: 02:02:47 ERROR juju.worker.uniter.operation hook "mysql-router-peers-relation-changed" (via hook dispatching script: dispatch) failed: exit status 1
unit-router3-2: 02:02:47 ERROR unit.router3/2.juju-log database:45: common.mysql_shell:Failed to run MySQL Shell script:
import json
import mysqlsh
import traceback

try:
    # Disable wizards in this script, since it will be invoked without --no-wizard
    shell.options.set('useWizards', False)
    import json

    cluster_set = dba.get_cluster_set()
    routers = cluster_set.list_routers()
    # mysqlsh objects are weirdâ€”they quack (i.e. duck typing) like standard Python objects (e.g. list,
    # dict), but do not serialize to JSON correctly.
    # Cast to str & load from JSON str before serializing
    routers = json.loads(str(routers))
    with open("/tmp/mysqlsh_output.json", "w") as file:
        json.dump(routers, file)
except mysqlsh.DBError as exception:
    error = {
        "message": str(exception),
        "code": exception.code,
        "traceback_message": "".join(traceback.format_exception(exception)),
    }
else:
    error = None
with open("/tmp/mysqlsh_error.json", "w") as file:
    json.dump(error, file)

MySQL client error 1040
MySQL Shell traceback:
Traceback (most recent call last):
  File "<string>", line 10, in <module>
mysqlsh.DBError: MySQL Error (1040): Dba.get_cluster_set: Too many connections

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router3-2/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 99, in _run_code
    raise ShellDBError(**exception)
common.mysql_shell.ShellDBError: MySQL Error (1040): Dba.get_cluster_set: Too many connections
unit-router3-2: 02:02:47 ERROR unit.router3/2.juju-log database:45: root:Uncaught exception while in charm code:
Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router3-2/charm/src/charm.py", line 470, in <module>
    ops.main.main(KubernetesRouterCharm)
  File "/var/lib/juju/agents/unit-router3-2/charm/venv/lib/python3.10/site-packages/ops/main.py", line 436, in main
    _emit_charm_event(charm, dispatcher.event_name)
  File "/var/lib/juju/agents/unit-router3-2/charm/venv/lib/python3.10/site-packages/ops/main.py", line 144, in _emit_charm_event
    event_to_emit.emit(*args, **kwargs)
  File "/var/lib/juju/agents/unit-router3-2/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 351, in emit
    framework._emit(event)
  File "/var/lib/juju/agents/unit-router3-2/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 853, in _emit
    self._reemit(event_path)
  File "/var/lib/juju/agents/unit-router3-2/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 942, in _reemit
    custom_handler(event)
  File "/var/lib/juju/agents/unit-router3-2/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router3-2/charm/venv/lib/python3.10/site-packages/common/abstract_charm.py", line 360, in reconcile
    if not workload_.status:
  File "/var/lib/juju/agents/unit-router3-2/charm/venv/lib/python3.10/site-packages/common/workload.py", line 439, in status
    if not self.shell.is_router_in_cluster_set(self._router_id):
  File "/var/lib/juju/agents/unit-router3-2/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 288, in is_router_in_cluster_set
    self._run_code(
  File "/var/lib/juju/agents/unit-router3-2/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 99, in _run_code
    raise ShellDBError(**exception)
common.mysql_shell.ShellDBError: MySQL Error (1040): Dba.get_cluster_set: Too many connections
unit-router6-2: 02:02:47 ERROR juju.worker.uniter.operation hook "backend-database-relation-joined" (via hook dispatching script: dispatch) failed: exit status 1
unit-router3-2: 02:02:48 ERROR juju.worker.uniter.operation hook "database-relation-changed" (via hook dispatching script: dispatch) failed: exit status 1
unit-router6-2: 02:03:16 ERROR unit.router6/2.juju-log backend-database:50: common.mysql_shell:Failed to run MySQL Shell script:
import json
import mysqlsh
import traceback

try:
    # Disable wizards in this script, since it will be invoked without --no-wizard
    shell.options.set('useWizards', False)
    import json

    cluster_set = dba.get_cluster_set()
    routers = cluster_set.list_routers()
    # mysqlsh objects are weirdâ€”they quack (i.e. duck typing) like standard Python objects (e.g. list,
    # dict), but do not serialize to JSON correctly.
    # Cast to str & load from JSON str before serializing
    routers = json.loads(str(routers))
    with open("/tmp/mysqlsh_output.json", "w") as file:
        json.dump(routers, file)
except mysqlsh.DBError as exception:
    error = {
        "message": str(exception),
        "code": exception.code,
        "traceback_message": "".join(traceback.format_exception(exception)),
    }
else:
    error = None
with open("/tmp/mysqlsh_error.json", "w") as file:
    json.dump(error, file)

MySQL client error 1040
MySQL Shell traceback:
Traceback (most recent call last):
  File "<string>", line 10, in <module>
mysqlsh.DBError: MySQL Error (1040): Dba.get_cluster_set: Too many connections

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router6-2/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 99, in _run_code
    raise ShellDBError(**exception)
common.mysql_shell.ShellDBError: MySQL Error (1040): Dba.get_cluster_set: Too many connections
unit-router6-2: 02:03:16 ERROR unit.router6/2.juju-log backend-database:50: root:Uncaught exception while in charm code:
Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router6-2/charm/src/charm.py", line 470, in <module>
    ops.main.main(KubernetesRouterCharm)
  File "/var/lib/juju/agents/unit-router6-2/charm/venv/lib/python3.10/site-packages/ops/main.py", line 436, in main
    _emit_charm_event(charm, dispatcher.event_name)
  File "/var/lib/juju/agents/unit-router6-2/charm/venv/lib/python3.10/site-packages/ops/main.py", line 144, in _emit_charm_event
    event_to_emit.emit(*args, **kwargs)
  File "/var/lib/juju/agents/unit-router6-2/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 351, in emit
    framework._emit(event)
  File "/var/lib/juju/agents/unit-router6-2/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 853, in _emit
    self._reemit(event_path)
  File "/var/lib/juju/agents/unit-router6-2/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 942, in _reemit
    custom_handler(event)
  File "/var/lib/juju/agents/unit-router6-2/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router6-2/charm/venv/lib/python3.10/site-packages/common/abstract_charm.py", line 360, in reconcile
    if not workload_.status:
  File "/var/lib/juju/agents/unit-router6-2/charm/venv/lib/python3.10/site-packages/common/workload.py", line 439, in status
    if not self.shell.is_router_in_cluster_set(self._router_id):
  File "/var/lib/juju/agents/unit-router6-2/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 288, in is_router_in_cluster_set
    self._run_code(
  File "/var/lib/juju/agents/unit-router6-2/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 99, in _run_code
    raise ShellDBError(**exception)
common.mysql_shell.ShellDBError: MySQL Error (1040): Dba.get_cluster_set: Too many connections
unit-router2-1: 02:03:16 ERROR unit.router2/1.juju-log backend-database:42: common.mysql_shell:Failed to run MySQL Shell script:
import json
import mysqlsh
import traceback

try:
    # Disable wizards in this script, since it will be invoked without --no-wizard
    shell.options.set('useWizards', False)
    import json

    cluster_set = dba.get_cluster_set()
    routers = cluster_set.list_routers()
    # mysqlsh objects are weirdâ€”they quack (i.e. duck typing) like standard Python objects (e.g. list,
    # dict), but do not serialize to JSON correctly.
    # Cast to str & load from JSON str before serializing
    routers = json.loads(str(routers))
    with open("/tmp/mysqlsh_output.json", "w") as file:
        json.dump(routers, file)
except mysqlsh.DBError as exception:
    error = {
        "message": str(exception),
        "code": exception.code,
        "traceback_message": "".join(traceback.format_exception(exception)),
    }
else:
    error = None
with open("/tmp/mysqlsh_error.json", "w") as file:
    json.dump(error, file)

MySQL client error 1040
MySQL Shell traceback:
Traceback (most recent call last):
  File "<string>", line 10, in <module>
mysqlsh.DBError: MySQL Error (1040): Dba.get_cluster_set: Too many connections

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router2-1/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 99, in _run_code
    raise ShellDBError(**exception)
common.mysql_shell.ShellDBError: MySQL Error (1040): Dba.get_cluster_set: Too many connections
unit-router1-2: 02:03:16 ERROR unit.router1/2.juju-log backend-database:40: common.mysql_shell:Failed to run MySQL Shell script:
import json
import mysqlsh
import traceback

try:
    # Disable wizards in this script, since it will be invoked without --no-wizard
    shell.options.set('useWizards', False)
    import json

    cluster_set = dba.get_cluster_set()
    routers = cluster_set.list_routers()
    # mysqlsh objects are weirdâ€”they quack (i.e. duck typing) like standard Python objects (e.g. list,
    # dict), but do not serialize to JSON correctly.
    # Cast to str & load from JSON str before serializing
    routers = json.loads(str(routers))
    with open("/tmp/mysqlsh_output.json", "w") as file:
        json.dump(routers, file)
except mysqlsh.DBError as exception:
    error = {
        "message": str(exception),
        "code": exception.code,
        "traceback_message": "".join(traceback.format_exception(exception)),
    }
else:
    error = None
with open("/tmp/mysqlsh_error.json", "w") as file:
    json.dump(error, file)

MySQL client error 1040
MySQL Shell traceback:
Traceback (most recent call last):
  File "<string>", line 10, in <module>
mysqlsh.DBError: MySQL Error (1040): Dba.get_cluster_set: Too many connections

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router1-2/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 99, in _run_code
    raise ShellDBError(**exception)
common.mysql_shell.ShellDBError: MySQL Error (1040): Dba.get_cluster_set: Too many connections
unit-router2-1: 02:03:16 ERROR unit.router2/1.juju-log backend-database:42: root:Uncaught exception while in charm code:
Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router2-1/charm/src/charm.py", line 470, in <module>
    ops.main.main(KubernetesRouterCharm)
  File "/var/lib/juju/agents/unit-router2-1/charm/venv/lib/python3.10/site-packages/ops/main.py", line 436, in main
    _emit_charm_event(charm, dispatcher.event_name)
  File "/var/lib/juju/agents/unit-router2-1/charm/venv/lib/python3.10/site-packages/ops/main.py", line 144, in _emit_charm_event
    event_to_emit.emit(*args, **kwargs)
  File "/var/lib/juju/agents/unit-router2-1/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 351, in emit
    framework._emit(event)
  File "/var/lib/juju/agents/unit-router2-1/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 853, in _emit
    self._reemit(event_path)
  File "/var/lib/juju/agents/unit-router2-1/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 942, in _reemit
    custom_handler(event)
  File "/var/lib/juju/agents/unit-router2-1/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router2-1/charm/venv/lib/python3.10/site-packages/common/abstract_charm.py", line 374, in reconcile
    self.set_status(event=event)
  File "/var/lib/juju/agents/unit-router2-1/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router2-1/charm/venv/lib/python3.10/site-packages/common/abstract_charm.py", line 261, in set_status
    self.unit.status = self._determine_unit_status(event=event)
  File "/var/lib/juju/agents/unit-router2-1/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router2-1/charm/venv/lib/python3.10/site-packages/common/abstract_charm.py", line 242, in _determine_unit_status
    if status := workload_.status:
  File "/var/lib/juju/agents/unit-router2-1/charm/venv/lib/python3.10/site-packages/common/workload.py", line 439, in status
    if not self.shell.is_router_in_cluster_set(self._router_id):
  File "/var/lib/juju/agents/unit-router2-1/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 288, in is_router_in_cluster_set
    self._run_code(
  File "/var/lib/juju/agents/unit-router2-1/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 99, in _run_code
    raise ShellDBError(**exception)
common.mysql_shell.ShellDBError: MySQL Error (1040): Dba.get_cluster_set: Too many connections
unit-router1-2: 02:03:16 ERROR unit.router1/2.juju-log backend-database:40: root:Uncaught exception while in charm code:
Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router1-2/charm/src/charm.py", line 470, in <module>
    ops.main.main(KubernetesRouterCharm)
  File "/var/lib/juju/agents/unit-router1-2/charm/venv/lib/python3.10/site-packages/ops/main.py", line 436, in main
    _emit_charm_event(charm, dispatcher.event_name)
  File "/var/lib/juju/agents/unit-router1-2/charm/venv/lib/python3.10/site-packages/ops/main.py", line 144, in _emit_charm_event
    event_to_emit.emit(*args, **kwargs)
  File "/var/lib/juju/agents/unit-router1-2/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 351, in emit
    framework._emit(event)
  File "/var/lib/juju/agents/unit-router1-2/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 853, in _emit
    self._reemit(event_path)
  File "/var/lib/juju/agents/unit-router1-2/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 942, in _reemit
    custom_handler(event)
  File "/var/lib/juju/agents/unit-router1-2/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router1-2/charm/venv/lib/python3.10/site-packages/common/abstract_charm.py", line 360, in reconcile
    if not workload_.status:
  File "/var/lib/juju/agents/unit-router1-2/charm/venv/lib/python3.10/site-packages/common/workload.py", line 439, in status
    if not self.shell.is_router_in_cluster_set(self._router_id):
  File "/var/lib/juju/agents/unit-router1-2/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 288, in is_router_in_cluster_set
    self._run_code(
  File "/var/lib/juju/agents/unit-router1-2/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 99, in _run_code
    raise ShellDBError(**exception)
common.mysql_shell.ShellDBError: MySQL Error (1040): Dba.get_cluster_set: Too many connections
unit-router6-2: 02:03:16 ERROR juju.worker.uniter.operation hook "backend-database-relation-joined" (via hook dispatching script: dispatch) failed: exit status 1
unit-router2-1: 02:03:17 ERROR juju.worker.uniter.operation hook "backend-database-relation-changed" (via hook dispatching script: dispatch) failed: exit status 1
unit-router1-2: 02:03:17 ERROR juju.worker.uniter.operation hook "backend-database-relation-joined" (via hook dispatching script: dispatch) failed: exit status 1
unit-router6-1: 02:03:20 ERROR unit.router6/1.juju-log backend-database:50: common.mysql_shell:Failed to run MySQL Shell script:
import json
import mysqlsh
import traceback

try:
    # Disable wizards in this script, since it will be invoked without --no-wizard
    shell.options.set('useWizards', False)
    import json

    cluster_set = dba.get_cluster_set()
    routers = cluster_set.list_routers()
    # mysqlsh objects are weirdâ€”they quack (i.e. duck typing) like standard Python objects (e.g. list,
    # dict), but do not serialize to JSON correctly.
    # Cast to str & load from JSON str before serializing
    routers = json.loads(str(routers))
    with open("/tmp/mysqlsh_output.json", "w") as file:
        json.dump(routers, file)
except mysqlsh.DBError as exception:
    error = {
        "message": str(exception),
        "code": exception.code,
        "traceback_message": "".join(traceback.format_exception(exception)),
    }
else:
    error = None
with open("/tmp/mysqlsh_error.json", "w") as file:
    json.dump(error, file)

MySQL client error 1040
MySQL Shell traceback:
Traceback (most recent call last):
  File "<string>", line 10, in <module>
mysqlsh.DBError: MySQL Error (1040): Dba.get_cluster_set: Too many connections

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router6-1/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 99, in _run_code
    raise ShellDBError(**exception)
common.mysql_shell.ShellDBError: MySQL Error (1040): Dba.get_cluster_set: Too many connections
unit-router6-1: 02:03:20 ERROR unit.router6/1.juju-log backend-database:50: root:Uncaught exception while in charm code:
Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router6-1/charm/src/charm.py", line 470, in <module>
    ops.main.main(KubernetesRouterCharm)
  File "/var/lib/juju/agents/unit-router6-1/charm/venv/lib/python3.10/site-packages/ops/main.py", line 436, in main
    _emit_charm_event(charm, dispatcher.event_name)
  File "/var/lib/juju/agents/unit-router6-1/charm/venv/lib/python3.10/site-packages/ops/main.py", line 144, in _emit_charm_event
    event_to_emit.emit(*args, **kwargs)
  File "/var/lib/juju/agents/unit-router6-1/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 351, in emit
    framework._emit(event)
  File "/var/lib/juju/agents/unit-router6-1/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 853, in _emit
    self._reemit(event_path)
  File "/var/lib/juju/agents/unit-router6-1/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 942, in _reemit
    custom_handler(event)
  File "/var/lib/juju/agents/unit-router6-1/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router6-1/charm/venv/lib/python3.10/site-packages/common/abstract_charm.py", line 359, in reconcile
    logger.debug(f"{workload_.status=}")
  File "/var/lib/juju/agents/unit-router6-1/charm/venv/lib/python3.10/site-packages/common/workload.py", line 439, in status
    if not self.shell.is_router_in_cluster_set(self._router_id):
  File "/var/lib/juju/agents/unit-router6-1/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 288, in is_router_in_cluster_set
    self._run_code(
  File "/var/lib/juju/agents/unit-router6-1/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 99, in _run_code
    raise ShellDBError(**exception)
common.mysql_shell.ShellDBError: MySQL Error (1040): Dba.get_cluster_set: Too many connections
unit-router6-1: 02:03:21 ERROR juju.worker.uniter.operation hook "backend-database-relation-changed" (via hook dispatching script: dispatch) failed: exit status 1
unit-router3-2: 02:03:21 ERROR unit.router3/2.juju-log database:45: common.mysql_shell:Failed to run MySQL Shell script:
import json
import mysqlsh
import traceback

try:
    # Disable wizards in this script, since it will be invoked without --no-wizard
    shell.options.set('useWizards', False)
    import json

    cluster_set = dba.get_cluster_set()
    routers = cluster_set.list_routers()
    # mysqlsh objects are weirdâ€”they quack (i.e. duck typing) like standard Python objects (e.g. list,
    # dict), but do not serialize to JSON correctly.
    # Cast to str & load from JSON str before serializing
    routers = json.loads(str(routers))
    with open("/tmp/mysqlsh_output.json", "w") as file:
        json.dump(routers, file)
except mysqlsh.DBError as exception:
    error = {
        "message": str(exception),
        "code": exception.code,
        "traceback_message": "".join(traceback.format_exception(exception)),
    }
else:
    error = None
with open("/tmp/mysqlsh_error.json", "w") as file:
    json.dump(error, file)

MySQL client error 1040
MySQL Shell traceback:
Traceback (most recent call last):
  File "<string>", line 10, in <module>
mysqlsh.DBError: MySQL Error (1040): Dba.get_cluster_set: Too many connections

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router3-2/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 99, in _run_code
    raise ShellDBError(**exception)
common.mysql_shell.ShellDBError: MySQL Error (1040): Dba.get_cluster_set: Too many connections
unit-router3-2: 02:03:21 ERROR unit.router3/2.juju-log database:45: root:Uncaught exception while in charm code:
Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router3-2/charm/src/charm.py", line 470, in <module>
    ops.main.main(KubernetesRouterCharm)
  File "/var/lib/juju/agents/unit-router3-2/charm/venv/lib/python3.10/site-packages/ops/main.py", line 436, in main
    _emit_charm_event(charm, dispatcher.event_name)
  File "/var/lib/juju/agents/unit-router3-2/charm/venv/lib/python3.10/site-packages/ops/main.py", line 144, in _emit_charm_event
    event_to_emit.emit(*args, **kwargs)
  File "/var/lib/juju/agents/unit-router3-2/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 351, in emit
    framework._emit(event)
  File "/var/lib/juju/agents/unit-router3-2/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 853, in _emit
    self._reemit(event_path)
  File "/var/lib/juju/agents/unit-router3-2/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 942, in _reemit
    custom_handler(event)
  File "/var/lib/juju/agents/unit-router3-2/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router3-2/charm/venv/lib/python3.10/site-packages/common/abstract_charm.py", line 374, in reconcile
    self.set_status(event=event)
  File "/var/lib/juju/agents/unit-router3-2/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router3-2/charm/venv/lib/python3.10/site-packages/common/abstract_charm.py", line 261, in set_status
    self.unit.status = self._determine_unit_status(event=event)
  File "/var/lib/juju/agents/unit-router3-2/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router3-2/charm/venv/lib/python3.10/site-packages/common/abstract_charm.py", line 242, in _determine_unit_status
    if status := workload_.status:
  File "/var/lib/juju/agents/unit-router3-2/charm/venv/lib/python3.10/site-packages/common/workload.py", line 439, in status
    if not self.shell.is_router_in_cluster_set(self._router_id):
  File "/var/lib/juju/agents/unit-router3-2/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 288, in is_router_in_cluster_set
    self._run_code(
  File "/var/lib/juju/agents/unit-router3-2/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 99, in _run_code
    raise ShellDBError(**exception)
common.mysql_shell.ShellDBError: MySQL Error (1040): Dba.get_cluster_set: Too many connections
unit-router3-2: 02:03:21 ERROR juju.worker.uniter.operation hook "database-relation-changed" (via hook dispatching script: dispatch) failed: exit status 1
unit-router6-2: 02:03:48 ERROR unit.router6/2.juju-log backend-database:50: common.mysql_shell:Failed to run MySQL Shell script:
import json
import mysqlsh
import traceback

try:
    # Disable wizards in this script, since it will be invoked without --no-wizard
    shell.options.set('useWizards', False)
    import json

    cluster_set = dba.get_cluster_set()
    routers = cluster_set.list_routers()
    # mysqlsh objects are weirdâ€”they quack (i.e. duck typing) like standard Python objects (e.g. list,
    # dict), but do not serialize to JSON correctly.
    # Cast to str & load from JSON str before serializing
    routers = json.loads(str(routers))
    with open("/tmp/mysqlsh_output.json", "w") as file:
        json.dump(routers, file)
except mysqlsh.DBError as exception:
    error = {
        "message": str(exception),
        "code": exception.code,
        "traceback_message": "".join(traceback.format_exception(exception)),
    }
else:
    error = None
with open("/tmp/mysqlsh_error.json", "w") as file:
    json.dump(error, file)

stderr:
Cannot set LC_ALL to locale en_US.UTF-8: No such file or directory
MySQL Error 1040 (HY000): Too many connections

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router6-2/charm/src/rock.py", line 254, in _run_command
    output, _ = process.wait_output()
  File "/var/lib/juju/agents/unit-router6-2/charm/venv/lib/python3.10/site-packages/ops/pebble.py", line 1441, in wait_output
    raise ExecError[AnyStr](self._command, exit_code, out_value, err_value)
ops.pebble.ExecError: non-zero exit code 1 executing ['mysqlsh', '--passwords-from-stdin', '--uri', 'relation-50_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306', '--python', '--file', '/tmp/mysqlsh_script.py'], stdout="\x1b[1mPlease provide the password for 'relation-50_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306': \x1b[0m", stderr='Cannot set LC_ALL to locale en_US.UTF-8: No such file or directory\nMySQL Error 1040 (HY000): Too many connections\n'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router6-2/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 74, in _run_code
    self._container.run_mysql_shell(
  File "/var/lib/juju/agents/unit-router6-2/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router6-2/charm/venv/lib/python3.10/site-packages/common/container.py", line 236, in run_mysql_shell
    return self._run_command(args, timeout=timeout, input=input)
  File "/var/lib/juju/agents/unit-router6-2/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router6-2/charm/src/rock.py", line 256, in _run_command
    raise common.container.CalledProcessError(
common.container.CalledProcessError: Command '['mysqlsh', '--passwords-from-stdin', '--uri', 'relation-50_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306', '--python', '--file', '/tmp/mysqlsh_script.py']' returned non-zero exit status 1.
unit-router6-2: 02:03:49 ERROR unit.router6/2.juju-log backend-database:50: root:Uncaught exception while in charm code:
Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router6-2/charm/src/rock.py", line 254, in _run_command
    output, _ = process.wait_output()
  File "/var/lib/juju/agents/unit-router6-2/charm/venv/lib/python3.10/site-packages/ops/pebble.py", line 1441, in wait_output
    raise ExecError[AnyStr](self._command, exit_code, out_value, err_value)
ops.pebble.ExecError: non-zero exit code 1 executing ['mysqlsh', '--passwords-from-stdin', '--uri', 'relation-50_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306', '--python', '--file', '/tmp/mysqlsh_script.py'], stdout="\x1b[1mPlease provide the password for 'relation-50_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306': \x1b[0m", stderr='Cannot set LC_ALL to locale en_US.UTF-8: No such file or directory\nMySQL Error 1040 (HY000): Too many connections\n'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router6-2/charm/src/charm.py", line 470, in <module>
    ops.main.main(KubernetesRouterCharm)
  File "/var/lib/juju/agents/unit-router6-2/charm/venv/lib/python3.10/site-packages/ops/main.py", line 436, in main
    _emit_charm_event(charm, dispatcher.event_name)
  File "/var/lib/juju/agents/unit-router6-2/charm/venv/lib/python3.10/site-packages/ops/main.py", line 144, in _emit_charm_event
    event_to_emit.emit(*args, **kwargs)
  File "/var/lib/juju/agents/unit-router6-2/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 351, in emit
    framework._emit(event)
  File "/var/lib/juju/agents/unit-router6-2/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 853, in _emit
    self._reemit(event_path)
  File "/var/lib/juju/agents/unit-router6-2/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 942, in _reemit
    custom_handler(event)
  File "/var/lib/juju/agents/unit-router6-2/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router6-2/charm/venv/lib/python3.10/site-packages/common/abstract_charm.py", line 360, in reconcile
    if not workload_.status:
  File "/var/lib/juju/agents/unit-router6-2/charm/venv/lib/python3.10/site-packages/common/workload.py", line 439, in status
    if not self.shell.is_router_in_cluster_set(self._router_id):
  File "/var/lib/juju/agents/unit-router6-2/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 288, in is_router_in_cluster_set
    self._run_code(
  File "/var/lib/juju/agents/unit-router6-2/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 74, in _run_code
    self._container.run_mysql_shell(
  File "/var/lib/juju/agents/unit-router6-2/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router6-2/charm/venv/lib/python3.10/site-packages/common/container.py", line 236, in run_mysql_shell
    return self._run_command(args, timeout=timeout, input=input)
  File "/var/lib/juju/agents/unit-router6-2/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router6-2/charm/src/rock.py", line 256, in _run_command
    raise common.container.CalledProcessError(
common.container.CalledProcessError: Command '['mysqlsh', '--passwords-from-stdin', '--uri', 'relation-50_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306', '--python', '--file', '/tmp/mysqlsh_script.py']' returned non-zero exit status 1.
unit-router6-2: 02:03:49 ERROR juju.worker.uniter.operation hook "backend-database-relation-joined" (via hook dispatching script: dispatch) failed: exit status 1
unit-router2-1: 02:04:27 ERROR unit.router2/1.juju-log database:43: common.mysql_shell:Failed to run MySQL Shell script:
import json
import mysqlsh
import traceback

try:
    # Disable wizards in this script, since it will be invoked without --no-wizard
    shell.options.set('useWizards', False)
    import json

    cluster_set = dba.get_cluster_set()
    routers = cluster_set.list_routers()
    # mysqlsh objects are weirdâ€”they quack (i.e. duck typing) like standard Python objects (e.g. list,
    # dict), but do not serialize to JSON correctly.
    # Cast to str & load from JSON str before serializing
    routers = json.loads(str(routers))
    with open("/tmp/mysqlsh_output.json", "w") as file:
        json.dump(routers, file)
except mysqlsh.DBError as exception:
    error = {
        "message": str(exception),
        "code": exception.code,
        "traceback_message": "".join(traceback.format_exception(exception)),
    }
else:
    error = None
with open("/tmp/mysqlsh_error.json", "w") as file:
    json.dump(error, file)

MySQL client error 1040
MySQL Shell traceback:
Traceback (most recent call last):
  File "<string>", line 10, in <module>
mysqlsh.DBError: MySQL Error (1040): Dba.get_cluster_set: Too many connections

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router2-1/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 99, in _run_code
    raise ShellDBError(**exception)
common.mysql_shell.ShellDBError: MySQL Error (1040): Dba.get_cluster_set: Too many connections
unit-router2-1: 02:04:27 ERROR unit.router2/1.juju-log database:43: root:Uncaught exception while in charm code:
Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router2-1/charm/src/charm.py", line 470, in <module>
    ops.main.main(KubernetesRouterCharm)
  File "/var/lib/juju/agents/unit-router2-1/charm/venv/lib/python3.10/site-packages/ops/main.py", line 436, in main
    _emit_charm_event(charm, dispatcher.event_name)
  File "/var/lib/juju/agents/unit-router2-1/charm/venv/lib/python3.10/site-packages/ops/main.py", line 144, in _emit_charm_event
    event_to_emit.emit(*args, **kwargs)
  File "/var/lib/juju/agents/unit-router2-1/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 351, in emit
    framework._emit(event)
  File "/var/lib/juju/agents/unit-router2-1/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 853, in _emit
    self._reemit(event_path)
  File "/var/lib/juju/agents/unit-router2-1/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 942, in _reemit
    custom_handler(event)
  File "/var/lib/juju/agents/unit-router2-1/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router2-1/charm/venv/lib/python3.10/site-packages/common/abstract_charm.py", line 374, in reconcile
    self.set_status(event=event)
  File "/var/lib/juju/agents/unit-router2-1/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router2-1/charm/venv/lib/python3.10/site-packages/common/abstract_charm.py", line 261, in set_status
    self.unit.status = self._determine_unit_status(event=event)
  File "/var/lib/juju/agents/unit-router2-1/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router2-1/charm/venv/lib/python3.10/site-packages/common/abstract_charm.py", line 242, in _determine_unit_status
    if status := workload_.status:
  File "/var/lib/juju/agents/unit-router2-1/charm/venv/lib/python3.10/site-packages/common/workload.py", line 439, in status
    if not self.shell.is_router_in_cluster_set(self._router_id):
  File "/var/lib/juju/agents/unit-router2-1/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 288, in is_router_in_cluster_set
    self._run_code(
  File "/var/lib/juju/agents/unit-router2-1/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 99, in _run_code
    raise ShellDBError(**exception)
common.mysql_shell.ShellDBError: MySQL Error (1040): Dba.get_cluster_set: Too many connections
unit-router2-1: 02:04:27 ERROR juju.worker.uniter.operation hook "database-relation-changed" (via hook dispatching script: dispatch) failed: exit status 1
unit-router6-0: 02:04:27 ERROR unit.router6/0.juju-log mysql-router-peers:36: common.mysql_shell:Failed to run MySQL Shell script:
import json
import mysqlsh
import traceback

try:
    # Disable wizards in this script, since it will be invoked without --no-wizard
    shell.options.set('useWizards', False)
    import json

    cluster_set = dba.get_cluster_set()
    routers = cluster_set.list_routers()
    # mysqlsh objects are weirdâ€”they quack (i.e. duck typing) like standard Python objects (e.g. list,
    # dict), but do not serialize to JSON correctly.
    # Cast to str & load from JSON str before serializing
    routers = json.loads(str(routers))
    with open("/tmp/mysqlsh_output.json", "w") as file:
        json.dump(routers, file)
except mysqlsh.DBError as exception:
    error = {
        "message": str(exception),
        "code": exception.code,
        "traceback_message": "".join(traceback.format_exception(exception)),
    }
else:
    error = None
with open("/tmp/mysqlsh_error.json", "w") as file:
    json.dump(error, file)

MySQL client error 1040
MySQL Shell traceback:
Traceback (most recent call last):
  File "<string>", line 10, in <module>
mysqlsh.DBError: MySQL Error (1040): Dba.get_cluster_set: Too many connections

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router6-0/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 99, in _run_code
    raise ShellDBError(**exception)
common.mysql_shell.ShellDBError: MySQL Error (1040): Dba.get_cluster_set: Too many connections
unit-router6-0: 02:04:27 ERROR unit.router6/0.juju-log mysql-router-peers:36: root:Uncaught exception while in charm code:
Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router6-0/charm/src/charm.py", line 470, in <module>
    ops.main.main(KubernetesRouterCharm)
  File "/var/lib/juju/agents/unit-router6-0/charm/venv/lib/python3.10/site-packages/ops/main.py", line 436, in main
    _emit_charm_event(charm, dispatcher.event_name)
  File "/var/lib/juju/agents/unit-router6-0/charm/venv/lib/python3.10/site-packages/ops/main.py", line 144, in _emit_charm_event
    event_to_emit.emit(*args, **kwargs)
  File "/var/lib/juju/agents/unit-router6-0/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 351, in emit
    framework._emit(event)
  File "/var/lib/juju/agents/unit-router6-0/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 853, in _emit
    self._reemit(event_path)
  File "/var/lib/juju/agents/unit-router6-0/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 942, in _reemit
    custom_handler(event)
  File "/var/lib/juju/agents/unit-router6-0/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router6-0/charm/venv/lib/python3.10/site-packages/common/abstract_charm.py", line 374, in reconcile
    self.set_status(event=event)
  File "/var/lib/juju/agents/unit-router6-0/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router6-0/charm/venv/lib/python3.10/site-packages/common/abstract_charm.py", line 261, in set_status
    self.unit.status = self._determine_unit_status(event=event)
  File "/var/lib/juju/agents/unit-router6-0/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router6-0/charm/venv/lib/python3.10/site-packages/common/abstract_charm.py", line 242, in _determine_unit_status
    if status := workload_.status:
  File "/var/lib/juju/agents/unit-router6-0/charm/venv/lib/python3.10/site-packages/common/workload.py", line 439, in status
    if not self.shell.is_router_in_cluster_set(self._router_id):
  File "/var/lib/juju/agents/unit-router6-0/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 288, in is_router_in_cluster_set
    self._run_code(
  File "/var/lib/juju/agents/unit-router6-0/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 99, in _run_code
    raise ShellDBError(**exception)
common.mysql_shell.ShellDBError: MySQL Error (1040): Dba.get_cluster_set: Too many connections
unit-router6-0: 02:04:28 ERROR juju.worker.uniter.operation hook "mysql-router-peers-relation-changed" (via hook dispatching script: dispatch) failed: exit status 1
unit-router0-1: 02:04:50 ERROR unit.router0/1.juju-log cos:7: common.mysql_shell:Failed to run MySQL Shell script:
import json
import mysqlsh
import traceback

try:
    # Disable wizards in this script, since it will be invoked without --no-wizard
    shell.options.set('useWizards', False)
    import json

    cluster_set = dba.get_cluster_set()
    routers = cluster_set.list_routers()
    # mysqlsh objects are weirdâ€”they quack (i.e. duck typing) like standard Python objects (e.g. list,
    # dict), but do not serialize to JSON correctly.
    # Cast to str & load from JSON str before serializing
    routers = json.loads(str(routers))
    with open("/tmp/mysqlsh_output.json", "w") as file:
        json.dump(routers, file)
except mysqlsh.DBError as exception:
    error = {
        "message": str(exception),
        "code": exception.code,
        "traceback_message": "".join(traceback.format_exception(exception)),
    }
else:
    error = None
with open("/tmp/mysqlsh_error.json", "w") as file:
    json.dump(error, file)

MySQL client error 1040
MySQL Shell traceback:
Traceback (most recent call last):
  File "<string>", line 10, in <module>
mysqlsh.DBError: MySQL Error (1040): Dba.get_cluster_set: Too many connections

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router0-1/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 99, in _run_code
    raise ShellDBError(**exception)
common.mysql_shell.ShellDBError: MySQL Error (1040): Dba.get_cluster_set: Too many connections
unit-router2-0: 02:04:50 ERROR unit.router2/0.juju-log tls:15: common.mysql_shell:Failed to run MySQL Shell script:
import json
import mysqlsh
import traceback

try:
    # Disable wizards in this script, since it will be invoked without --no-wizard
    shell.options.set('useWizards', False)
    import json

    cluster_set = dba.get_cluster_set()
    routers = cluster_set.list_routers()
    # mysqlsh objects are weirdâ€”they quack (i.e. duck typing) like standard Python objects (e.g. list,
    # dict), but do not serialize to JSON correctly.
    # Cast to str & load from JSON str before serializing
    routers = json.loads(str(routers))
    with open("/tmp/mysqlsh_output.json", "w") as file:
        json.dump(routers, file)
except mysqlsh.DBError as exception:
    error = {
        "message": str(exception),
        "code": exception.code,
        "traceback_message": "".join(traceback.format_exception(exception)),
    }
else:
    error = None
with open("/tmp/mysqlsh_error.json", "w") as file:
    json.dump(error, file)

MySQL client error 1040
MySQL Shell traceback:
Traceback (most recent call last):
  File "<string>", line 10, in <module>
mysqlsh.DBError: MySQL Error (1040): Dba.get_cluster_set: Too many connections

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router2-0/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 99, in _run_code
    raise ShellDBError(**exception)
common.mysql_shell.ShellDBError: MySQL Error (1040): Dba.get_cluster_set: Too many connections
unit-router0-1: 02:04:50 ERROR unit.router0/1.juju-log cos:7: root:Uncaught exception while in charm code:
Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router0-1/charm/src/charm.py", line 470, in <module>
    ops.main.main(KubernetesRouterCharm)
  File "/var/lib/juju/agents/unit-router0-1/charm/venv/lib/python3.10/site-packages/ops/main.py", line 436, in main
    _emit_charm_event(charm, dispatcher.event_name)
  File "/var/lib/juju/agents/unit-router0-1/charm/venv/lib/python3.10/site-packages/ops/main.py", line 144, in _emit_charm_event
    event_to_emit.emit(*args, **kwargs)
  File "/var/lib/juju/agents/unit-router0-1/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 351, in emit
    framework._emit(event)
  File "/var/lib/juju/agents/unit-router0-1/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 853, in _emit
    self._reemit(event_path)
  File "/var/lib/juju/agents/unit-router0-1/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 942, in _reemit
    custom_handler(event)
  File "/var/lib/juju/agents/unit-router0-1/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router0-1/charm/venv/lib/python3.10/site-packages/common/abstract_charm.py", line 359, in reconcile
    logger.debug(f"{workload_.status=}")
  File "/var/lib/juju/agents/unit-router0-1/charm/venv/lib/python3.10/site-packages/common/workload.py", line 439, in status
    if not self.shell.is_router_in_cluster_set(self._router_id):
  File "/var/lib/juju/agents/unit-router0-1/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 288, in is_router_in_cluster_set
    self._run_code(
  File "/var/lib/juju/agents/unit-router0-1/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 99, in _run_code
    raise ShellDBError(**exception)
common.mysql_shell.ShellDBError: MySQL Error (1040): Dba.get_cluster_set: Too many connections
unit-router2-0: 02:04:50 ERROR unit.router2/0.juju-log tls:15: root:Uncaught exception while in charm code:
Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router2-0/charm/src/charm.py", line 470, in <module>
    ops.main.main(KubernetesRouterCharm)
  File "/var/lib/juju/agents/unit-router2-0/charm/venv/lib/python3.10/site-packages/ops/main.py", line 436, in main
    _emit_charm_event(charm, dispatcher.event_name)
  File "/var/lib/juju/agents/unit-router2-0/charm/venv/lib/python3.10/site-packages/ops/main.py", line 144, in _emit_charm_event
    event_to_emit.emit(*args, **kwargs)
  File "/var/lib/juju/agents/unit-router2-0/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 351, in emit
    framework._emit(event)
  File "/var/lib/juju/agents/unit-router2-0/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 853, in _emit
    self._reemit(event_path)
  File "/var/lib/juju/agents/unit-router2-0/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 942, in _reemit
    custom_handler(event)
  File "/var/lib/juju/agents/unit-router2-0/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router2-0/charm/venv/lib/python3.10/site-packages/common/abstract_charm.py", line 360, in reconcile
    if not workload_.status:
  File "/var/lib/juju/agents/unit-router2-0/charm/venv/lib/python3.10/site-packages/common/workload.py", line 439, in status
    if not self.shell.is_router_in_cluster_set(self._router_id):
  File "/var/lib/juju/agents/unit-router2-0/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 288, in is_router_in_cluster_set
    self._run_code(
  File "/var/lib/juju/agents/unit-router2-0/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 99, in _run_code
    raise ShellDBError(**exception)
common.mysql_shell.ShellDBError: MySQL Error (1040): Dba.get_cluster_set: Too many connections
unit-router1-0: 02:04:51 ERROR unit.router1/0.juju-log refresh-v-three:12: common.mysql_shell:Failed to run MySQL Shell script:
import json
import mysqlsh
import traceback

try:
    # Disable wizards in this script, since it will be invoked without --no-wizard
    shell.options.set('useWizards', False)
    import json

    cluster_set = dba.get_cluster_set()
    routers = cluster_set.list_routers()
    # mysqlsh objects are weirdâ€”they quack (i.e. duck typing) like standard Python objects (e.g. list,
    # dict), but do not serialize to JSON correctly.
    # Cast to str & load from JSON str before serializing
    routers = json.loads(str(routers))
    with open("/tmp/mysqlsh_output.json", "w") as file:
        json.dump(routers, file)
except mysqlsh.DBError as exception:
    error = {
        "message": str(exception),
        "code": exception.code,
        "traceback_message": "".join(traceback.format_exception(exception)),
    }
else:
    error = None
with open("/tmp/mysqlsh_error.json", "w") as file:
    json.dump(error, file)

MySQL client error 1040
MySQL Shell traceback:
Traceback (most recent call last):
  File "<string>", line 10, in <module>
mysqlsh.DBError: MySQL Error (1040): Dba.get_cluster_set: Too many connections

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router1-0/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 99, in _run_code
    raise ShellDBError(**exception)
common.mysql_shell.ShellDBError: MySQL Error (1040): Dba.get_cluster_set: Too many connections
unit-router1-0: 02:04:51 ERROR unit.router1/0.juju-log refresh-v-three:12: root:Uncaught exception while in charm code:
Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router1-0/charm/src/charm.py", line 470, in <module>
    ops.main.main(KubernetesRouterCharm)
  File "/var/lib/juju/agents/unit-router1-0/charm/venv/lib/python3.10/site-packages/ops/main.py", line 436, in main
    _emit_charm_event(charm, dispatcher.event_name)
  File "/var/lib/juju/agents/unit-router1-0/charm/venv/lib/python3.10/site-packages/ops/main.py", line 144, in _emit_charm_event
    event_to_emit.emit(*args, **kwargs)
  File "/var/lib/juju/agents/unit-router1-0/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 351, in emit
    framework._emit(event)
  File "/var/lib/juju/agents/unit-router1-0/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 853, in _emit
    self._reemit(event_path)
  File "/var/lib/juju/agents/unit-router1-0/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 942, in _reemit
    custom_handler(event)
  File "/var/lib/juju/agents/unit-router1-0/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router1-0/charm/venv/lib/python3.10/site-packages/common/abstract_charm.py", line 360, in reconcile
    if not workload_.status:
  File "/var/lib/juju/agents/unit-router1-0/charm/venv/lib/python3.10/site-packages/common/workload.py", line 439, in status
    if not self.shell.is_router_in_cluster_set(self._router_id):
  File "/var/lib/juju/agents/unit-router1-0/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 288, in is_router_in_cluster_set
    self._run_code(
  File "/var/lib/juju/agents/unit-router1-0/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 99, in _run_code
    raise ShellDBError(**exception)
common.mysql_shell.ShellDBError: MySQL Error (1040): Dba.get_cluster_set: Too many connections
unit-router0-1: 02:04:51 ERROR juju.worker.uniter.operation hook "cos-relation-joined" (via hook dispatching script: dispatch) failed: exit status 1
unit-router2-0: 02:04:51 ERROR juju.worker.uniter.operation hook "tls-relation-joined" (via hook dispatching script: dispatch) failed: exit status 1
unit-router1-0: 02:04:51 ERROR juju.worker.uniter.operation hook "refresh-v-three-relation-changed" (via hook dispatching script: dispatch) failed: exit status 1
unit-router4-2: 02:05:09 ERROR unit.router4/2.juju-log tls:25: common.mysql_shell:Failed to run MySQL Shell script:
import json
import mysqlsh
import traceback

try:
    # Disable wizards in this script, since it will be invoked without --no-wizard
    shell.options.set('useWizards', False)
    import json

    cluster_set = dba.get_cluster_set()
    routers = cluster_set.list_routers()
    # mysqlsh objects are weirdâ€”they quack (i.e. duck typing) like standard Python objects (e.g. list,
    # dict), but do not serialize to JSON correctly.
    # Cast to str & load from JSON str before serializing
    routers = json.loads(str(routers))
    with open("/tmp/mysqlsh_output.json", "w") as file:
        json.dump(routers, file)
except mysqlsh.DBError as exception:
    error = {
        "message": str(exception),
        "code": exception.code,
        "traceback_message": "".join(traceback.format_exception(exception)),
    }
else:
    error = None
with open("/tmp/mysqlsh_error.json", "w") as file:
    json.dump(error, file)

MySQL client error 1040
MySQL Shell traceback:
Traceback (most recent call last):
  File "<string>", line 10, in <module>
mysqlsh.DBError: MySQL Error (1040): Dba.get_cluster_set: Too many connections

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router4-2/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 99, in _run_code
    raise ShellDBError(**exception)
common.mysql_shell.ShellDBError: MySQL Error (1040): Dba.get_cluster_set: Too many connections
unit-router4-2: 02:05:09 ERROR unit.router4/2.juju-log tls:25: root:Uncaught exception while in charm code:
Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router4-2/charm/src/charm.py", line 470, in <module>
    ops.main.main(KubernetesRouterCharm)
  File "/var/lib/juju/agents/unit-router4-2/charm/venv/lib/python3.10/site-packages/ops/main.py", line 436, in main
    _emit_charm_event(charm, dispatcher.event_name)
  File "/var/lib/juju/agents/unit-router4-2/charm/venv/lib/python3.10/site-packages/ops/main.py", line 144, in _emit_charm_event
    event_to_emit.emit(*args, **kwargs)
  File "/var/lib/juju/agents/unit-router4-2/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 351, in emit
    framework._emit(event)
  File "/var/lib/juju/agents/unit-router4-2/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 853, in _emit
    self._reemit(event_path)
  File "/var/lib/juju/agents/unit-router4-2/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 942, in _reemit
    custom_handler(event)
  File "/var/lib/juju/agents/unit-router4-2/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router4-2/charm/venv/lib/python3.10/site-packages/common/abstract_charm.py", line 359, in reconcile
    logger.debug(f"{workload_.status=}")
  File "/var/lib/juju/agents/unit-router4-2/charm/venv/lib/python3.10/site-packages/common/workload.py", line 439, in status
    if not self.shell.is_router_in_cluster_set(self._router_id):
  File "/var/lib/juju/agents/unit-router4-2/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 288, in is_router_in_cluster_set
    self._run_code(
  File "/var/lib/juju/agents/unit-router4-2/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 99, in _run_code
    raise ShellDBError(**exception)
common.mysql_shell.ShellDBError: MySQL Error (1040): Dba.get_cluster_set: Too many connections
unit-router4-2: 02:05:10 ERROR juju.worker.uniter.operation hook "tls-relation-changed" (via hook dispatching script: dispatch) failed: exit status 1
unit-router4-1: 02:05:14 ERROR unit.router4/1.juju-log mysql-router-peers:24: common.mysql_shell:Failed to run MySQL Shell script:
import json
import mysqlsh
import traceback

try:
    # Disable wizards in this script, since it will be invoked without --no-wizard
    shell.options.set('useWizards', False)
    import json

    cluster_set = dba.get_cluster_set()
    routers = cluster_set.list_routers()
    # mysqlsh objects are weirdâ€”they quack (i.e. duck typing) like standard Python objects (e.g. list,
    # dict), but do not serialize to JSON correctly.
    # Cast to str & load from JSON str before serializing
    routers = json.loads(str(routers))
    with open("/tmp/mysqlsh_output.json", "w") as file:
        json.dump(routers, file)
except mysqlsh.DBError as exception:
    error = {
        "message": str(exception),
        "code": exception.code,
        "traceback_message": "".join(traceback.format_exception(exception)),
    }
else:
    error = None
with open("/tmp/mysqlsh_error.json", "w") as file:
    json.dump(error, file)

stderr:
Cannot set LC_ALL to locale en_US.UTF-8: No such file or directory
MySQL Error 1040 (HY000): Too many connections

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router4-1/charm/src/rock.py", line 254, in _run_command
    output, _ = process.wait_output()
  File "/var/lib/juju/agents/unit-router4-1/charm/venv/lib/python3.10/site-packages/ops/pebble.py", line 1441, in wait_output
    raise ExecError[AnyStr](self._command, exit_code, out_value, err_value)
ops.pebble.ExecError: non-zero exit code 1 executing ['mysqlsh', '--passwords-from-stdin', '--uri', 'relation-46_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306', '--python', '--file', '/tmp/mysqlsh_script.py'], stdout="\x1b[1mPlease provide the password for 'relation-46_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306': \x1b[0m", stderr='Cannot set LC_ALL to locale en_US.UTF-8: No such file or directory\nMySQL Error 1040 (HY000): Too many connections\n'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router4-1/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 74, in _run_code
    self._container.run_mysql_shell(
  File "/var/lib/juju/agents/unit-router4-1/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router4-1/charm/venv/lib/python3.10/site-packages/common/container.py", line 236, in run_mysql_shell
    return self._run_command(args, timeout=timeout, input=input)
  File "/var/lib/juju/agents/unit-router4-1/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router4-1/charm/src/rock.py", line 256, in _run_command
    raise common.container.CalledProcessError(
common.container.CalledProcessError: Command '['mysqlsh', '--passwords-from-stdin', '--uri', 'relation-46_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306', '--python', '--file', '/tmp/mysqlsh_script.py']' returned non-zero exit status 1.
unit-router4-1: 02:05:14 ERROR unit.router4/1.juju-log mysql-router-peers:24: root:Uncaught exception while in charm code:
Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router4-1/charm/src/rock.py", line 254, in _run_command
    output, _ = process.wait_output()
  File "/var/lib/juju/agents/unit-router4-1/charm/venv/lib/python3.10/site-packages/ops/pebble.py", line 1441, in wait_output
    raise ExecError[AnyStr](self._command, exit_code, out_value, err_value)
ops.pebble.ExecError: non-zero exit code 1 executing ['mysqlsh', '--passwords-from-stdin', '--uri', 'relation-46_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306', '--python', '--file', '/tmp/mysqlsh_script.py'], stdout="\x1b[1mPlease provide the password for 'relation-46_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306': \x1b[0m", stderr='Cannot set LC_ALL to locale en_US.UTF-8: No such file or directory\nMySQL Error 1040 (HY000): Too many connections\n'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router4-1/charm/src/charm.py", line 470, in <module>
    ops.main.main(KubernetesRouterCharm)
  File "/var/lib/juju/agents/unit-router4-1/charm/venv/lib/python3.10/site-packages/ops/main.py", line 436, in main
    _emit_charm_event(charm, dispatcher.event_name)
  File "/var/lib/juju/agents/unit-router4-1/charm/venv/lib/python3.10/site-packages/ops/main.py", line 144, in _emit_charm_event
    event_to_emit.emit(*args, **kwargs)
  File "/var/lib/juju/agents/unit-router4-1/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 351, in emit
    framework._emit(event)
  File "/var/lib/juju/agents/unit-router4-1/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 853, in _emit
    self._reemit(event_path)
  File "/var/lib/juju/agents/unit-router4-1/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 942, in _reemit
    custom_handler(event)
  File "/var/lib/juju/agents/unit-router4-1/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router4-1/charm/venv/lib/python3.10/site-packages/common/abstract_charm.py", line 359, in reconcile
    logger.debug(f"{workload_.status=}")
  File "/var/lib/juju/agents/unit-router4-1/charm/venv/lib/python3.10/site-packages/common/workload.py", line 439, in status
    if not self.shell.is_router_in_cluster_set(self._router_id):
  File "/var/lib/juju/agents/unit-router4-1/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 288, in is_router_in_cluster_set
    self._run_code(
  File "/var/lib/juju/agents/unit-router4-1/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 74, in _run_code
    self._container.run_mysql_shell(
  File "/var/lib/juju/agents/unit-router4-1/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router4-1/charm/venv/lib/python3.10/site-packages/common/container.py", line 236, in run_mysql_shell
    return self._run_command(args, timeout=timeout, input=input)
  File "/var/lib/juju/agents/unit-router4-1/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router4-1/charm/src/rock.py", line 256, in _run_command
    raise common.container.CalledProcessError(
common.container.CalledProcessError: Command '['mysqlsh', '--passwords-from-stdin', '--uri', 'relation-46_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306', '--python', '--file', '/tmp/mysqlsh_script.py']' returned non-zero exit status 1.
unit-router0-0: 02:05:14 ERROR unit.router0/0.juju-log refresh-v-three:5: common.mysql_shell:Failed to run MySQL Shell script:
import json
import mysqlsh
import traceback

try:
    # Disable wizards in this script, since it will be invoked without --no-wizard
    shell.options.set('useWizards', False)
    import json

    cluster_set = dba.get_cluster_set()
    routers = cluster_set.list_routers()
    # mysqlsh objects are weirdâ€”they quack (i.e. duck typing) like standard Python objects (e.g. list,
    # dict), but do not serialize to JSON correctly.
    # Cast to str & load from JSON str before serializing
    routers = json.loads(str(routers))
    with open("/tmp/mysqlsh_output.json", "w") as file:
        json.dump(routers, file)
except mysqlsh.DBError as exception:
    error = {
        "message": str(exception),
        "code": exception.code,
        "traceback_message": "".join(traceback.format_exception(exception)),
    }
else:
    error = None
with open("/tmp/mysqlsh_error.json", "w") as file:
    json.dump(error, file)

stderr:
Cannot set LC_ALL to locale en_US.UTF-8: No such file or directory
MySQL Error 1040 (HY000): Too many connections

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router0-0/charm/src/rock.py", line 254, in _run_command
    output, _ = process.wait_output()
  File "/var/lib/juju/agents/unit-router0-0/charm/venv/lib/python3.10/site-packages/ops/pebble.py", line 1441, in wait_output
    raise ExecError[AnyStr](self._command, exit_code, out_value, err_value)
ops.pebble.ExecError: non-zero exit code 1 executing ['mysqlsh', '--passwords-from-stdin', '--uri', 'relation-38_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306', '--python', '--file', '/tmp/mysqlsh_script.py'], stdout="\x1b[1mPlease provide the password for 'relation-38_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306': \x1b[0m", stderr='Cannot set LC_ALL to locale en_US.UTF-8: No such file or directory\nMySQL Error 1040 (HY000): Too many connections\n'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router0-0/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 74, in _run_code
    self._container.run_mysql_shell(
  File "/var/lib/juju/agents/unit-router0-0/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router0-0/charm/venv/lib/python3.10/site-packages/common/container.py", line 236, in run_mysql_shell
    return self._run_command(args, timeout=timeout, input=input)
  File "/var/lib/juju/agents/unit-router0-0/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router0-0/charm/src/rock.py", line 256, in _run_command
    raise common.container.CalledProcessError(
common.container.CalledProcessError: Command '['mysqlsh', '--passwords-from-stdin', '--uri', 'relation-38_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306', '--python', '--file', '/tmp/mysqlsh_script.py']' returned non-zero exit status 1.
unit-router0-0: 02:05:15 ERROR unit.router0/0.juju-log refresh-v-three:5: root:Uncaught exception while in charm code:
Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router0-0/charm/src/rock.py", line 254, in _run_command
    output, _ = process.wait_output()
  File "/var/lib/juju/agents/unit-router0-0/charm/venv/lib/python3.10/site-packages/ops/pebble.py", line 1441, in wait_output
    raise ExecError[AnyStr](self._command, exit_code, out_value, err_value)
ops.pebble.ExecError: non-zero exit code 1 executing ['mysqlsh', '--passwords-from-stdin', '--uri', 'relation-38_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306', '--python', '--file', '/tmp/mysqlsh_script.py'], stdout="\x1b[1mPlease provide the password for 'relation-38_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306': \x1b[0m", stderr='Cannot set LC_ALL to locale en_US.UTF-8: No such file or directory\nMySQL Error 1040 (HY000): Too many connections\n'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router0-0/charm/src/charm.py", line 470, in <module>
    ops.main.main(KubernetesRouterCharm)
  File "/var/lib/juju/agents/unit-router0-0/charm/venv/lib/python3.10/site-packages/ops/main.py", line 436, in main
    _emit_charm_event(charm, dispatcher.event_name)
  File "/var/lib/juju/agents/unit-router0-0/charm/venv/lib/python3.10/site-packages/ops/main.py", line 144, in _emit_charm_event
    event_to_emit.emit(*args, **kwargs)
  File "/var/lib/juju/agents/unit-router0-0/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 351, in emit
    framework._emit(event)
  File "/var/lib/juju/agents/unit-router0-0/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 853, in _emit
    self._reemit(event_path)
  File "/var/lib/juju/agents/unit-router0-0/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 942, in _reemit
    custom_handler(event)
  File "/var/lib/juju/agents/unit-router0-0/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router0-0/charm/venv/lib/python3.10/site-packages/common/abstract_charm.py", line 360, in reconcile
    if not workload_.status:
  File "/var/lib/juju/agents/unit-router0-0/charm/venv/lib/python3.10/site-packages/common/workload.py", line 439, in status
    if not self.shell.is_router_in_cluster_set(self._router_id):
  File "/var/lib/juju/agents/unit-router0-0/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 288, in is_router_in_cluster_set
    self._run_code(
  File "/var/lib/juju/agents/unit-router0-0/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 74, in _run_code
    self._container.run_mysql_shell(
  File "/var/lib/juju/agents/unit-router0-0/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router0-0/charm/venv/lib/python3.10/site-packages/common/container.py", line 236, in run_mysql_shell
    return self._run_command(args, timeout=timeout, input=input)
  File "/var/lib/juju/agents/unit-router0-0/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router0-0/charm/src/rock.py", line 256, in _run_command
    raise common.container.CalledProcessError(
common.container.CalledProcessError: Command '['mysqlsh', '--passwords-from-stdin', '--uri', 'relation-38_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306', '--python', '--file', '/tmp/mysqlsh_script.py']' returned non-zero exit status 1.
unit-router4-1: 02:05:15 ERROR juju.worker.uniter.operation hook "mysql-router-peers-relation-changed" (via hook dispatching script: dispatch) failed: exit status 1
unit-router0-0: 02:05:15 ERROR juju.worker.uniter.operation hook "refresh-v-three-relation-joined" (via hook dispatching script: dispatch) failed: exit status 1
unit-router4-2: 02:05:43 ERROR unit.router4/2.juju-log tls:25: common.mysql_shell:Failed to run MySQL Shell script:
import json
import mysqlsh
import traceback

try:
    # Disable wizards in this script, since it will be invoked without --no-wizard
    shell.options.set('useWizards', False)
    import json

    cluster_set = dba.get_cluster_set()
    routers = cluster_set.list_routers()
    # mysqlsh objects are weirdâ€”they quack (i.e. duck typing) like standard Python objects (e.g. list,
    # dict), but do not serialize to JSON correctly.
    # Cast to str & load from JSON str before serializing
    routers = json.loads(str(routers))
    with open("/tmp/mysqlsh_output.json", "w") as file:
        json.dump(routers, file)
except mysqlsh.DBError as exception:
    error = {
        "message": str(exception),
        "code": exception.code,
        "traceback_message": "".join(traceback.format_exception(exception)),
    }
else:
    error = None
with open("/tmp/mysqlsh_error.json", "w") as file:
    json.dump(error, file)

MySQL client error 1040
MySQL Shell traceback:
Traceback (most recent call last):
  File "<string>", line 10, in <module>
mysqlsh.DBError: MySQL Error (1040): Dba.get_cluster_set: Too many connections

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router4-2/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 99, in _run_code
    raise ShellDBError(**exception)
common.mysql_shell.ShellDBError: MySQL Error (1040): Dba.get_cluster_set: Too many connections
unit-router4-2: 02:05:43 ERROR unit.router4/2.juju-log tls:25: root:Uncaught exception while in charm code:
Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router4-2/charm/src/charm.py", line 470, in <module>
    ops.main.main(KubernetesRouterCharm)
  File "/var/lib/juju/agents/unit-router4-2/charm/venv/lib/python3.10/site-packages/ops/main.py", line 436, in main
    _emit_charm_event(charm, dispatcher.event_name)
  File "/var/lib/juju/agents/unit-router4-2/charm/venv/lib/python3.10/site-packages/ops/main.py", line 144, in _emit_charm_event
    event_to_emit.emit(*args, **kwargs)
  File "/var/lib/juju/agents/unit-router4-2/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 351, in emit
    framework._emit(event)
  File "/var/lib/juju/agents/unit-router4-2/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 853, in _emit
    self._reemit(event_path)
  File "/var/lib/juju/agents/unit-router4-2/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 942, in _reemit
    custom_handler(event)
  File "/var/lib/juju/agents/unit-router4-2/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router4-2/charm/venv/lib/python3.10/site-packages/common/abstract_charm.py", line 374, in reconcile
    self.set_status(event=event)
  File "/var/lib/juju/agents/unit-router4-2/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router4-2/charm/venv/lib/python3.10/site-packages/common/abstract_charm.py", line 261, in set_status
    self.unit.status = self._determine_unit_status(event=event)
  File "/var/lib/juju/agents/unit-router4-2/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router4-2/charm/venv/lib/python3.10/site-packages/common/abstract_charm.py", line 242, in _determine_unit_status
    if status := workload_.status:
  File "/var/lib/juju/agents/unit-router4-2/charm/venv/lib/python3.10/site-packages/common/workload.py", line 439, in status
    if not self.shell.is_router_in_cluster_set(self._router_id):
  File "/var/lib/juju/agents/unit-router4-2/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 288, in is_router_in_cluster_set
    self._run_code(
  File "/var/lib/juju/agents/unit-router4-2/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 99, in _run_code
    raise ShellDBError(**exception)
common.mysql_shell.ShellDBError: MySQL Error (1040): Dba.get_cluster_set: Too many connections
unit-router4-2: 02:05:43 ERROR juju.worker.uniter.operation hook "tls-relation-changed" (via hook dispatching script: dispatch) failed: exit status 1
unit-router5-2: 02:05:44 ERROR unit.router5/2.juju-log mysql-router-peers:29: common.mysql_shell:Failed to run MySQL Shell script:
import json
import mysqlsh
import traceback

try:
    # Disable wizards in this script, since it will be invoked without --no-wizard
    shell.options.set('useWizards', False)
    import json

    cluster_set = dba.get_cluster_set()
    routers = cluster_set.list_routers()
    # mysqlsh objects are weirdâ€”they quack (i.e. duck typing) like standard Python objects (e.g. list,
    # dict), but do not serialize to JSON correctly.
    # Cast to str & load from JSON str before serializing
    routers = json.loads(str(routers))
    with open("/tmp/mysqlsh_output.json", "w") as file:
        json.dump(routers, file)
except mysqlsh.DBError as exception:
    error = {
        "message": str(exception),
        "code": exception.code,
        "traceback_message": "".join(traceback.format_exception(exception)),
    }
else:
    error = None
with open("/tmp/mysqlsh_error.json", "w") as file:
    json.dump(error, file)

stderr:
Cannot set LC_ALL to locale en_US.UTF-8: No such file or directory
Traceback (most recent call last):
  File "<string>", line 11, in <module>
mysqlsh.Error: Shell Error (51603): ClusterSet.list_routers: Could not connect to PRIMARY of Primary Cluster 'cluster-96066bb55c5fd2bff10a2a8507653dcf'

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router5-2/charm/src/rock.py", line 254, in _run_command
    output, _ = process.wait_output()
  File "/var/lib/juju/agents/unit-router5-2/charm/venv/lib/python3.10/site-packages/ops/pebble.py", line 1441, in wait_output
    raise ExecError[AnyStr](self._command, exit_code, out_value, err_value)
ops.pebble.ExecError: non-zero exit code 1 executing ['mysqlsh', '--passwords-from-stdin', '--uri', 'relation-48_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306', '--python', '--file', '/tmp/mysqlsh_script.py'], stdout="\x1b[1mPlease provide the password for 'relation-48_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306': \x1b[0m", stderr='Cannot set LC_ALL to locale en_US.UTF-8: No such file or directory\nTraceback (most recent call last):\n  File "<string>", line 11, in <module>\nmysqlsh.Error: Shell Error (51603): ClusterSet.list_routers: Could not connect to PRIMARY of Primary Cluster \'cluster-96066bb55c5fd2bff10a2a8507653dcf\'\n'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router5-2/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 74, in _run_code
    self._container.run_mysql_shell(
  File "/var/lib/juju/agents/unit-router5-2/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router5-2/charm/venv/lib/python3.10/site-packages/common/container.py", line 236, in run_mysql_shell
    return self._run_command(args, timeout=timeout, input=input)
  File "/var/lib/juju/agents/unit-router5-2/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router5-2/charm/src/rock.py", line 256, in _run_command
    raise common.container.CalledProcessError(
common.container.CalledProcessError: Command '['mysqlsh', '--passwords-from-stdin', '--uri', 'relation-48_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306', '--python', '--file', '/tmp/mysqlsh_script.py']' returned non-zero exit status 1.
unit-router5-2: 02:05:44 ERROR unit.router5/2.juju-log mysql-router-peers:29: root:Uncaught exception while in charm code:
Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router5-2/charm/src/rock.py", line 254, in _run_command
    output, _ = process.wait_output()
  File "/var/lib/juju/agents/unit-router5-2/charm/venv/lib/python3.10/site-packages/ops/pebble.py", line 1441, in wait_output
    raise ExecError[AnyStr](self._command, exit_code, out_value, err_value)
ops.pebble.ExecError: non-zero exit code 1 executing ['mysqlsh', '--passwords-from-stdin', '--uri', 'relation-48_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306', '--python', '--file', '/tmp/mysqlsh_script.py'], stdout="\x1b[1mPlease provide the password for 'relation-48_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306': \x1b[0m", stderr='Cannot set LC_ALL to locale en_US.UTF-8: No such file or directory\nTraceback (most recent call last):\n  File "<string>", line 11, in <module>\nmysqlsh.Error: Shell Error (51603): ClusterSet.list_routers: Could not connect to PRIMARY of Primary Cluster \'cluster-96066bb55c5fd2bff10a2a8507653dcf\'\n'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router5-2/charm/src/charm.py", line 470, in <module>
    ops.main.main(KubernetesRouterCharm)
  File "/var/lib/juju/agents/unit-router5-2/charm/venv/lib/python3.10/site-packages/ops/main.py", line 436, in main
    _emit_charm_event(charm, dispatcher.event_name)
  File "/var/lib/juju/agents/unit-router5-2/charm/venv/lib/python3.10/site-packages/ops/main.py", line 144, in _emit_charm_event
    event_to_emit.emit(*args, **kwargs)
  File "/var/lib/juju/agents/unit-router5-2/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 351, in emit
    framework._emit(event)
  File "/var/lib/juju/agents/unit-router5-2/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 853, in _emit
    self._reemit(event_path)
  File "/var/lib/juju/agents/unit-router5-2/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 942, in _reemit
    custom_handler(event)
  File "/var/lib/juju/agents/unit-router5-2/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router5-2/charm/venv/lib/python3.10/site-packages/common/abstract_charm.py", line 360, in reconcile
    if not workload_.status:
  File "/var/lib/juju/agents/unit-router5-2/charm/venv/lib/python3.10/site-packages/common/workload.py", line 439, in status
    if not self.shell.is_router_in_cluster_set(self._router_id):
  File "/var/lib/juju/agents/unit-router5-2/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 288, in is_router_in_cluster_set
    self._run_code(
  File "/var/lib/juju/agents/unit-router5-2/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 74, in _run_code
    self._container.run_mysql_shell(
  File "/var/lib/juju/agents/unit-router5-2/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router5-2/charm/venv/lib/python3.10/site-packages/common/container.py", line 236, in run_mysql_shell
    return self._run_command(args, timeout=timeout, input=input)
  File "/var/lib/juju/agents/unit-router5-2/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router5-2/charm/src/rock.py", line 256, in _run_command
    raise common.container.CalledProcessError(
common.container.CalledProcessError: Command '['mysqlsh', '--passwords-from-stdin', '--uri', 'relation-48_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306', '--python', '--file', '/tmp/mysqlsh_script.py']' returned non-zero exit status 1.
unit-router6-0: 02:05:44 ERROR unit.router6/0.juju-log mysql-router-peers:36: common.mysql_shell:Failed to run MySQL Shell script:
import json
import mysqlsh
import traceback

try:
    # Disable wizards in this script, since it will be invoked without --no-wizard
    shell.options.set('useWizards', False)
    import json

    cluster_set = dba.get_cluster_set()
    routers = cluster_set.list_routers()
    # mysqlsh objects are weirdâ€”they quack (i.e. duck typing) like standard Python objects (e.g. list,
    # dict), but do not serialize to JSON correctly.
    # Cast to str & load from JSON str before serializing
    routers = json.loads(str(routers))
    with open("/tmp/mysqlsh_output.json", "w") as file:
        json.dump(routers, file)
except mysqlsh.DBError as exception:
    error = {
        "message": str(exception),
        "code": exception.code,
        "traceback_message": "".join(traceback.format_exception(exception)),
    }
else:
    error = None
with open("/tmp/mysqlsh_error.json", "w") as file:
    json.dump(error, file)

stderr:
Cannot set LC_ALL to locale en_US.UTF-8: No such file or directory
MySQL Error 1040 (HY000): Too many connections

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router6-0/charm/src/rock.py", line 254, in _run_command
    output, _ = process.wait_output()
  File "/var/lib/juju/agents/unit-router6-0/charm/venv/lib/python3.10/site-packages/ops/pebble.py", line 1441, in wait_output
    raise ExecError[AnyStr](self._command, exit_code, out_value, err_value)
ops.pebble.ExecError: non-zero exit code 1 executing ['mysqlsh', '--passwords-from-stdin', '--uri', 'relation-50_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306', '--python', '--file', '/tmp/mysqlsh_script.py'], stdout="\x1b[1mPlease provide the password for 'relation-50_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306': \x1b[0m", stderr='Cannot set LC_ALL to locale en_US.UTF-8: No such file or directory\nMySQL Error 1040 (HY000): Too many connections\n'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router6-0/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 74, in _run_code
    self._container.run_mysql_shell(
  File "/var/lib/juju/agents/unit-router6-0/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router6-0/charm/venv/lib/python3.10/site-packages/common/container.py", line 236, in run_mysql_shell
    return self._run_command(args, timeout=timeout, input=input)
  File "/var/lib/juju/agents/unit-router6-0/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router6-0/charm/src/rock.py", line 256, in _run_command
    raise common.container.CalledProcessError(
common.container.CalledProcessError: Command '['mysqlsh', '--passwords-from-stdin', '--uri', 'relation-50_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306', '--python', '--file', '/tmp/mysqlsh_script.py']' returned non-zero exit status 1.
unit-router5-2: 02:05:44 ERROR juju.worker.uniter.operation hook "mysql-router-peers-relation-joined" (via hook dispatching script: dispatch) failed: exit status 1
unit-router4-0: 02:05:44 ERROR unit.router4/0.juju-log tls:25: common.mysql_shell:Failed to run MySQL Shell script:
import json
import mysqlsh
import traceback

try:
    # Disable wizards in this script, since it will be invoked without --no-wizard
    shell.options.set('useWizards', False)
    import json

    cluster_set = dba.get_cluster_set()
    routers = cluster_set.list_routers()
    # mysqlsh objects are weirdâ€”they quack (i.e. duck typing) like standard Python objects (e.g. list,
    # dict), but do not serialize to JSON correctly.
    # Cast to str & load from JSON str before serializing
    routers = json.loads(str(routers))
    with open("/tmp/mysqlsh_output.json", "w") as file:
        json.dump(routers, file)
except mysqlsh.DBError as exception:
    error = {
        "message": str(exception),
        "code": exception.code,
        "traceback_message": "".join(traceback.format_exception(exception)),
    }
else:
    error = None
with open("/tmp/mysqlsh_error.json", "w") as file:
    json.dump(error, file)

MySQL client error 1040
MySQL Shell traceback:
Traceback (most recent call last):
  File "<string>", line 10, in <module>
mysqlsh.DBError: MySQL Error (1040): Dba.get_cluster_set: Too many connections

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router4-0/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 99, in _run_code
    raise ShellDBError(**exception)
common.mysql_shell.ShellDBError: MySQL Error (1040): Dba.get_cluster_set: Too many connections
unit-router6-0: 02:05:44 ERROR unit.router6/0.juju-log mysql-router-peers:36: root:Uncaught exception while in charm code:
Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router6-0/charm/src/rock.py", line 254, in _run_command
    output, _ = process.wait_output()
  File "/var/lib/juju/agents/unit-router6-0/charm/venv/lib/python3.10/site-packages/ops/pebble.py", line 1441, in wait_output
    raise ExecError[AnyStr](self._command, exit_code, out_value, err_value)
ops.pebble.ExecError: non-zero exit code 1 executing ['mysqlsh', '--passwords-from-stdin', '--uri', 'relation-50_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306', '--python', '--file', '/tmp/mysqlsh_script.py'], stdout="\x1b[1mPlease provide the password for 'relation-50_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306': \x1b[0m", stderr='Cannot set LC_ALL to locale en_US.UTF-8: No such file or directory\nMySQL Error 1040 (HY000): Too many connections\n'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router6-0/charm/src/charm.py", line 470, in <module>
    ops.main.main(KubernetesRouterCharm)
  File "/var/lib/juju/agents/unit-router6-0/charm/venv/lib/python3.10/site-packages/ops/main.py", line 436, in main
    _emit_charm_event(charm, dispatcher.event_name)
  File "/var/lib/juju/agents/unit-router6-0/charm/venv/lib/python3.10/site-packages/ops/main.py", line 144, in _emit_charm_event
    event_to_emit.emit(*args, **kwargs)
  File "/var/lib/juju/agents/unit-router6-0/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 351, in emit
    framework._emit(event)
  File "/var/lib/juju/agents/unit-router6-0/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 853, in _emit
    self._reemit(event_path)
  File "/var/lib/juju/agents/unit-router6-0/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 942, in _reemit
    custom_handler(event)
  File "/var/lib/juju/agents/unit-router6-0/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router6-0/charm/venv/lib/python3.10/site-packages/common/abstract_charm.py", line 359, in reconcile
    logger.debug(f"{workload_.status=}")
  File "/var/lib/juju/agents/unit-router6-0/charm/venv/lib/python3.10/site-packages/common/workload.py", line 439, in status
    if not self.shell.is_router_in_cluster_set(self._router_id):
  File "/var/lib/juju/agents/unit-router6-0/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 288, in is_router_in_cluster_set
    self._run_code(
  File "/var/lib/juju/agents/unit-router6-0/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 74, in _run_code
    self._container.run_mysql_shell(
  File "/var/lib/juju/agents/unit-router6-0/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router6-0/charm/venv/lib/python3.10/site-packages/common/container.py", line 236, in run_mysql_shell
    return self._run_command(args, timeout=timeout, input=input)
  File "/var/lib/juju/agents/unit-router6-0/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router6-0/charm/src/rock.py", line 256, in _run_command
    raise common.container.CalledProcessError(
common.container.CalledProcessError: Command '['mysqlsh', '--passwords-from-stdin', '--uri', 'relation-50_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306', '--python', '--file', '/tmp/mysqlsh_script.py']' returned non-zero exit status 1.
unit-router4-0: 02:05:44 ERROR unit.router4/0.juju-log tls:25: root:Uncaught exception while in charm code:
Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router4-0/charm/src/charm.py", line 470, in <module>
    ops.main.main(KubernetesRouterCharm)
  File "/var/lib/juju/agents/unit-router4-0/charm/venv/lib/python3.10/site-packages/ops/main.py", line 436, in main
    _emit_charm_event(charm, dispatcher.event_name)
  File "/var/lib/juju/agents/unit-router4-0/charm/venv/lib/python3.10/site-packages/ops/main.py", line 144, in _emit_charm_event
    event_to_emit.emit(*args, **kwargs)
  File "/var/lib/juju/agents/unit-router4-0/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 351, in emit
    framework._emit(event)
  File "/var/lib/juju/agents/unit-router4-0/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 853, in _emit
    self._reemit(event_path)
  File "/var/lib/juju/agents/unit-router4-0/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 942, in _reemit
    custom_handler(event)
  File "/var/lib/juju/agents/unit-router4-0/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router4-0/charm/venv/lib/python3.10/site-packages/common/abstract_charm.py", line 359, in reconcile
    logger.debug(f"{workload_.status=}")
  File "/var/lib/juju/agents/unit-router4-0/charm/venv/lib/python3.10/site-packages/common/workload.py", line 439, in status
    if not self.shell.is_router_in_cluster_set(self._router_id):
  File "/var/lib/juju/agents/unit-router4-0/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 288, in is_router_in_cluster_set
    self._run_code(
  File "/var/lib/juju/agents/unit-router4-0/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 99, in _run_code
    raise ShellDBError(**exception)
common.mysql_shell.ShellDBError: MySQL Error (1040): Dba.get_cluster_set: Too many connections
unit-router1-1: 02:05:45 ERROR unit.router1/1.juju-log refresh-v-three:12: common.mysql_shell:Failed to run MySQL Shell script:
import json
import mysqlsh
import traceback

try:
    # Disable wizards in this script, since it will be invoked without --no-wizard
    shell.options.set('useWizards', False)
    import json

    cluster_set = dba.get_cluster_set()
    routers = cluster_set.list_routers()
    # mysqlsh objects are weirdâ€”they quack (i.e. duck typing) like standard Python objects (e.g. list,
    # dict), but do not serialize to JSON correctly.
    # Cast to str & load from JSON str before serializing
    routers = json.loads(str(routers))
    with open("/tmp/mysqlsh_output.json", "w") as file:
        json.dump(routers, file)
except mysqlsh.DBError as exception:
    error = {
        "message": str(exception),
        "code": exception.code,
        "traceback_message": "".join(traceback.format_exception(exception)),
    }
else:
    error = None
with open("/tmp/mysqlsh_error.json", "w") as file:
    json.dump(error, file)

stderr:
Cannot set LC_ALL to locale en_US.UTF-8: No such file or directory
[33mWARNING: [0mCould not connect to any member of cluster 'cluster-96066bb55c5fd2bff10a2a8507653dcf': MySQL Error 1040 (HY000): Too many connections
Traceback (most recent call last):
  File "<string>", line 11, in <module>
mysqlsh.Error: Shell Error (51603): ClusterSet.list_routers: Could not connect to PRIMARY of Primary Cluster 'cluster-96066bb55c5fd2bff10a2a8507653dcf'

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router1-1/charm/src/rock.py", line 254, in _run_command
    output, _ = process.wait_output()
  File "/var/lib/juju/agents/unit-router1-1/charm/venv/lib/python3.10/site-packages/ops/pebble.py", line 1441, in wait_output
    raise ExecError[AnyStr](self._command, exit_code, out_value, err_value)
ops.pebble.ExecError: non-zero exit code 1 executing ['mysqlsh', '--passwords-from-stdin', '--uri', 'relation-40_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306', '--python', '--file', '/tmp/mysqlsh_script.py'], stdout="\x1b[1mPlease provide the password for 'relation-40_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306': \x1b[0m", stderr='Cannot set LC_ALL to locale en_US.UTF-8: No such file or directory\n\x1b[33mWARNING: \x1b[0mCould not connect to any member of cluster \'cluster-96066bb55c5fd2bff10a2a8507653dcf\': MySQL Error 1040 (HY000): Too many connections\nTraceback (most recent call last):\n  File "<string>", line 11, in <module>\nmysqlsh.Error: Shell Error (51603): ClusterSet.list_routers: Could not connect to PRIMARY of Primary Cluster \'cluster-96066bb55c5fd2bff10a2a8507653dcf\'\n'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router1-1/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 74, in _run_code
    self._container.run_mysql_shell(
  File "/var/lib/juju/agents/unit-router1-1/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router1-1/charm/venv/lib/python3.10/site-packages/common/container.py", line 236, in run_mysql_shell
    return self._run_command(args, timeout=timeout, input=input)
  File "/var/lib/juju/agents/unit-router1-1/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router1-1/charm/src/rock.py", line 256, in _run_command
    raise common.container.CalledProcessError(
common.container.CalledProcessError: Command '['mysqlsh', '--passwords-from-stdin', '--uri', 'relation-40_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306', '--python', '--file', '/tmp/mysqlsh_script.py']' returned non-zero exit status 1.
unit-router1-1: 02:05:45 ERROR unit.router1/1.juju-log refresh-v-three:12: root:Uncaught exception while in charm code:
Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router1-1/charm/src/rock.py", line 254, in _run_command
    output, _ = process.wait_output()
  File "/var/lib/juju/agents/unit-router1-1/charm/venv/lib/python3.10/site-packages/ops/pebble.py", line 1441, in wait_output
    raise ExecError[AnyStr](self._command, exit_code, out_value, err_value)
ops.pebble.ExecError: non-zero exit code 1 executing ['mysqlsh', '--passwords-from-stdin', '--uri', 'relation-40_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306', '--python', '--file', '/tmp/mysqlsh_script.py'], stdout="\x1b[1mPlease provide the password for 'relation-40_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306': \x1b[0m", stderr='Cannot set LC_ALL to locale en_US.UTF-8: No such file or directory\n\x1b[33mWARNING: \x1b[0mCould not connect to any member of cluster \'cluster-96066bb55c5fd2bff10a2a8507653dcf\': MySQL Error 1040 (HY000): Too many connections\nTraceback (most recent call last):\n  File "<string>", line 11, in <module>\nmysqlsh.Error: Shell Error (51603): ClusterSet.list_routers: Could not connect to PRIMARY of Primary Cluster \'cluster-96066bb55c5fd2bff10a2a8507653dcf\'\n'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router1-1/charm/src/charm.py", line 470, in <module>
    ops.main.main(KubernetesRouterCharm)
  File "/var/lib/juju/agents/unit-router1-1/charm/venv/lib/python3.10/site-packages/ops/main.py", line 436, in main
    _emit_charm_event(charm, dispatcher.event_name)
  File "/var/lib/juju/agents/unit-router1-1/charm/venv/lib/python3.10/site-packages/ops/main.py", line 144, in _emit_charm_event
    event_to_emit.emit(*args, **kwargs)
  File "/var/lib/juju/agents/unit-router1-1/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 351, in emit
    framework._emit(event)
  File "/var/lib/juju/agents/unit-router1-1/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 853, in _emit
    self._reemit(event_path)
  File "/var/lib/juju/agents/unit-router1-1/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 942, in _reemit
    custom_handler(event)
  File "/var/lib/juju/agents/unit-router1-1/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router1-1/charm/venv/lib/python3.10/site-packages/common/abstract_charm.py", line 374, in reconcile
    self.set_status(event=event)
  File "/var/lib/juju/agents/unit-router1-1/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router1-1/charm/venv/lib/python3.10/site-packages/common/abstract_charm.py", line 261, in set_status
    self.unit.status = self._determine_unit_status(event=event)
  File "/var/lib/juju/agents/unit-router1-1/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router1-1/charm/venv/lib/python3.10/site-packages/common/abstract_charm.py", line 242, in _determine_unit_status
    if status := workload_.status:
  File "/var/lib/juju/agents/unit-router1-1/charm/venv/lib/python3.10/site-packages/common/workload.py", line 439, in status
    if not self.shell.is_router_in_cluster_set(self._router_id):
  File "/var/lib/juju/agents/unit-router1-1/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 288, in is_router_in_cluster_set
    self._run_code(
  File "/var/lib/juju/agents/unit-router1-1/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 74, in _run_code
    self._container.run_mysql_shell(
  File "/var/lib/juju/agents/unit-router1-1/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router1-1/charm/venv/lib/python3.10/site-packages/common/container.py", line 236, in run_mysql_shell
    return self._run_command(args, timeout=timeout, input=input)
  File "/var/lib/juju/agents/unit-router1-1/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router1-1/charm/src/rock.py", line 256, in _run_command
    raise common.container.CalledProcessError(
common.container.CalledProcessError: Command '['mysqlsh', '--passwords-from-stdin', '--uri', 'relation-40_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306', '--python', '--file', '/tmp/mysqlsh_script.py']' returned non-zero exit status 1.
unit-router4-0: 02:05:45 ERROR juju.worker.uniter.operation hook "tls-relation-changed" (via hook dispatching script: dispatch) failed: exit status 1
unit-router6-0: 02:05:45 ERROR juju.worker.uniter.operation hook "mysql-router-peers-relation-joined" (via hook dispatching script: dispatch) failed: exit status 1
unit-router1-1: 02:05:45 ERROR juju.worker.uniter.operation hook "refresh-v-three-relation-changed" (via hook dispatching script: dispatch) failed: exit status 1
unit-router3-2: 02:06:10 ERROR unit.router3/2.juju-log cos:21: common.mysql_shell:Failed to run MySQL Shell script:
import json
import mysqlsh
import traceback

try:
    # Disable wizards in this script, since it will be invoked without --no-wizard
    shell.options.set('useWizards', False)
    import json

    cluster_set = dba.get_cluster_set()
    routers = cluster_set.list_routers()
    # mysqlsh objects are weirdâ€”they quack (i.e. duck typing) like standard Python objects (e.g. list,
    # dict), but do not serialize to JSON correctly.
    # Cast to str & load from JSON str before serializing
    routers = json.loads(str(routers))
    with open("/tmp/mysqlsh_output.json", "w") as file:
        json.dump(routers, file)
except mysqlsh.DBError as exception:
    error = {
        "message": str(exception),
        "code": exception.code,
        "traceback_message": "".join(traceback.format_exception(exception)),
    }
else:
    error = None
with open("/tmp/mysqlsh_error.json", "w") as file:
    json.dump(error, file)

MySQL client error 1040
MySQL Shell traceback:
Traceback (most recent call last):
  File "<string>", line 10, in <module>
mysqlsh.DBError: MySQL Error (1040): Dba.get_cluster_set: Too many connections

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router3-2/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 99, in _run_code
    raise ShellDBError(**exception)
common.mysql_shell.ShellDBError: MySQL Error (1040): Dba.get_cluster_set: Too many connections
unit-router2-0: 02:06:10 ERROR unit.router2/0.juju-log mysql-router-peers:14: common.mysql_shell:Failed to run MySQL Shell script:
import json
import mysqlsh
import traceback

try:
    # Disable wizards in this script, since it will be invoked without --no-wizard
    shell.options.set('useWizards', False)
    import json

    cluster_set = dba.get_cluster_set()
    routers = cluster_set.list_routers()
    # mysqlsh objects are weirdâ€”they quack (i.e. duck typing) like standard Python objects (e.g. list,
    # dict), but do not serialize to JSON correctly.
    # Cast to str & load from JSON str before serializing
    routers = json.loads(str(routers))
    with open("/tmp/mysqlsh_output.json", "w") as file:
        json.dump(routers, file)
except mysqlsh.DBError as exception:
    error = {
        "message": str(exception),
        "code": exception.code,
        "traceback_message": "".join(traceback.format_exception(exception)),
    }
else:
    error = None
with open("/tmp/mysqlsh_error.json", "w") as file:
    json.dump(error, file)

MySQL client error 1040
MySQL Shell traceback:
Traceback (most recent call last):
  File "<string>", line 10, in <module>
mysqlsh.DBError: MySQL Error (1040): Dba.get_cluster_set: Too many connections

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router2-0/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 99, in _run_code
    raise ShellDBError(**exception)
common.mysql_shell.ShellDBError: MySQL Error (1040): Dba.get_cluster_set: Too many connections
unit-router3-2: 02:06:10 ERROR unit.router3/2.juju-log cos:21: root:Uncaught exception while in charm code:
Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router3-2/charm/src/charm.py", line 470, in <module>
    ops.main.main(KubernetesRouterCharm)
  File "/var/lib/juju/agents/unit-router3-2/charm/venv/lib/python3.10/site-packages/ops/main.py", line 436, in main
    _emit_charm_event(charm, dispatcher.event_name)
  File "/var/lib/juju/agents/unit-router3-2/charm/venv/lib/python3.10/site-packages/ops/main.py", line 144, in _emit_charm_event
    event_to_emit.emit(*args, **kwargs)
  File "/var/lib/juju/agents/unit-router3-2/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 351, in emit
    framework._emit(event)
  File "/var/lib/juju/agents/unit-router3-2/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 853, in _emit
    self._reemit(event_path)
  File "/var/lib/juju/agents/unit-router3-2/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 942, in _reemit
    custom_handler(event)
  File "/var/lib/juju/agents/unit-router3-2/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router3-2/charm/venv/lib/python3.10/site-packages/common/abstract_charm.py", line 374, in reconcile
    self.set_status(event=event)
  File "/var/lib/juju/agents/unit-router3-2/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router3-2/charm/venv/lib/python3.10/site-packages/common/abstract_charm.py", line 261, in set_status
    self.unit.status = self._determine_unit_status(event=event)
  File "/var/lib/juju/agents/unit-router3-2/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router3-2/charm/venv/lib/python3.10/site-packages/common/abstract_charm.py", line 242, in _determine_unit_status
    if status := workload_.status:
  File "/var/lib/juju/agents/unit-router3-2/charm/venv/lib/python3.10/site-packages/common/workload.py", line 439, in status
    if not self.shell.is_router_in_cluster_set(self._router_id):
  File "/var/lib/juju/agents/unit-router3-2/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 288, in is_router_in_cluster_set
    self._run_code(
  File "/var/lib/juju/agents/unit-router3-2/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 99, in _run_code
    raise ShellDBError(**exception)
common.mysql_shell.ShellDBError: MySQL Error (1040): Dba.get_cluster_set: Too many connections
unit-router2-0: 02:06:10 ERROR unit.router2/0.juju-log mysql-router-peers:14: root:Uncaught exception while in charm code:
Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router2-0/charm/src/charm.py", line 470, in <module>
    ops.main.main(KubernetesRouterCharm)
  File "/var/lib/juju/agents/unit-router2-0/charm/venv/lib/python3.10/site-packages/ops/main.py", line 436, in main
    _emit_charm_event(charm, dispatcher.event_name)
  File "/var/lib/juju/agents/unit-router2-0/charm/venv/lib/python3.10/site-packages/ops/main.py", line 144, in _emit_charm_event
    event_to_emit.emit(*args, **kwargs)
  File "/var/lib/juju/agents/unit-router2-0/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 351, in emit
    framework._emit(event)
  File "/var/lib/juju/agents/unit-router2-0/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 853, in _emit
    self._reemit(event_path)
  File "/var/lib/juju/agents/unit-router2-0/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 942, in _reemit
    custom_handler(event)
  File "/var/lib/juju/agents/unit-router2-0/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router2-0/charm/venv/lib/python3.10/site-packages/common/abstract_charm.py", line 359, in reconcile
    logger.debug(f"{workload_.status=}")
  File "/var/lib/juju/agents/unit-router2-0/charm/venv/lib/python3.10/site-packages/common/workload.py", line 439, in status
    if not self.shell.is_router_in_cluster_set(self._router_id):
  File "/var/lib/juju/agents/unit-router2-0/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 288, in is_router_in_cluster_set
    self._run_code(
  File "/var/lib/juju/agents/unit-router2-0/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 99, in _run_code
    raise ShellDBError(**exception)
common.mysql_shell.ShellDBError: MySQL Error (1040): Dba.get_cluster_set: Too many connections
unit-router2-2: 02:06:10 ERROR unit.router2/2.juju-log mysql-router-peers:14: common.mysql_shell:Failed to run MySQL Shell script:
import json
import mysqlsh
import traceback

try:
    # Disable wizards in this script, since it will be invoked without --no-wizard
    shell.options.set('useWizards', False)
    import json

    cluster_set = dba.get_cluster_set()
    routers = cluster_set.list_routers()
    # mysqlsh objects are weirdâ€”they quack (i.e. duck typing) like standard Python objects (e.g. list,
    # dict), but do not serialize to JSON correctly.
    # Cast to str & load from JSON str before serializing
    routers = json.loads(str(routers))
    with open("/tmp/mysqlsh_output.json", "w") as file:
        json.dump(routers, file)
except mysqlsh.DBError as exception:
    error = {
        "message": str(exception),
        "code": exception.code,
        "traceback_message": "".join(traceback.format_exception(exception)),
    }
else:
    error = None
with open("/tmp/mysqlsh_error.json", "w") as file:
    json.dump(error, file)

stderr:
Cannot set LC_ALL to locale en_US.UTF-8: No such file or directory
Traceback (most recent call last):
  File "<string>", line 11, in <module>
mysqlsh.Error: Shell Error (51603): ClusterSet.list_routers: Could not connect to PRIMARY of Primary Cluster 'cluster-96066bb55c5fd2bff10a2a8507653dcf'

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router2-2/charm/src/rock.py", line 254, in _run_command
    output, _ = process.wait_output()
  File "/var/lib/juju/agents/unit-router2-2/charm/venv/lib/python3.10/site-packages/ops/pebble.py", line 1441, in wait_output
    raise ExecError[AnyStr](self._command, exit_code, out_value, err_value)
ops.pebble.ExecError: non-zero exit code 1 executing ['mysqlsh', '--passwords-from-stdin', '--uri', 'relation-42_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306', '--python', '--file', '/tmp/mysqlsh_script.py'], stdout="\x1b[1mPlease provide the password for 'relation-42_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306': \x1b[0m", stderr='Cannot set LC_ALL to locale en_US.UTF-8: No such file or directory\nTraceback (most recent call last):\n  File "<string>", line 11, in <module>\nmysqlsh.Error: Shell Error (51603): ClusterSet.list_routers: Could not connect to PRIMARY of Primary Cluster \'cluster-96066bb55c5fd2bff10a2a8507653dcf\'\n'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router2-2/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 74, in _run_code
    self._container.run_mysql_shell(
  File "/var/lib/juju/agents/unit-router2-2/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router2-2/charm/venv/lib/python3.10/site-packages/common/container.py", line 236, in run_mysql_shell
    return self._run_command(args, timeout=timeout, input=input)
  File "/var/lib/juju/agents/unit-router2-2/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router2-2/charm/src/rock.py", line 256, in _run_command
    raise common.container.CalledProcessError(
common.container.CalledProcessError: Command '['mysqlsh', '--passwords-from-stdin', '--uri', 'relation-42_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306', '--python', '--file', '/tmp/mysqlsh_script.py']' returned non-zero exit status 1.
unit-router2-2: 02:06:10 ERROR unit.router2/2.juju-log mysql-router-peers:14: root:Uncaught exception while in charm code:
Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router2-2/charm/src/rock.py", line 254, in _run_command
    output, _ = process.wait_output()
  File "/var/lib/juju/agents/unit-router2-2/charm/venv/lib/python3.10/site-packages/ops/pebble.py", line 1441, in wait_output
    raise ExecError[AnyStr](self._command, exit_code, out_value, err_value)
ops.pebble.ExecError: non-zero exit code 1 executing ['mysqlsh', '--passwords-from-stdin', '--uri', 'relation-42_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306', '--python', '--file', '/tmp/mysqlsh_script.py'], stdout="\x1b[1mPlease provide the password for 'relation-42_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306': \x1b[0m", stderr='Cannot set LC_ALL to locale en_US.UTF-8: No such file or directory\nTraceback (most recent call last):\n  File "<string>", line 11, in <module>\nmysqlsh.Error: Shell Error (51603): ClusterSet.list_routers: Could not connect to PRIMARY of Primary Cluster \'cluster-96066bb55c5fd2bff10a2a8507653dcf\'\n'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router2-2/charm/src/charm.py", line 470, in <module>
    ops.main.main(KubernetesRouterCharm)
  File "/var/lib/juju/agents/unit-router2-2/charm/venv/lib/python3.10/site-packages/ops/main.py", line 436, in main
    _emit_charm_event(charm, dispatcher.event_name)
  File "/var/lib/juju/agents/unit-router2-2/charm/venv/lib/python3.10/site-packages/ops/main.py", line 144, in _emit_charm_event
    event_to_emit.emit(*args, **kwargs)
  File "/var/lib/juju/agents/unit-router2-2/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 351, in emit
    framework._emit(event)
  File "/var/lib/juju/agents/unit-router2-2/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 853, in _emit
    self._reemit(event_path)
  File "/var/lib/juju/agents/unit-router2-2/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 942, in _reemit
    custom_handler(event)
  File "/var/lib/juju/agents/unit-router2-2/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router2-2/charm/venv/lib/python3.10/site-packages/common/abstract_charm.py", line 360, in reconcile
    if not workload_.status:
  File "/var/lib/juju/agents/unit-router2-2/charm/venv/lib/python3.10/site-packages/common/workload.py", line 439, in status
    if not self.shell.is_router_in_cluster_set(self._router_id):
  File "/var/lib/juju/agents/unit-router2-2/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 288, in is_router_in_cluster_set
    self._run_code(
  File "/var/lib/juju/agents/unit-router2-2/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 74, in _run_code
    self._container.run_mysql_shell(
  File "/var/lib/juju/agents/unit-router2-2/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router2-2/charm/venv/lib/python3.10/site-packages/common/container.py", line 236, in run_mysql_shell
    return self._run_command(args, timeout=timeout, input=input)
  File "/var/lib/juju/agents/unit-router2-2/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router2-2/charm/src/rock.py", line 256, in _run_command
    raise common.container.CalledProcessError(
common.container.CalledProcessError: Command '['mysqlsh', '--passwords-from-stdin', '--uri', 'relation-42_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306', '--python', '--file', '/tmp/mysqlsh_script.py']' returned non-zero exit status 1.
unit-router3-2: 02:06:10 ERROR juju.worker.uniter.operation hook "cos-relation-joined" (via hook dispatching script: dispatch) failed: exit status 1
unit-router2-0: 02:06:10 ERROR juju.worker.uniter.operation hook "mysql-router-peers-relation-changed" (via hook dispatching script: dispatch) failed: exit status 1
unit-router2-2: 02:06:11 ERROR juju.worker.uniter.operation hook "mysql-router-peers-relation-joined" (via hook dispatching script: dispatch) failed: exit status 1
unit-router5-1: 02:06:15 ERROR unit.router5/1.juju-log refresh-v-three:32: common.mysql_shell:Failed to run MySQL Shell script:
import json
import mysqlsh
import traceback

try:
    # Disable wizards in this script, since it will be invoked without --no-wizard
    shell.options.set('useWizards', False)
    import json

    cluster_set = dba.get_cluster_set()
    routers = cluster_set.list_routers()
    # mysqlsh objects are weirdâ€”they quack (i.e. duck typing) like standard Python objects (e.g. list,
    # dict), but do not serialize to JSON correctly.
    # Cast to str & load from JSON str before serializing
    routers = json.loads(str(routers))
    with open("/tmp/mysqlsh_output.json", "w") as file:
        json.dump(routers, file)
except mysqlsh.DBError as exception:
    error = {
        "message": str(exception),
        "code": exception.code,
        "traceback_message": "".join(traceback.format_exception(exception)),
    }
else:
    error = None
with open("/tmp/mysqlsh_error.json", "w") as file:
    json.dump(error, file)

MySQL client error 1040
MySQL Shell traceback:
Traceback (most recent call last):
  File "<string>", line 10, in <module>
mysqlsh.DBError: MySQL Error (1040): Dba.get_cluster_set: Too many connections

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router5-1/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 99, in _run_code
    raise ShellDBError(**exception)
common.mysql_shell.ShellDBError: MySQL Error (1040): Dba.get_cluster_set: Too many connections
unit-router5-1: 02:06:15 ERROR unit.router5/1.juju-log refresh-v-three:32: root:Uncaught exception while in charm code:
Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router5-1/charm/src/charm.py", line 470, in <module>
    ops.main.main(KubernetesRouterCharm)
  File "/var/lib/juju/agents/unit-router5-1/charm/venv/lib/python3.10/site-packages/ops/main.py", line 436, in main
    _emit_charm_event(charm, dispatcher.event_name)
  File "/var/lib/juju/agents/unit-router5-1/charm/venv/lib/python3.10/site-packages/ops/main.py", line 144, in _emit_charm_event
    event_to_emit.emit(*args, **kwargs)
  File "/var/lib/juju/agents/unit-router5-1/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 351, in emit
    framework._emit(event)
  File "/var/lib/juju/agents/unit-router5-1/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 853, in _emit
    self._reemit(event_path)
  File "/var/lib/juju/agents/unit-router5-1/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 942, in _reemit
    custom_handler(event)
  File "/var/lib/juju/agents/unit-router5-1/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router5-1/charm/venv/lib/python3.10/site-packages/common/abstract_charm.py", line 374, in reconcile
    self.set_status(event=event)
  File "/var/lib/juju/agents/unit-router5-1/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router5-1/charm/venv/lib/python3.10/site-packages/common/abstract_charm.py", line 261, in set_status
    self.unit.status = self._determine_unit_status(event=event)
  File "/var/lib/juju/agents/unit-router5-1/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router5-1/charm/venv/lib/python3.10/site-packages/common/abstract_charm.py", line 242, in _determine_unit_status
    if status := workload_.status:
  File "/var/lib/juju/agents/unit-router5-1/charm/venv/lib/python3.10/site-packages/common/workload.py", line 439, in status
    if not self.shell.is_router_in_cluster_set(self._router_id):
  File "/var/lib/juju/agents/unit-router5-1/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 288, in is_router_in_cluster_set
    self._run_code(
  File "/var/lib/juju/agents/unit-router5-1/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 99, in _run_code
    raise ShellDBError(**exception)
common.mysql_shell.ShellDBError: MySQL Error (1040): Dba.get_cluster_set: Too many connections
unit-router6-0: 02:06:15 ERROR unit.router6/0.juju-log mysql-router-peers:36: common.mysql_shell:Failed to run MySQL Shell script:
import json
import mysqlsh
import traceback

try:
    # Disable wizards in this script, since it will be invoked without --no-wizard
    shell.options.set('useWizards', False)
    import json

    cluster_set = dba.get_cluster_set()
    routers = cluster_set.list_routers()
    # mysqlsh objects are weirdâ€”they quack (i.e. duck typing) like standard Python objects (e.g. list,
    # dict), but do not serialize to JSON correctly.
    # Cast to str & load from JSON str before serializing
    routers = json.loads(str(routers))
    with open("/tmp/mysqlsh_output.json", "w") as file:
        json.dump(routers, file)
except mysqlsh.DBError as exception:
    error = {
        "message": str(exception),
        "code": exception.code,
        "traceback_message": "".join(traceback.format_exception(exception)),
    }
else:
    error = None
with open("/tmp/mysqlsh_error.json", "w") as file:
    json.dump(error, file)

stderr:
Cannot set LC_ALL to locale en_US.UTF-8: No such file or directory
MySQL Error 1040 (HY000): Too many connections

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router6-0/charm/src/rock.py", line 254, in _run_command
    output, _ = process.wait_output()
  File "/var/lib/juju/agents/unit-router6-0/charm/venv/lib/python3.10/site-packages/ops/pebble.py", line 1441, in wait_output
    raise ExecError[AnyStr](self._command, exit_code, out_value, err_value)
ops.pebble.ExecError: non-zero exit code 1 executing ['mysqlsh', '--passwords-from-stdin', '--uri', 'relation-50_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306', '--python', '--file', '/tmp/mysqlsh_script.py'], stdout="\x1b[1mPlease provide the password for 'relation-50_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306': \x1b[0m", stderr='Cannot set LC_ALL to locale en_US.UTF-8: No such file or directory\nMySQL Error 1040 (HY000): Too many connections\n'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router6-0/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 74, in _run_code
    self._container.run_mysql_shell(
  File "/var/lib/juju/agents/unit-router6-0/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router6-0/charm/venv/lib/python3.10/site-packages/common/container.py", line 236, in run_mysql_shell
    return self._run_command(args, timeout=timeout, input=input)
  File "/var/lib/juju/agents/unit-router6-0/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router6-0/charm/src/rock.py", line 256, in _run_command
    raise common.container.CalledProcessError(
common.container.CalledProcessError: Command '['mysqlsh', '--passwords-from-stdin', '--uri', 'relation-50_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306', '--python', '--file', '/tmp/mysqlsh_script.py']' returned non-zero exit status 1.
unit-router6-0: 02:06:16 ERROR unit.router6/0.juju-log mysql-router-peers:36: root:Uncaught exception while in charm code:
Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router6-0/charm/src/rock.py", line 254, in _run_command
    output, _ = process.wait_output()
  File "/var/lib/juju/agents/unit-router6-0/charm/venv/lib/python3.10/site-packages/ops/pebble.py", line 1441, in wait_output
    raise ExecError[AnyStr](self._command, exit_code, out_value, err_value)
ops.pebble.ExecError: non-zero exit code 1 executing ['mysqlsh', '--passwords-from-stdin', '--uri', 'relation-50_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306', '--python', '--file', '/tmp/mysqlsh_script.py'], stdout="\x1b[1mPlease provide the password for 'relation-50_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306': \x1b[0m", stderr='Cannot set LC_ALL to locale en_US.UTF-8: No such file or directory\nMySQL Error 1040 (HY000): Too many connections\n'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router6-0/charm/src/charm.py", line 470, in <module>
    ops.main.main(KubernetesRouterCharm)
  File "/var/lib/juju/agents/unit-router6-0/charm/venv/lib/python3.10/site-packages/ops/main.py", line 436, in main
    _emit_charm_event(charm, dispatcher.event_name)
  File "/var/lib/juju/agents/unit-router6-0/charm/venv/lib/python3.10/site-packages/ops/main.py", line 144, in _emit_charm_event
    event_to_emit.emit(*args, **kwargs)
  File "/var/lib/juju/agents/unit-router6-0/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 351, in emit
    framework._emit(event)
  File "/var/lib/juju/agents/unit-router6-0/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 853, in _emit
    self._reemit(event_path)
  File "/var/lib/juju/agents/unit-router6-0/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 942, in _reemit
    custom_handler(event)
  File "/var/lib/juju/agents/unit-router6-0/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router6-0/charm/venv/lib/python3.10/site-packages/common/abstract_charm.py", line 359, in reconcile
    logger.debug(f"{workload_.status=}")
  File "/var/lib/juju/agents/unit-router6-0/charm/venv/lib/python3.10/site-packages/common/workload.py", line 439, in status
    if not self.shell.is_router_in_cluster_set(self._router_id):
  File "/var/lib/juju/agents/unit-router6-0/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 288, in is_router_in_cluster_set
    self._run_code(
  File "/var/lib/juju/agents/unit-router6-0/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 74, in _run_code
    self._container.run_mysql_shell(
  File "/var/lib/juju/agents/unit-router6-0/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router6-0/charm/venv/lib/python3.10/site-packages/common/container.py", line 236, in run_mysql_shell
    return self._run_command(args, timeout=timeout, input=input)
  File "/var/lib/juju/agents/unit-router6-0/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router6-0/charm/src/rock.py", line 256, in _run_command
    raise common.container.CalledProcessError(
common.container.CalledProcessError: Command '['mysqlsh', '--passwords-from-stdin', '--uri', 'relation-50_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306', '--python', '--file', '/tmp/mysqlsh_script.py']' returned non-zero exit status 1.
unit-router5-1: 02:06:16 ERROR juju.worker.uniter.operation hook "refresh-v-three-relation-joined" (via hook dispatching script: dispatch) failed: exit status 1
unit-router4-2: 02:06:16 ERROR unit.router4/2.juju-log tls:25: common.mysql_shell:Failed to run MySQL Shell script:
import json
import mysqlsh
import traceback

try:
    # Disable wizards in this script, since it will be invoked without --no-wizard
    shell.options.set('useWizards', False)
    import json

    cluster_set = dba.get_cluster_set()
    routers = cluster_set.list_routers()
    # mysqlsh objects are weirdâ€”they quack (i.e. duck typing) like standard Python objects (e.g. list,
    # dict), but do not serialize to JSON correctly.
    # Cast to str & load from JSON str before serializing
    routers = json.loads(str(routers))
    with open("/tmp/mysqlsh_output.json", "w") as file:
        json.dump(routers, file)
except mysqlsh.DBError as exception:
    error = {
        "message": str(exception),
        "code": exception.code,
        "traceback_message": "".join(traceback.format_exception(exception)),
    }
else:
    error = None
with open("/tmp/mysqlsh_error.json", "w") as file:
    json.dump(error, file)

MySQL client error 1040
MySQL Shell traceback:
Traceback (most recent call last):
  File "<string>", line 11, in <module>
mysqlsh.DBError: MySQL Error (1040): ClusterSet.list_routers: Too many connections

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router4-2/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 99, in _run_code
    raise ShellDBError(**exception)
common.mysql_shell.ShellDBError: MySQL Error (1040): ClusterSet.list_routers: Too many connections
unit-router4-2: 02:06:16 ERROR unit.router4/2.juju-log tls:25: root:Uncaught exception while in charm code:
Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router4-2/charm/src/charm.py", line 470, in <module>
    ops.main.main(KubernetesRouterCharm)
  File "/var/lib/juju/agents/unit-router4-2/charm/venv/lib/python3.10/site-packages/ops/main.py", line 436, in main
    _emit_charm_event(charm, dispatcher.event_name)
  File "/var/lib/juju/agents/unit-router4-2/charm/venv/lib/python3.10/site-packages/ops/main.py", line 144, in _emit_charm_event
    event_to_emit.emit(*args, **kwargs)
  File "/var/lib/juju/agents/unit-router4-2/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 351, in emit
    framework._emit(event)
  File "/var/lib/juju/agents/unit-router4-2/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 853, in _emit
    self._reemit(event_path)
  File "/var/lib/juju/agents/unit-router4-2/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 942, in _reemit
    custom_handler(event)
  File "/var/lib/juju/agents/unit-router4-2/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router4-2/charm/venv/lib/python3.10/site-packages/common/abstract_charm.py", line 359, in reconcile
    logger.debug(f"{workload_.status=}")
  File "/var/lib/juju/agents/unit-router4-2/charm/venv/lib/python3.10/site-packages/common/workload.py", line 439, in status
    if not self.shell.is_router_in_cluster_set(self._router_id):
  File "/var/lib/juju/agents/unit-router4-2/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 288, in is_router_in_cluster_set
    self._run_code(
  File "/var/lib/juju/agents/unit-router4-2/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 99, in _run_code
    raise ShellDBError(**exception)
common.mysql_shell.ShellDBError: MySQL Error (1040): ClusterSet.list_routers: Too many connections
unit-router5-2: 02:06:16 ERROR unit.router5/2.juju-log mysql-router-peers:29: common.mysql_shell:Failed to run MySQL Shell script:
import json
import mysqlsh
import traceback

try:
    # Disable wizards in this script, since it will be invoked without --no-wizard
    shell.options.set('useWizards', False)
    import json

    cluster_set = dba.get_cluster_set()
    routers = cluster_set.list_routers()
    # mysqlsh objects are weirdâ€”they quack (i.e. duck typing) like standard Python objects (e.g. list,
    # dict), but do not serialize to JSON correctly.
    # Cast to str & load from JSON str before serializing
    routers = json.loads(str(routers))
    with open("/tmp/mysqlsh_output.json", "w") as file:
        json.dump(routers, file)
except mysqlsh.DBError as exception:
    error = {
        "message": str(exception),
        "code": exception.code,
        "traceback_message": "".join(traceback.format_exception(exception)),
    }
else:
    error = None
with open("/tmp/mysqlsh_error.json", "w") as file:
    json.dump(error, file)

stderr:
Cannot set LC_ALL to locale en_US.UTF-8: No such file or directory
Traceback (most recent call last):
  File "<string>", line 11, in <module>
mysqlsh.Error: Shell Error (51603): ClusterSet.list_routers: Could not connect to PRIMARY of Primary Cluster 'cluster-96066bb55c5fd2bff10a2a8507653dcf'

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router5-2/charm/src/rock.py", line 254, in _run_command
    output, _ = process.wait_output()
  File "/var/lib/juju/agents/unit-router5-2/charm/venv/lib/python3.10/site-packages/ops/pebble.py", line 1441, in wait_output
    raise ExecError[AnyStr](self._command, exit_code, out_value, err_value)
ops.pebble.ExecError: non-zero exit code 1 executing ['mysqlsh', '--passwords-from-stdin', '--uri', 'relation-48_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306', '--python', '--file', '/tmp/mysqlsh_script.py'], stdout="\x1b[1mPlease provide the password for 'relation-48_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306': \x1b[0m", stderr='Cannot set LC_ALL to locale en_US.UTF-8: No such file or directory\nTraceback (most recent call last):\n  File "<string>", line 11, in <module>\nmysqlsh.Error: Shell Error (51603): ClusterSet.list_routers: Could not connect to PRIMARY of Primary Cluster \'cluster-96066bb55c5fd2bff10a2a8507653dcf\'\n'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router5-2/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 74, in _run_code
    self._container.run_mysql_shell(
  File "/var/lib/juju/agents/unit-router5-2/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router5-2/charm/venv/lib/python3.10/site-packages/common/container.py", line 236, in run_mysql_shell
    return self._run_command(args, timeout=timeout, input=input)
  File "/var/lib/juju/agents/unit-router5-2/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router5-2/charm/src/rock.py", line 256, in _run_command
    raise common.container.CalledProcessError(
common.container.CalledProcessError: Command '['mysqlsh', '--passwords-from-stdin', '--uri', 'relation-48_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306', '--python', '--file', '/tmp/mysqlsh_script.py']' returned non-zero exit status 1.
unit-router6-0: 02:06:16 ERROR juju.worker.uniter.operation hook "mysql-router-peers-relation-joined" (via hook dispatching script: dispatch) failed: exit status 1
unit-router5-2: 02:06:16 ERROR unit.router5/2.juju-log mysql-router-peers:29: root:Uncaught exception while in charm code:
Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router5-2/charm/src/rock.py", line 254, in _run_command
    output, _ = process.wait_output()
  File "/var/lib/juju/agents/unit-router5-2/charm/venv/lib/python3.10/site-packages/ops/pebble.py", line 1441, in wait_output
    raise ExecError[AnyStr](self._command, exit_code, out_value, err_value)
ops.pebble.ExecError: non-zero exit code 1 executing ['mysqlsh', '--passwords-from-stdin', '--uri', 'relation-48_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306', '--python', '--file', '/tmp/mysqlsh_script.py'], stdout="\x1b[1mPlease provide the password for 'relation-48_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306': \x1b[0m", stderr='Cannot set LC_ALL to locale en_US.UTF-8: No such file or directory\nTraceback (most recent call last):\n  File "<string>", line 11, in <module>\nmysqlsh.Error: Shell Error (51603): ClusterSet.list_routers: Could not connect to PRIMARY of Primary Cluster \'cluster-96066bb55c5fd2bff10a2a8507653dcf\'\n'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router5-2/charm/src/charm.py", line 470, in <module>
    ops.main.main(KubernetesRouterCharm)
  File "/var/lib/juju/agents/unit-router5-2/charm/venv/lib/python3.10/site-packages/ops/main.py", line 436, in main
    _emit_charm_event(charm, dispatcher.event_name)
  File "/var/lib/juju/agents/unit-router5-2/charm/venv/lib/python3.10/site-packages/ops/main.py", line 144, in _emit_charm_event
    event_to_emit.emit(*args, **kwargs)
  File "/var/lib/juju/agents/unit-router5-2/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 351, in emit
    framework._emit(event)
  File "/var/lib/juju/agents/unit-router5-2/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 853, in _emit
    self._reemit(event_path)
  File "/var/lib/juju/agents/unit-router5-2/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 942, in _reemit
    custom_handler(event)
  File "/var/lib/juju/agents/unit-router5-2/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router5-2/charm/venv/lib/python3.10/site-packages/common/abstract_charm.py", line 359, in reconcile
    logger.debug(f"{workload_.status=}")
  File "/var/lib/juju/agents/unit-router5-2/charm/venv/lib/python3.10/site-packages/common/workload.py", line 439, in status
    if not self.shell.is_router_in_cluster_set(self._router_id):
  File "/var/lib/juju/agents/unit-router5-2/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 288, in is_router_in_cluster_set
    self._run_code(
  File "/var/lib/juju/agents/unit-router5-2/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 74, in _run_code
    self._container.run_mysql_shell(
  File "/var/lib/juju/agents/unit-router5-2/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router5-2/charm/venv/lib/python3.10/site-packages/common/container.py", line 236, in run_mysql_shell
    return self._run_command(args, timeout=timeout, input=input)
  File "/var/lib/juju/agents/unit-router5-2/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router5-2/charm/src/rock.py", line 256, in _run_command
    raise common.container.CalledProcessError(
common.container.CalledProcessError: Command '['mysqlsh', '--passwords-from-stdin', '--uri', 'relation-48_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306', '--python', '--file', '/tmp/mysqlsh_script.py']' returned non-zero exit status 1.
unit-router3-1: 02:06:16 ERROR unit.router3/1.juju-log cos:21: common.mysql_shell:Failed to run MySQL Shell script:
import json
import mysqlsh
import traceback

try:
    # Disable wizards in this script, since it will be invoked without --no-wizard
    shell.options.set('useWizards', False)
    import json

    cluster_set = dba.get_cluster_set()
    routers = cluster_set.list_routers()
    # mysqlsh objects are weirdâ€”they quack (i.e. duck typing) like standard Python objects (e.g. list,
    # dict), but do not serialize to JSON correctly.
    # Cast to str & load from JSON str before serializing
    routers = json.loads(str(routers))
    with open("/tmp/mysqlsh_output.json", "w") as file:
        json.dump(routers, file)
except mysqlsh.DBError as exception:
    error = {
        "message": str(exception),
        "code": exception.code,
        "traceback_message": "".join(traceback.format_exception(exception)),
    }
else:
    error = None
with open("/tmp/mysqlsh_error.json", "w") as file:
    json.dump(error, file)

stderr:
Cannot set LC_ALL to locale en_US.UTF-8: No such file or directory
Traceback (most recent call last):
  File "<string>", line 11, in <module>
mysqlsh.Error: Shell Error (51603): ClusterSet.list_routers: Could not connect to PRIMARY of Primary Cluster 'cluster-96066bb55c5fd2bff10a2a8507653dcf'

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router3-1/charm/src/rock.py", line 254, in _run_command
    output, _ = process.wait_output()
  File "/var/lib/juju/agents/unit-router3-1/charm/venv/lib/python3.10/site-packages/ops/pebble.py", line 1441, in wait_output
    raise ExecError[AnyStr](self._command, exit_code, out_value, err_value)
ops.pebble.ExecError: non-zero exit code 1 executing ['mysqlsh', '--passwords-from-stdin', '--uri', 'relation-44_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306', '--python', '--file', '/tmp/mysqlsh_script.py'], stdout="\x1b[1mPlease provide the password for 'relation-44_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306': \x1b[0m", stderr='Cannot set LC_ALL to locale en_US.UTF-8: No such file or directory\nTraceback (most recent call last):\n  File "<string>", line 11, in <module>\nmysqlsh.Error: Shell Error (51603): ClusterSet.list_routers: Could not connect to PRIMARY of Primary Cluster \'cluster-96066bb55c5fd2bff10a2a8507653dcf\'\n'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router3-1/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 74, in _run_code
    self._container.run_mysql_shell(
  File "/var/lib/juju/agents/unit-router3-1/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router3-1/charm/venv/lib/python3.10/site-packages/common/container.py", line 236, in run_mysql_shell
    return self._run_command(args, timeout=timeout, input=input)
  File "/var/lib/juju/agents/unit-router3-1/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router3-1/charm/src/rock.py", line 256, in _run_command
    raise common.container.CalledProcessError(
common.container.CalledProcessError: Command '['mysqlsh', '--passwords-from-stdin', '--uri', 'relation-44_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306', '--python', '--file', '/tmp/mysqlsh_script.py']' returned non-zero exit status 1.
unit-router3-1: 02:06:16 ERROR unit.router3/1.juju-log cos:21: root:Uncaught exception while in charm code:
Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router3-1/charm/src/rock.py", line 254, in _run_command
    output, _ = process.wait_output()
  File "/var/lib/juju/agents/unit-router3-1/charm/venv/lib/python3.10/site-packages/ops/pebble.py", line 1441, in wait_output
    raise ExecError[AnyStr](self._command, exit_code, out_value, err_value)
ops.pebble.ExecError: non-zero exit code 1 executing ['mysqlsh', '--passwords-from-stdin', '--uri', 'relation-44_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306', '--python', '--file', '/tmp/mysqlsh_script.py'], stdout="\x1b[1mPlease provide the password for 'relation-44_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306': \x1b[0m", stderr='Cannot set LC_ALL to locale en_US.UTF-8: No such file or directory\nTraceback (most recent call last):\n  File "<string>", line 11, in <module>\nmysqlsh.Error: Shell Error (51603): ClusterSet.list_routers: Could not connect to PRIMARY of Primary Cluster \'cluster-96066bb55c5fd2bff10a2a8507653dcf\'\n'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router3-1/charm/src/charm.py", line 470, in <module>
    ops.main.main(KubernetesRouterCharm)
  File "/var/lib/juju/agents/unit-router3-1/charm/venv/lib/python3.10/site-packages/ops/main.py", line 436, in main
    _emit_charm_event(charm, dispatcher.event_name)
  File "/var/lib/juju/agents/unit-router3-1/charm/venv/lib/python3.10/site-packages/ops/main.py", line 144, in _emit_charm_event
    event_to_emit.emit(*args, **kwargs)
  File "/var/lib/juju/agents/unit-router3-1/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 351, in emit
    framework._emit(event)
  File "/var/lib/juju/agents/unit-router3-1/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 853, in _emit
    self._reemit(event_path)
  File "/var/lib/juju/agents/unit-router3-1/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 942, in _reemit
    custom_handler(event)
  File "/var/lib/juju/agents/unit-router3-1/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router3-1/charm/venv/lib/python3.10/site-packages/common/abstract_charm.py", line 374, in reconcile
    self.set_status(event=event)
  File "/var/lib/juju/agents/unit-router3-1/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router3-1/charm/venv/lib/python3.10/site-packages/common/abstract_charm.py", line 261, in set_status
    self.unit.status = self._determine_unit_status(event=event)
  File "/var/lib/juju/agents/unit-router3-1/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router3-1/charm/venv/lib/python3.10/site-packages/common/abstract_charm.py", line 242, in _determine_unit_status
    if status := workload_.status:
  File "/var/lib/juju/agents/unit-router3-1/charm/venv/lib/python3.10/site-packages/common/workload.py", line 439, in status
    if not self.shell.is_router_in_cluster_set(self._router_id):
  File "/var/lib/juju/agents/unit-router3-1/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 288, in is_router_in_cluster_set
    self._run_code(
  File "/var/lib/juju/agents/unit-router3-1/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 74, in _run_code
    self._container.run_mysql_shell(
  File "/var/lib/juju/agents/unit-router3-1/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router3-1/charm/venv/lib/python3.10/site-packages/common/container.py", line 236, in run_mysql_shell
    return self._run_command(args, timeout=timeout, input=input)
  File "/var/lib/juju/agents/unit-router3-1/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router3-1/charm/src/rock.py", line 256, in _run_command
    raise common.container.CalledProcessError(
common.container.CalledProcessError: Command '['mysqlsh', '--passwords-from-stdin', '--uri', 'relation-44_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306', '--python', '--file', '/tmp/mysqlsh_script.py']' returned non-zero exit status 1.
unit-router2-1: 02:06:17 ERROR unit.router2/1.juju-log cos:16: common.mysql_shell:Failed to run MySQL Shell script:
import json
import mysqlsh
import traceback

try:
    # Disable wizards in this script, since it will be invoked without --no-wizard
    shell.options.set('useWizards', False)
    import json

    cluster_set = dba.get_cluster_set()
    routers = cluster_set.list_routers()
    # mysqlsh objects are weirdâ€”they quack (i.e. duck typing) like standard Python objects (e.g. list,
    # dict), but do not serialize to JSON correctly.
    # Cast to str & load from JSON str before serializing
    routers = json.loads(str(routers))
    with open("/tmp/mysqlsh_output.json", "w") as file:
        json.dump(routers, file)
except mysqlsh.DBError as exception:
    error = {
        "message": str(exception),
        "code": exception.code,
        "traceback_message": "".join(traceback.format_exception(exception)),
    }
else:
    error = None
with open("/tmp/mysqlsh_error.json", "w") as file:
    json.dump(error, file)

stderr:
Cannot set LC_ALL to locale en_US.UTF-8: No such file or directory
[33mWARNING: [0mCould not connect to any member of cluster 'cluster-96066bb55c5fd2bff10a2a8507653dcf': MySQL Error 1040 (HY000): Too many connections
Traceback (most recent call last):
  File "<string>", line 11, in <module>
mysqlsh.Error: Shell Error (51603): ClusterSet.list_routers: Could not connect to PRIMARY of Primary Cluster 'cluster-96066bb55c5fd2bff10a2a8507653dcf'

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router2-1/charm/src/rock.py", line 254, in _run_command
    output, _ = process.wait_output()
  File "/var/lib/juju/agents/unit-router2-1/charm/venv/lib/python3.10/site-packages/ops/pebble.py", line 1441, in wait_output
    raise ExecError[AnyStr](self._command, exit_code, out_value, err_value)
ops.pebble.ExecError: non-zero exit code 1 executing ['mysqlsh', '--passwords-from-stdin', '--uri', 'relation-42_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306', '--python', '--file', '/tmp/mysqlsh_script.py'], stdout="\x1b[1mPlease provide the password for 'relation-42_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306': \x1b[0m", stderr='Cannot set LC_ALL to locale en_US.UTF-8: No such file or directory\n\x1b[33mWARNING: \x1b[0mCould not connect to any member of cluster \'cluster-96066bb55c5fd2bff10a2a8507653dcf\': MySQL Error 1040 (HY000): Too many connections\nTraceback (most recent call last):\n  File "<string>", line 11, in <module>\nmysqlsh.Error: Shell Error (51603): ClusterSet.list_routers: Could not connect to PRIMARY of Primary Cluster \'cluster-96066bb55c5fd2bff10a2a8507653dcf\'\n'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router2-1/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 74, in _run_code
    self._container.run_mysql_shell(
  File "/var/lib/juju/agents/unit-router2-1/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router2-1/charm/venv/lib/python3.10/site-packages/common/container.py", line 236, in run_mysql_shell
    return self._run_command(args, timeout=timeout, input=input)
  File "/var/lib/juju/agents/unit-router2-1/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router2-1/charm/src/rock.py", line 256, in _run_command
    raise common.container.CalledProcessError(
common.container.CalledProcessError: Command '['mysqlsh', '--passwords-from-stdin', '--uri', 'relation-42_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306', '--python', '--file', '/tmp/mysqlsh_script.py']' returned non-zero exit status 1.
unit-router2-1: 02:06:17 ERROR unit.router2/1.juju-log cos:16: root:Uncaught exception while in charm code:
Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router2-1/charm/src/rock.py", line 254, in _run_command
    output, _ = process.wait_output()
  File "/var/lib/juju/agents/unit-router2-1/charm/venv/lib/python3.10/site-packages/ops/pebble.py", line 1441, in wait_output
    raise ExecError[AnyStr](self._command, exit_code, out_value, err_value)
ops.pebble.ExecError: non-zero exit code 1 executing ['mysqlsh', '--passwords-from-stdin', '--uri', 'relation-42_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306', '--python', '--file', '/tmp/mysqlsh_script.py'], stdout="\x1b[1mPlease provide the password for 'relation-42_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306': \x1b[0m", stderr='Cannot set LC_ALL to locale en_US.UTF-8: No such file or directory\n\x1b[33mWARNING: \x1b[0mCould not connect to any member of cluster \'cluster-96066bb55c5fd2bff10a2a8507653dcf\': MySQL Error 1040 (HY000): Too many connections\nTraceback (most recent call last):\n  File "<string>", line 11, in <module>\nmysqlsh.Error: Shell Error (51603): ClusterSet.list_routers: Could not connect to PRIMARY of Primary Cluster \'cluster-96066bb55c5fd2bff10a2a8507653dcf\'\n'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router2-1/charm/src/charm.py", line 470, in <module>
    ops.main.main(KubernetesRouterCharm)
  File "/var/lib/juju/agents/unit-router2-1/charm/venv/lib/python3.10/site-packages/ops/main.py", line 436, in main
    _emit_charm_event(charm, dispatcher.event_name)
  File "/var/lib/juju/agents/unit-router2-1/charm/venv/lib/python3.10/site-packages/ops/main.py", line 144, in _emit_charm_event
    event_to_emit.emit(*args, **kwargs)
  File "/var/lib/juju/agents/unit-router2-1/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 351, in emit
    framework._emit(event)
  File "/var/lib/juju/agents/unit-router2-1/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 853, in _emit
    self._reemit(event_path)
  File "/var/lib/juju/agents/unit-router2-1/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 942, in _reemit
    custom_handler(event)
  File "/var/lib/juju/agents/unit-router2-1/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router2-1/charm/venv/lib/python3.10/site-packages/common/abstract_charm.py", line 374, in reconcile
    self.set_status(event=event)
  File "/var/lib/juju/agents/unit-router2-1/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router2-1/charm/venv/lib/python3.10/site-packages/common/abstract_charm.py", line 261, in set_status
    self.unit.status = self._determine_unit_status(event=event)
  File "/var/lib/juju/agents/unit-router2-1/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router2-1/charm/venv/lib/python3.10/site-packages/common/abstract_charm.py", line 242, in _determine_unit_status
    if status := workload_.status:
  File "/var/lib/juju/agents/unit-router2-1/charm/venv/lib/python3.10/site-packages/common/workload.py", line 439, in status
    if not self.shell.is_router_in_cluster_set(self._router_id):
  File "/var/lib/juju/agents/unit-router2-1/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 288, in is_router_in_cluster_set
    self._run_code(
  File "/var/lib/juju/agents/unit-router2-1/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 74, in _run_code
    self._container.run_mysql_shell(
  File "/var/lib/juju/agents/unit-router2-1/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router2-1/charm/venv/lib/python3.10/site-packages/common/container.py", line 236, in run_mysql_shell
    return self._run_command(args, timeout=timeout, input=input)
  File "/var/lib/juju/agents/unit-router2-1/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router2-1/charm/src/rock.py", line 256, in _run_command
    raise common.container.CalledProcessError(
common.container.CalledProcessError: Command '['mysqlsh', '--passwords-from-stdin', '--uri', 'relation-42_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306', '--python', '--file', '/tmp/mysqlsh_script.py']' returned non-zero exit status 1.
unit-router4-0: 02:06:17 ERROR unit.router4/0.juju-log tls:25: common.mysql_shell:Failed to run MySQL Shell script:
import json
import mysqlsh
import traceback

try:
    # Disable wizards in this script, since it will be invoked without --no-wizard
    shell.options.set('useWizards', False)
    import json

    cluster_set = dba.get_cluster_set()
    routers = cluster_set.list_routers()
    # mysqlsh objects are weirdâ€”they quack (i.e. duck typing) like standard Python objects (e.g. list,
    # dict), but do not serialize to JSON correctly.
    # Cast to str & load from JSON str before serializing
    routers = json.loads(str(routers))
    with open("/tmp/mysqlsh_output.json", "w") as file:
        json.dump(routers, file)
except mysqlsh.DBError as exception:
    error = {
        "message": str(exception),
        "code": exception.code,
        "traceback_message": "".join(traceback.format_exception(exception)),
    }
else:
    error = None
with open("/tmp/mysqlsh_error.json", "w") as file:
    json.dump(error, file)

stderr:
Cannot set LC_ALL to locale en_US.UTF-8: No such file or directory
Traceback (most recent call last):
  File "<string>", line 11, in <module>
mysqlsh.Error: Shell Error (51603): ClusterSet.list_routers: Could not connect to PRIMARY of Primary Cluster 'cluster-96066bb55c5fd2bff10a2a8507653dcf'

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router4-0/charm/src/rock.py", line 254, in _run_command
    output, _ = process.wait_output()
  File "/var/lib/juju/agents/unit-router4-0/charm/venv/lib/python3.10/site-packages/ops/pebble.py", line 1441, in wait_output
    raise ExecError[AnyStr](self._command, exit_code, out_value, err_value)
ops.pebble.ExecError: non-zero exit code 1 executing ['mysqlsh', '--passwords-from-stdin', '--uri', 'relation-46_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306', '--python', '--file', '/tmp/mysqlsh_script.py'], stdout="\x1b[1mPlease provide the password for 'relation-46_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306': \x1b[0m", stderr='Cannot set LC_ALL to locale en_US.UTF-8: No such file or directory\nTraceback (most recent call last):\n  File "<string>", line 11, in <module>\nmysqlsh.Error: Shell Error (51603): ClusterSet.list_routers: Could not connect to PRIMARY of Primary Cluster \'cluster-96066bb55c5fd2bff10a2a8507653dcf\'\n'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router4-0/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 74, in _run_code
    self._container.run_mysql_shell(
  File "/var/lib/juju/agents/unit-router4-0/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router4-0/charm/venv/lib/python3.10/site-packages/common/container.py", line 236, in run_mysql_shell
    return self._run_command(args, timeout=timeout, input=input)
  File "/var/lib/juju/agents/unit-router4-0/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router4-0/charm/src/rock.py", line 256, in _run_command
    raise common.container.CalledProcessError(
common.container.CalledProcessError: Command '['mysqlsh', '--passwords-from-stdin', '--uri', 'relation-46_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306', '--python', '--file', '/tmp/mysqlsh_script.py']' returned non-zero exit status 1.
unit-router4-0: 02:06:17 ERROR unit.router4/0.juju-log tls:25: root:Uncaught exception while in charm code:
Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router4-0/charm/src/rock.py", line 254, in _run_command
    output, _ = process.wait_output()
  File "/var/lib/juju/agents/unit-router4-0/charm/venv/lib/python3.10/site-packages/ops/pebble.py", line 1441, in wait_output
    raise ExecError[AnyStr](self._command, exit_code, out_value, err_value)
ops.pebble.ExecError: non-zero exit code 1 executing ['mysqlsh', '--passwords-from-stdin', '--uri', 'relation-46_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306', '--python', '--file', '/tmp/mysqlsh_script.py'], stdout="\x1b[1mPlease provide the password for 'relation-46_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306': \x1b[0m", stderr='Cannot set LC_ALL to locale en_US.UTF-8: No such file or directory\nTraceback (most recent call last):\n  File "<string>", line 11, in <module>\nmysqlsh.Error: Shell Error (51603): ClusterSet.list_routers: Could not connect to PRIMARY of Primary Cluster \'cluster-96066bb55c5fd2bff10a2a8507653dcf\'\n'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router4-0/charm/src/charm.py", line 470, in <module>
    ops.main.main(KubernetesRouterCharm)
  File "/var/lib/juju/agents/unit-router4-0/charm/venv/lib/python3.10/site-packages/ops/main.py", line 436, in main
    _emit_charm_event(charm, dispatcher.event_name)
  File "/var/lib/juju/agents/unit-router4-0/charm/venv/lib/python3.10/site-packages/ops/main.py", line 144, in _emit_charm_event
    event_to_emit.emit(*args, **kwargs)
  File "/var/lib/juju/agents/unit-router4-0/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 351, in emit
    framework._emit(event)
  File "/var/lib/juju/agents/unit-router4-0/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 853, in _emit
    self._reemit(event_path)
  File "/var/lib/juju/agents/unit-router4-0/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 942, in _reemit
    custom_handler(event)
  File "/var/lib/juju/agents/unit-router4-0/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router4-0/charm/venv/lib/python3.10/site-packages/common/abstract_charm.py", line 374, in reconcile
    self.set_status(event=event)
  File "/var/lib/juju/agents/unit-router4-0/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router4-0/charm/venv/lib/python3.10/site-packages/common/abstract_charm.py", line 261, in set_status
    self.unit.status = self._determine_unit_status(event=event)
  File "/var/lib/juju/agents/unit-router4-0/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router4-0/charm/venv/lib/python3.10/site-packages/common/abstract_charm.py", line 242, in _determine_unit_status
    if status := workload_.status:
  File "/var/lib/juju/agents/unit-router4-0/charm/venv/lib/python3.10/site-packages/common/workload.py", line 439, in status
    if not self.shell.is_router_in_cluster_set(self._router_id):
  File "/var/lib/juju/agents/unit-router4-0/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 288, in is_router_in_cluster_set
    self._run_code(
  File "/var/lib/juju/agents/unit-router4-0/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 74, in _run_code
    self._container.run_mysql_shell(
  File "/var/lib/juju/agents/unit-router4-0/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router4-0/charm/venv/lib/python3.10/site-packages/common/container.py", line 236, in run_mysql_shell
    return self._run_command(args, timeout=timeout, input=input)
  File "/var/lib/juju/agents/unit-router4-0/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router4-0/charm/src/rock.py", line 256, in _run_command
    raise common.container.CalledProcessError(
common.container.CalledProcessError: Command '['mysqlsh', '--passwords-from-stdin', '--uri', 'relation-46_bb5f9e0470b84e@mysql-primary.testing.svc.cluster.local.:3306', '--python', '--file', '/tmp/mysqlsh_script.py']' returned non-zero exit status 1.
unit-router4-2: 02:06:17 ERROR juju.worker.uniter.operation hook "tls-relation-changed" (via hook dispatching script: dispatch) failed: exit status 1
unit-router5-2: 02:06:17 ERROR juju.worker.uniter.operation hook "mysql-router-peers-relation-joined" (via hook dispatching script: dispatch) failed: exit status 1
unit-router3-1: 02:06:17 ERROR juju.worker.uniter.operation hook "cos-relation-changed" (via hook dispatching script: dispatch) failed: exit status 1
unit-router4-0: 02:06:17 ERROR juju.worker.uniter.operation hook "tls-relation-changed" (via hook dispatching script: dispatch) failed: exit status 1
unit-router2-1: 02:06:18 ERROR juju.worker.uniter.operation hook "cos-relation-changed" (via hook dispatching script: dispatch) failed: exit status 1
unit-router0-2: 02:06:35 ERROR unit.router0/2.juju-log refresh-v-three:5: common.mysql_shell:Failed to run MySQL Shell script:
import json
import mysqlsh
import traceback

try:
    # Disable wizards in this script, since it will be invoked without --no-wizard
    shell.options.set('useWizards', False)
    import json

    cluster_set = dba.get_cluster_set()
    routers = cluster_set.list_routers()
    # mysqlsh objects are weirdâ€”they quack (i.e. duck typing) like standard Python objects (e.g. list,
    # dict), but do not serialize to JSON correctly.
    # Cast to str & load from JSON str before serializing
    routers = json.loads(str(routers))
    with open("/tmp/mysqlsh_output.json", "w") as file:
        json.dump(routers, file)
except mysqlsh.DBError as exception:
    error = {
        "message": str(exception),
        "code": exception.code,
        "traceback_message": "".join(traceback.format_exception(exception)),
    }
else:
    error = None
with open("/tmp/mysqlsh_error.json", "w") as file:
    json.dump(error, file)

MySQL client error 1040
MySQL Shell traceback:
Traceback (most recent call last):
  File "<string>", line 10, in <module>
mysqlsh.DBError: MySQL Error (1040): Dba.get_cluster_set: Too many connections

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router0-2/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 99, in _run_code
    raise ShellDBError(**exception)
common.mysql_shell.ShellDBError: MySQL Error (1040): Dba.get_cluster_set: Too many connections
unit-router0-2: 02:06:35 ERROR unit.router0/2.juju-log refresh-v-three:5: root:Uncaught exception while in charm code:
Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-router0-2/charm/src/charm.py", line 470, in <module>
    ops.main.main(KubernetesRouterCharm)
  File "/var/lib/juju/agents/unit-router0-2/charm/venv/lib/python3.10/site-packages/ops/main.py", line 436, in main
    _emit_charm_event(charm, dispatcher.event_name)
  File "/var/lib/juju/agents/unit-router0-2/charm/venv/lib/python3.10/site-packages/ops/main.py", line 144, in _emit_charm_event
    event_to_emit.emit(*args, **kwargs)
  File "/var/lib/juju/agents/unit-router0-2/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 351, in emit
    framework._emit(event)
  File "/var/lib/juju/agents/unit-router0-2/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 853, in _emit
    self._reemit(event_path)
  File "/var/lib/juju/agents/unit-router0-2/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 942, in _reemit
    custom_handler(event)
  File "/var/lib/juju/agents/unit-router0-2/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-router0-2/charm/venv/lib/python3.10/site-packages/common/abstract_charm.py", line 360, in reconcile
    if not workload_.status:
  File "/var/lib/juju/agents/unit-router0-2/charm/venv/lib/python3.10/site-packages/common/workload.py", line 439, in status
    if not self.shell.is_router_in_cluster_set(self._router_id):
  File "/var/lib/juju/agents/unit-router0-2/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 288, in is_router_in_cluster_set
    self._run_code(
  File "/var/lib/juju/agents/unit-router0-2/charm/venv/lib/python3.10/site-packages/common/mysql_shell/__init__.py", line 99, in _run_code
    raise ShellDBError(**exception)
common.mysql_shell.ShellDBError: MySQL Error (1040): Dba.get_cluster_set: Too many connections
unit-router0-2: 02:06:36 ERROR juju.worker.uniter.operation hook "refresh-v-three-relation-joined" (via hook dispatching script: dispatch) failed: exit status 1
unit-router3-0: 02:09:50 ERROR juju.worker.dependency "log-sender" manifold worker returned unexpected error: sending log message: websocket: close 1005 (no status): websocket: close sent
unit-router2-2: 02:09:50 ERROR juju.worker.dependency "log-sender" manifold worker returned unexpected error: sending log message: websocket: close 1005 (no status): websocket: close sent
unit-router0-1: 02:09:51 ERROR juju.worker.dependency "log-sender" manifold worker returned unexpected error: sending log message: websocket: close 1005 (no status): websocket: close sent
unit-router2-0: 02:09:51 ERROR juju.worker.dependency "log-sender" manifold worker returned unexpected error: sending log message: websocket: close 1005 (no status): websocket: close sent
unit-router0-0: 02:09:51 ERROR juju.worker.dependency "log-sender" manifold worker returned unexpected error: sending log message: websocket: close 1005 (no status): websocket: close sent
unit-router1-0: 02:09:51 ERROR juju.worker.dependency "log-sender" manifold worker returned unexpected error: sending log message: websocket: close 1005 (no status): websocket: close sent
unit-router5-0: 02:09:51 ERROR juju.worker.dependency "log-sender" manifold worker returned unexpected error: sending log message: websocket: close 1005 (no status): websocket: close sent
unit-router3-1: 02:09:51 ERROR juju.worker.dependency "log-sender" manifold worker returned unexpected error: sending log message: websocket: close 1005 (no status): websocket: close sent
unit-router4-0: 02:09:52 ERROR juju.worker.dependency "log-sender" manifold worker returned unexpected error: sending log message: websocket: close 1005 (no status): websocket: close sent
unit-router6-0: 02:09:53 ERROR juju.worker.dependency "log-sender" manifold worker returned unexpected error: sending log message: websocket: close 1005 (no status): websocket: close sent
unit-router0-2: 02:09:53 ERROR juju.worker.dependency "log-sender" manifold worker returned unexpected error: sending log message: websocket: close 1005 (no status): websocket: close sent
unit-router6-1: 02:09:53 ERROR juju.worker.dependency "log-sender" manifold worker returned unexpected error: sending log message: websocket: close 1005 (no status): websocket: close sent
unit-router6-2: 02:09:53 ERROR juju.worker.dependency "log-sender" manifold worker returned unexpected error: sending log message: websocket: close 1005 (no status): websocket: close sent
unit-app6-0: 02:09:55 ERROR juju.worker.dependency "log-sender" manifold worker returned unexpected error: sending log message: websocket: close 1005 (no status): websocket: close sent
unit-mysql-2: 02:09:55 ERROR juju.worker.dependency "log-sender" manifold worker returned unexpected error: sending log message: websocket: close 1005 (no status): websocket: close sent
unit-router1-1: 02:09:57 ERROR juju.worker.dependency "log-sender" manifold worker returned unexpected error: sending log message: websocket: close 1005 (no status): websocket: close sent
unit-mysql-1: 02:09:58 ERROR juju.worker.dependency "log-sender" manifold worker returned unexpected error: sending log message: websocket: close 1005 (no status): websocket: close sent
unit-mysql-0: 02:09:59 ERROR juju.worker.dependency "log-sender" manifold worker returned unexpected error: sending log message: websocket: close 1005 (no status): websocket: close sent
unit-app1-0: 02:10:47 ERROR juju.worker.dependency "log-sender" manifold worker returned unexpected error: sending log message: websocket: close 1005 (no status): websocket: close sent
unit-router5-0: 02:11:15 ERROR juju.worker.dependency "log-sender" manifold worker returned unexpected error: sending log message: websocket: close 1005 (no status): websocket: close sent
unit-router1-0: 02:11:15 ERROR juju.worker.dependency "log-sender" manifold worker returned unexpected error: sending log message: websocket: close 1005 (no status): websocket: close sent
unit-router6-0: 02:11:15 ERROR juju.worker.dependency "log-sender" manifold worker returned unexpected error: sending log message: websocket: close 1005 (no status): websocket: close sent
unit-app2-0: 02:11:21 ERROR juju.worker.dependency "log-sender" manifold worker returned unexpected error: sending log message: websocket: close 1005 (no status): websocket: close sent

[32mINFO    [0m pytest_operator.plugin:plugin.py:862 Forgetting main...