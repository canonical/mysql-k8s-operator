[32mINFO    [0m integration.high_availability.conftest:conftest.py:29 Clearing continuous writes
[32mINFO    [0m integration.high_availability.conftest:conftest.py:31 Starting continuous writes
[32mINFO    [0m integration.high_availability.test_async_replication:test_async_replication.py:337 Stopping continuous writes after 5s
[32mINFO    [0m integration.high_availability.test_async_replication:test_async_replication.py:345 Remove async relation
[32mINFO    [0m integration.high_availability.test_async_replication:test_async_replication.py:351 waiting for units to be blocked
[32mINFO    [0m integration.high_availability.test_async_replication:test_async_replication.py:357 Waiting for the applications to settle
[32mINFO    [0m juju.model:model.py:2972 Waiting for model:
  db2/0 [executing] blocked: Standalone read-only unit.
  db2/1 [executing] blocked: Standalone read-only unit.
  db2/2 [executing] blocked: Standalone read-only unit.
[32mINFO    [0m juju.model:model.py:2972 Waiting for model:
  db1/0 [executing] maintenance: Removing replica cluster
  db1/1 [idle] active: 
  db1/2 [idle] active: 
[32mINFO    [0m juju.model:model.py:2972 Waiting for model:
  db1/0 [idle] active: Primary
  db1/1 [idle] active: 
  db1/2 [idle] active: 
[32mINFO    [0m juju.model:model.py:2972 Waiting for model:
  db2/0 [executing] blocked: Standalone read-only unit.
  db2/1 [executing] blocked: Standalone read-only unit.
  db2/2 [executing] blocked: Standalone read-only unit.
[32mINFO    [0m integration.high_availability.test_async_replication:test_async_replication.py:371 Re relating the two mysql clusters
[32mINFO    [0m integration.high_availability.test_async_replication:test_async_replication.py:374 Waiting for the applications to settle
[32mINFO    [0m integration.high_availability.test_async_replication:test_async_replication.py:383 Running create replication action
[32mINFO    [0m integration.high_availability.test_async_replication:test_async_replication.py:393 Waiting for the applications to settle
[32mINFO    [0m juju.model:model.py:2972 Waiting for model:
  db1/0 [executing] maintenance: Sharing credentials with replica cluster
  db1/1 [executing] active: 
  db1/2 [executing] active: 
[32mINFO    [0m juju.model:model.py:2972 Waiting for model:
  db2/0 [executing] blocked: Standalone read-only unit.
  db2/1 [executing] blocked: Wait until unit is initialized before running create-replication on offer side
  db2/2 [executing] blocked: Standalone read-only unit.
[32mINFO    [0m juju.model:model.py:2972 Waiting for model:
  db1/0 [idle] maintenance: Sharing credentials with replica cluster
  db1/1 [idle] active: 
  db1/2 [idle] active: 
[32mINFO    [0m juju.model:model.py:2972 Waiting for model:
  db2/0 [executing] active: 
  db2/1 [executing] waiting: Waiting other units join the cluster
  db2/2 [executing] active: 
[32mINFO    [0m juju.model:model.py:2972 Waiting for model:
  db1/0 [executing] maintenance: Adding replica cluster
  db1/1 [idle] active: 
  db1/2 [idle] active: 
[32mINFO    [0m juju.model:model.py:2972 Waiting for model:
  db2/0 [idle] active: 
  db2/1 [idle] waiting: Waiting for primary cluster
  db2/2 [idle] active: 
[32mINFO    [0m juju.model:model.py:2972 Waiting for model:
  db1/0 [idle] active: Primary
  db1/1 [idle] active: 
  db1/2 [idle] active: 
[32mINFO    [0m juju.model:model.py:2972 Waiting for model:
  db2/0 [executing] maintenance: joining the cluster
  db2/1 [idle] waiting: Waiting for recovery to complete on other units
  db2/2 [idle] active: 
[32mINFO    [0m juju.model:model.py:2972 Waiting for model:
  db2/0 [idle] active: 
  db2/1 [idle] active: Standby
  db2/2 [idle] active: 
[32mINFO    [0m integration.high_availability.test_async_replication:test_async_replication.py:419 Testing data replication
[32mINFO    [0m integration.high_availability.test_async_replication:test_async_replication.py:426 Stopping continuous writes and wait (5s) for replication
[32mINFO    [0m integration.high_availability.test_async_replication:test_async_replication.py:433 Querying max value on all units
[32mINFO    [0m integration.high_availability.conftest:conftest.py:36 Clearing continuous writes
[32mINFO    [0m integration.high_availability.test_async_replication:test_async_replication.py:67 Destroying second model
[32mINFO    [0m pytest_operator.plugin:plugin.py:790 Model status:

Model  Controller          Cloud/Region        Version  SLA          Timestamp
test   microk8s-localhost  microk8s/localhost  3.5.4    unsupported  01:47:08Z

App               Version                  Status  Scale  Charm             Channel      Rev  Address         Exposed  Message
db1               8.0.37-0ubuntu0.22.04.3  active      3  mysql-k8s                        0  10.152.183.49   no       
mysql-router-k8s  8.0.37-0ubuntu0.22.04.3  active      1  mysql-router-k8s  8.0/edge     167  10.152.183.44   no       
mysql-test-app    0.0.2                    active      1  mysql-test-app    latest/edge   63  10.152.183.231  no       

Unit                 Workload  Agent      Address      Ports  Message
db1/0*               active    executing  10.1.65.140         Primary
db1/1                active    executing  10.1.65.141         
db1/2                active    executing  10.1.65.142         
mysql-router-k8s/0*  active    idle       10.1.65.149         
mysql-test-app/0*    active    idle       10.1.65.150         

Offer  Application  Charm      Rev  Connected  Endpoint           Interface    Role
db1    db1          mysql-k8s  0    1/1        replication-offer  mysql_async  provider

[32mINFO    [0m pytest_operator.plugin:plugin.py:796 Juju error logs:

unit-db1-2: 01:31:43 ERROR unit.db1/2.juju-log database-peers:0: Uncaught exception while in charm code:
Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-db1-2/charm/src/mysql_k8s_helpers.py", line 622, in _run_mysqlsh_script
    stdout, _ = process.wait_output()
  File "/var/lib/juju/agents/unit-db1-2/charm/venv/ops/pebble.py", line 1771, in wait_output
    raise ExecError[AnyStr](self._command, exit_code, out_value, err_value)
ops.pebble.ExecError: non-zero exit code 1 executing ['/usr/bin/mysqlsh', '--no-wizard', '--python', '--verbose=0', '-f', '/tmp/script.py', ';', 'rm', '/tmp/script.py'], stdout='', stderr="Cannot set LC_ALL to locale en_US.UTF-8: No such file or directory\n\x1b[33mWARNING: \x1b[0mThe password option is deprecated and will be removed in a future release.\n\n\n\x1b[36mNOTE: \x1b[0mThe target instance 'db1-2.db1-endpoints.test.svc.cluster.local:3306' has not been pre-provisioned (GTID set is empty). The Shell is unable to decide whether incremental state recovery can correctly provision it.\nThe safest and most convenient way to provision a new instance is through automatic clone provisioning, which will completely overwrite the state of 'db1-2.db1-endpoints.test.svc.cluster.local:3306' with a physical snapshot from an existing cluster member. To use this method by default, set the 'recoveryMethod' option to 'clone'.\n\nThe incremental state recovery may be safely used if you are sure all updates ever executed in the cluster were done with GTIDs enabled, there are no purged transactions and the new instance contains the same GTID set as the cluster or a subset of it. To use this method by default, set the 'recoveryM" [truncated]

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-db1-2/charm/lib/charms/mysql/v0/mysql.py", line 1730, in add_instance_to_cluster
    self._run_mysqlsh_script("\n".join(connect_commands + add_instance_command))
  File "/var/lib/juju/agents/unit-db1-2/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 734, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-db1-2/charm/src/mysql_k8s_helpers.py", line 625, in _run_mysqlsh_script
    raise MySQLClientError
charms.mysql.v0.mysql.MySQLClientError

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-db1-2/charm/venv/websocket/_socket.py", line 118, in recv
    bytes_ = _recv()
  File "/var/lib/juju/agents/unit-db1-2/charm/venv/websocket/_socket.py", line 97, in _recv
    return sock.recv(bufsize)
TimeoutError: timed out

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-db1-2/charm/venv/ops/pebble.py", line 2890, in exec
    control_ws = self._connect_websocket(task_id, 'control')
  File "/var/lib/juju/agents/unit-db1-2/charm/venv/ops/pebble.py", line 2978, in _connect_websocket
    ws.connect(url, socket=sock)
  File "/var/lib/juju/agents/unit-db1-2/charm/venv/websocket/_core.py", line 261, in connect
    self.handshake_response = handshake(self.sock, url, *addrs, **options)
  File "/var/lib/juju/agents/unit-db1-2/charm/venv/websocket/_handshake.py", line 65, in handshake
    status, resp = _get_resp_headers(sock)
  File "/var/lib/juju/agents/unit-db1-2/charm/venv/websocket/_handshake.py", line 141, in _get_resp_headers
    status, resp_headers, status_message = read_headers(sock)
  File "/var/lib/juju/agents/unit-db1-2/charm/venv/websocket/_http.py", line 351, in read_headers
    line = recv_line(sock)
  File "/var/lib/juju/agents/unit-db1-2/charm/venv/websocket/_socket.py", line 140, in recv_line
    c = recv(sock, 1)
  File "/var/lib/juju/agents/unit-db1-2/charm/venv/websocket/_socket.py", line 120, in recv
    raise WebSocketTimeoutException("Connection timed out")
websocket._exceptions.WebSocketTimeoutException: Connection timed out

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-db1-2/charm/src/mysql_k8s_helpers.py", line 621, in _run_mysqlsh_script
    process = self.container.exec(cmd)
  File "/var/lib/juju/agents/unit-db1-2/charm/venv/ops/model.py", line 2872, in exec
    return self._pebble.exec(
  File "/var/lib/juju/agents/unit-db1-2/charm/venv/ops/pebble.py", line 2899, in exec
    raise ChangeError(change.err, change) from e
ops.pebble.ChangeError: cannot perform the following tasks:
- Execute command "/usr/bin/mysqlsh" (exec 37: timeout waiting for websocket connections: context deadline exceeded)
----- Logs from task 0 -----
2024-11-24T01:31:43Z ERROR exec 37: timeout waiting for websocket connections: context deadline exceeded
-----

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-db1-2/charm/./src/charm.py", line 926, in <module>
    main(MySQLOperatorCharm)
  File "/var/lib/juju/agents/unit-db1-2/charm/venv/ops/main.py", line 551, in main
    manager.run()
  File "/var/lib/juju/agents/unit-db1-2/charm/venv/ops/main.py", line 530, in run
    self._emit()
  File "/var/lib/juju/agents/unit-db1-2/charm/venv/ops/main.py", line 519, in _emit
    _emit_charm_event(self.charm, self.dispatcher.event_name)
  File "/var/lib/juju/agents/unit-db1-2/charm/venv/ops/main.py", line 147, in _emit_charm_event
    event_to_emit.emit(*args, **kwargs)
  File "/var/lib/juju/agents/unit-db1-2/charm/venv/ops/framework.py", line 348, in emit
    framework._emit(event)
  File "/var/lib/juju/agents/unit-db1-2/charm/venv/ops/framework.py", line 860, in _emit
    self._reemit(event_path)
  File "/var/lib/juju/agents/unit-db1-2/charm/venv/ops/framework.py", line 950, in _reemit
    custom_handler(event)
  File "/var/lib/juju/agents/unit-db1-2/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 734, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-db1-2/charm/./src/charm.py", line 886, in _on_peer_relation_changed
    self.join_unit_to_cluster()
  File "/var/lib/juju/agents/unit-db1-2/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 734, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-db1-2/charm/./src/charm.py", line 384, in join_unit_to_cluster
    self._mysql.add_instance_to_cluster(
  File "/var/lib/juju/agents/unit-db1-2/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 734, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-db1-2/charm/lib/charms/mysql/v0/mysql.py", line 1742, in add_instance_to_cluster
    self.add_instance_to_cluster(
  File "/var/lib/juju/agents/unit-db1-2/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 734, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-db1-2/charm/lib/charms/mysql/v0/mysql.py", line 1751, in add_instance_to_cluster
    self._release_lock(local_lock_instance, instance_unit_label, UNIT_ADD_LOCKNAME)
  File "/var/lib/juju/agents/unit-db1-2/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 734, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-db1-2/charm/lib/charms/mysql/v0/mysql.py", line 2167, in _release_lock
    affected_rows = self._run_mysqlsh_script("\n".join(release_lock_commands))
  File "/var/lib/juju/agents/unit-db1-2/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 734, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-db1-2/charm/src/mysql_k8s_helpers.py", line 627, in _run_mysqlsh_script
    raise MySQLClientError
charms.mysql.v0.mysql.MySQLClientError
unit-db1-2: 01:31:44 ERROR juju.worker.uniter.operation hook "database-peers-relation-changed" (via hook dispatching script: dispatch) failed: exit status 1
unit-mysql-test-app-0: 01:37:40 ERROR unit.mysql-test-app/0.juju-log Unable to query the database
Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-mysql-test-app-0/charm/venv/mysql/connector/connection_cext.py", line 611, in cmd_query
    self._cmysql.query(
_mysql_connector.MySQLInterfaceError: Table 'continuous_writes_database.data' doesn't exist

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-mysql-test-app-0/charm/./src/charm.py", line 229, in _stop_continuous_writes
    last_written_value = self._max_written_value()
  File "/var/lib/juju/agents/unit-mysql-test-app-0/charm/./src/charm.py", line 241, in _max_written_value
    cursor.execute(
  File "/var/lib/juju/agents/unit-mysql-test-app-0/charm/venv/mysql/connector/cursor_cext.py", line 330, in execute
    result = self._cnx.cmd_query(
  File "/var/lib/juju/agents/unit-mysql-test-app-0/charm/venv/mysql/connector/connection_cext.py", line 619, in cmd_query
    raise get_mysql_exception(
mysql.connector.errors.ProgrammingError: 1146 (42S02): Table 'continuous_writes_database.data' doesn't exist

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-mysql-test-app-0/charm/./src/charm.py", line 227, in _stop_continuous_writes
    for attempt in Retrying(stop=stop_after_delay(60), wait=wait_fixed(5)):
  File "/var/lib/juju/agents/unit-mysql-test-app-0/charm/venv/tenacity/__init__.py", line 384, in __iter__
    do = self.iter(retry_state=retry_state)
  File "/var/lib/juju/agents/unit-mysql-test-app-0/charm/venv/tenacity/__init__.py", line 363, in iter
    raise retry_exc from fut.exception()
tenacity.RetryError: RetryError[<Future at 0x7f622363e920 state=finished raised ProgrammingError>]
unit-db1-2: 01:39:30 ERROR unit.db1/2.juju-log Failed to get cluster status for lima
unit-db1-2: 01:39:30 ERROR unit.db1/2.juju-log Failed to get cluster endpoints
Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-db1-2/charm/src/mysql_k8s_helpers.py", line 792, in update_endpoints
    rw_endpoints, ro_endpoints, offline = self.get_cluster_endpoints(get_ips=False)
  File "/var/lib/juju/agents/unit-db1-2/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 734, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-db1-2/charm/lib/charms/mysql/v0/mysql.py", line 1954, in get_cluster_endpoints
    raise MySQLGetClusterEndpointsError("Failed to get endpoints from cluster status")
charms.mysql.v0.mysql.MySQLGetClusterEndpointsError: Failed to get endpoints from cluster status
unit-db1-1: 01:39:30 ERROR unit.db1/1.juju-log Failed to get cluster status for lima
unit-db1-1: 01:39:30 ERROR unit.db1/1.juju-log Failed to get cluster endpoints
Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-db1-1/charm/src/mysql_k8s_helpers.py", line 792, in update_endpoints
    rw_endpoints, ro_endpoints, offline = self.get_cluster_endpoints(get_ips=False)
  File "/var/lib/juju/agents/unit-db1-1/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 734, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-db1-1/charm/lib/charms/mysql/v0/mysql.py", line 1954, in get_cluster_endpoints
    raise MySQLGetClusterEndpointsError("Failed to get endpoints from cluster status")
charms.mysql.v0.mysql.MySQLGetClusterEndpointsError: Failed to get endpoints from cluster status

[32mINFO    [0m pytest_operator.plugin:plugin.py:862 Forgetting main...